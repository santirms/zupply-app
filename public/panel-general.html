<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel General - Zupply</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">

  <div class="max-w-7xl mx-auto p-6">

    <!-- üìä Contador Diario -->
    <div id="resumen-diario" class="bg-white p-4 rounded-lg shadow mb-6">
      <h2 class="text-xl font-semibold mb-2">Resumen del D√≠a</h2>
      <p><strong>Total de env√≠os del d√≠a:</strong> <span id="total-paquetes">...</span></p>
    </div>

    <h1 class="text-3xl font-bold mb-6 text-center">üì¶ Panel de Env√≠os</h1>

    <!-- üîç Filtros -->
    <div class="bg-white p-4 rounded-lg shadow mb-6">
  <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-7 gap-4">
    <!-- Cliente / c√≥digo interno / sender -->
    <input
      id="filtroCliente"
      type="text"
      placeholder="Cliente, c√≥digo o sender"
      class="border p-2 rounded w-full"
    />
    
        <input type="date" id="filtroDesde" class="border p-2 rounded w-full" />
        <input type="date" id="filtroHasta" class="border p-2 rounded w-full" />

        <select id="filtroPartido" class="border p-2 rounded w-full">
          <option value="">‚Äî Todos los partidos ‚Äî</option>
        </select>

        <select id="filtroEstado" class="border p-2 rounded w-full">
          <option value="">‚Äî Todos los estados ‚Äî</option>
          <option value="pendiente">Pendiente</option>
          <option value="asignado">Asignado</option>
          <option value="pending">Pendiente (ML)</option>
          <option value="shipped">En camino (ML)</option>
          <option value="delivered">Entregado (ML)</option>
        </select>

        <button onclick="aplicarFiltro()"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded shadow">
          üîç Filtrar
        </button>

        <button onclick="limpiarFiltros()"
                class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded border">
          Limpiar
        </button>
      </div>
    </div>

    <!-- üìã Tabla y Paginaci√≥n -->
    <div class="bg-white rounded-lg shadow overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200 text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2 text-left font-semibold">Tracking</th>
            <th class="px-4 py-2 text-left font-semibold">Cliente</th>
            <th class="px-4 py-2 text-left font-semibold">Fecha</th>
            <th class="px-4 py-2 text-left font-semibold">Zona/Partido</th>
            <th class="px-4 py-2 text-left font-semibold">Chofer</th>
            <th class="px-4 py-2 text-left font-semibold">Estado</th>
            <th class="px-4 py-2 text-left font-semibold">Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaEnvios" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>

    <div class="mt-4 flex justify-between items-center">
      <button id="prevBtn" onclick="cambiarPagina(-1)"
              class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Anterior</button>
      <span class="text-sm" id="infoPagina">P√°gina 1 de 1</span>
      <button id="nextBtn" onclick="cambiarPagina(1)"
              class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Siguiente</button>
    </div>
  </div>

  <!-- Modal Detalle -->
  <div id="modalDetalle"
       class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-11/12 md:w-2/3 lg:w-1/2 p-6 relative">
      <button onclick="cerrarModalDetalle()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">‚úï</button>
      <h2 class="text-2xl font-semibold mb-4">Detalle del Env√≠o</h2>
      <div id="contenidoDetalle" class="space-y-1"></div>
      <div id="mapa" class="h-64 mt-4 rounded bg-gray-100"></div>
    </div>
  </div>

  <!-- Modal Eliminar -->
  <div id="modalEliminar"
       class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-11/12 md:w-1/3 p-6 relative">
      <button onclick="cerrarModalEliminar()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">‚úï</button>
      <h2 class="text-xl font-semibold mb-2">Eliminar env√≠o</h2>
      <p class="text-sm text-gray-600">¬øSeguro que quer√©s eliminar este env√≠o? Esta acci√≥n no se puede deshacer.</p>
      <div class="mt-4 flex justify-end gap-2">
        <button onclick="cerrarModalEliminar()" class="px-4 py-2 rounded border">Cancelar</button>
        <button id="btnConfirmEliminar" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Eliminar</button>
      </div>
    </div>
  </div>

  <script>
    // Estado
    let enviosCargados = [];
    let enviosFiltrados = [];
    let currentPage = 1;
    const pageSize = 10;

    // Mapa (Leaflet)
    let mapaInstancia = null;

    function initMapa(lat, lng) {
      const cont = document.getElementById('mapa');

      // sin coords
      if (!lat || !lng) {
        cont.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">Sin coordenadas</div>';
        return;
      }

      // destruir si existe
      if (mapaInstancia) {
        mapaInstancia.remove();
        mapaInstancia = null;
      }

      mapaInstancia = L.map('mapa').setView([lat, lng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(mapaInstancia);
      L.marker([lat, lng]).addTo(mapaInstancia);

      // forzar recalcular tama√±o (modal ven√≠a oculto)
      setTimeout(() => mapaInstancia.invalidateSize(), 0);
    }

    // Resumen del d√≠a
    async function cargarResumenDiario() {
      try {
        const res = await fetch('/api/envios/del-dia');
        const data = await res.json();
        document.getElementById('total-paquetes').textContent = data.total ?? 0;
      } catch (e) {
        console.error('Error al cargar resumen diario:', e);
      }
    }

    // Partidos
    async function cargarPartidos() {
      try {
        const res = await fetch('/api/partidos');
        const lista = await res.json();
        const select = document.getElementById('filtroPartido');
        lista.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.nombre;
          opt.textContent = p.nombre;
          select.appendChild(opt);
        });
      } catch (e) {
        console.error('No se pudo cargar partidos:', e);
      }
    }

    // Filtros
async function aplicarFiltro() {
  const cli     = (document.getElementById('filtroCliente')?.value || '').trim().toLowerCase();
  const trackingTxt = (document.getElementById('filtroTracking')?.value || '').trim().toLowerCase();
  const desde   = (document.getElementById('filtroDesde')?.value   || '');
  const hasta   = (document.getElementById('filtroHasta')?.value   || '');
  const partido = (document.getElementById('filtroPartido')?.value || '');
  const estado  = (document.getElementById('filtroEstado')?.value  || '');

  try {
    if (!enviosCargados.length) {
      const res = await fetch('/api/envios');
      enviosCargados = await res.json();
    }

    enviosFiltrados = enviosCargados.filter(e => {
      // Cliente (nombre, sender_id o c√≥digo interno)
      const nom = e.cliente_id?.nombre?.toLowerCase() || '';
      const matchCli =
        !cli ||
        nom.includes(cli) ||
        (e.sender_id || '').toLowerCase().includes(cli) ||
        (e.cliente_id?.codigo_cliente || '').toLowerCase().includes(cli);

      // Tracking (meli_id o id_venta)
      const tid = (e.meli_id || e.id_venta || '').toString().toLowerCase();
      const matchTracking = !trackingTxt || tid.includes(trackingTxt);

      // Fechas
      const fechaISO   = e.fecha ? new Date(e.fecha).toISOString().split('T')[0] : '';
      const afterDesde = !desde || fechaISO >= desde;
      const beforeHasta= !hasta || fechaISO <= hasta;

      // Partido/Zona exacto desde el selector
      const zonaName = e.partido || e.zona || '';
      const matchPartido = !partido || zonaName === partido;

      // Estado
      const est = (e.estado || e.status || '').toLowerCase();
      const matchEstado = !estado || est === estado.toLowerCase();

      return matchCli && matchTracking && afterDesde && beforeHasta && matchPartido && matchEstado;
    });

    currentPage = 1;
    renderTabla();
    renderPaginacion();
  } catch (err) {
    console.error('Error aplicando filtro:', err);
  }
}

    function limpiarFiltros() {
      document.getElementById('filtroCliente').value = '';
      document.getElementById('filtroDesde').value = '';
      document.getElementById('filtroHasta').value = '';
      document.getElementById('filtroPartido').value = '';
      document.getElementById('filtroEstado').value = '';
      enviosFiltrados = enviosCargados.slice();
      currentPage = 1;
      renderTabla();
      renderPaginacion();
    }

    // Tabla
    function renderTabla() {
      const tbody = document.getElementById('tablaEnvios');
      tbody.innerHTML = '';
      const start = (currentPage - 1) * pageSize;
      const page = enviosFiltrados.slice(start, start + pageSize);

      page.forEach(e => {
        const fecha = e.fecha ? new Date(e.fecha).toLocaleString() : '-';

        // Etiqueta de estado
        const estadoKey = (e.estado || e.status || '').toLowerCase();
        const estadoLabel = {
          pendiente: 'Pendiente',
          asignado: 'Asignado',
          pending: 'Pendiente',
          shipped: 'En camino',
          delivered: 'Entregado'
        }[estadoKey] || '-';
        
        const partidoUI = (e.partido && e.partido.trim()) ? e.partido : '-';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td class="px-4 py-2">
         <button
          class="text-indigo-600 hover:underline"
          data-id="${e._id}"
          onclick="mostrarDetalle(this.dataset.id)"
          title="Ver detalle"
         >
         ${e.meli_id || e.id_venta || '(sin id)'}
        </button>
        </td>
        <td class="px-4 py-2">${e.cliente_id?.nombre || ('ID:' + (e.sender_id || '-'))}</td>
        <td class="px-4 py-2">${fecha}</td>
        <!-- üëá solo partido -->
        <td class="px-4 py-2">${partidoUI}</td>
        <td class="px-4 py-2">${e.chofer?.nombre || ''}</td>
        <td class="px-4 py-2">${estadoLabel}</td>
        <td class="px-4 py-2">
        <button class="text-red-600 hover:text-red-700" title="Eliminar"
            onclick="abrirModalEliminar('${e._id}')">üóë</button>
      </td>
      `;
        tbody.appendChild(tr);
      });
    }

    function renderPaginacion() {
      const totalPages = Math.max(1, Math.ceil(enviosFiltrados.length / pageSize));
      document.getElementById('infoPagina').textContent = `P√°gina ${currentPage} de ${totalPages}`;
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage === totalPages;
    }

    function cambiarPagina(dir) {
      const totalPages = Math.max(1, Math.ceil(enviosFiltrados.length / pageSize));
      currentPage = Math.min(totalPages, Math.max(1, currentPage + dir));
      renderTabla();
      renderPaginacion();
    }

    // Detalle
async function mostrarDetalle(envioId) {
  try {
    const res = await fetch(`/api/envios/${envioId}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const clienteNombre = data.cliente_id?.nombre || '‚Äî sin nombre ‚Äî';
    const partido  = data.partido?.trim?.() || '-';
    const zonaFact = data.zona?.trim?.()    || '-';
    const precioFmt = (typeof data.precio === 'number')
      ? `$ ${data.precio.toFixed(2)}`
      : '-';

    const cd = document.getElementById('contenidoDetalle');
    cd.innerHTML = `
      <p><strong>Cliente:</strong> ${clienteNombre}</p>
      <p><strong>Direcci√≥n:</strong> ${data.direccion || '-'}</p>
      <p><strong>Tracking:</strong> ${data.meli_id || data.id_venta || '-'}</p>
      <p><strong>Estado:</strong> ${data.estado || data.status || '-'}</p>
      <p><strong>CP:</strong> ${data.codigo_postal || '-'}</p>
      <p><strong>Partido:</strong> ${partido}</p>
      <p><strong>Zona (facturaci√≥n):</strong> ${zonaFact}</p>
      <p><strong>Referencia:</strong> ${data.referencia || '-'}</p>
      <p><strong>Precio:</strong> ${precioFmt}</p>
    `;

    // MAPA (si existe el contenedor y hay coords)
    const mapEl = document.getElementById('mapDetalle');
    if (mapEl) {
      if (Number.isFinite(data.latitud) && Number.isFinite(data.longitud)) {
        // si us√°s Leaflet u otra lib, asegurate de limpiar antes
        mapEl.innerHTML = '';
        if (typeof initMapa === 'function') {
          initMapa(data.latitud, data.longitud);
        }
      } else {
        mapEl.innerHTML =
          '<div class="w-full h-full flex items-center justify-center text-gray-500">Sin coordenadas</div>';
      }
    }

    const modal = document.getElementById('modalDetalle');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.classList.add('overflow-hidden');

  } catch (e) {
    console.error('Error mostrando detalle:', e);
    alert('No se pudo cargar el detalle del env√≠o.');
  }
}
    
    function cerrarModalDetalle() {
      const modal = document.getElementById('modalDetalle');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.classList.remove('overflow-hidden');
      if (mapaInstancia) {
        mapaInstancia.remove();
        mapaInstancia = null;
      }
    }

    // Eliminar
    let envioAEliminar = null;

    function abrirModalEliminar(id) {
      envioAEliminar = id;
      const modal = document.getElementById('modalEliminar');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.classList.add('overflow-hidden');
    }

    function cerrarModalEliminar() {
      envioAEliminar = null;
      const modal = document.getElementById('modalEliminar');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.classList.remove('overflow-hidden');
    }

    document.getElementById('btnConfirmEliminar').addEventListener('click', async () => {
      if (!envioAEliminar) return;
      try {
        const res = await fetch(`/api/envios/${envioAEliminar}`, { method: 'DELETE' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        // actualizar arrays en memoria
        enviosCargados = enviosCargados.filter(e => e._id !== envioAEliminar);
        enviosFiltrados = enviosFiltrados.filter(e => e._id !== envioAEliminar);
        cerrarModalEliminar();
        renderTabla();
        renderPaginacion();
      } catch (e) {
        console.error('Error eliminando env√≠o:', e);
        alert('No se pudo eliminar el env√≠o.');
      }
    });

    // UX: cerrar modales con click afuera y ESC
    document.getElementById('modalDetalle').addEventListener('click', (e) => {
      if (e.target.id === 'modalDetalle') cerrarModalDetalle();
    });
    document.getElementById('modalEliminar').addEventListener('click', (e) => {
      if (e.target.id === 'modalEliminar') cerrarModalEliminar();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        cerrarModalDetalle();
        cerrarModalEliminar();
      }
    });

    // Al cargar
    document.addEventListener('DOMContentLoaded', () => {
      cargarResumenDiario();
      cargarPartidos();
      aplicarFiltro();
    });
  </script>
</body>
</html>
