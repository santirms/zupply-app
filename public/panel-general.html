<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel General - Zupply</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">

  <div class="max-w-7xl mx-auto p-6">

    <!-- üìä Contador Diario -->
    <div id="resumen-diario" class="bg-white p-4 rounded-lg shadow mb-6">
      <h2 class="text-xl font-semibold mb-2">Resumen del D√≠a</h2>
      <p><strong>Total de env√≠os del d√≠a:</strong> <span id="total-paquetes">...</span></p>
    </div>

    <h1 class="text-3xl font-bold mb-6 text-center">üì¶ Panel de Env√≠os</h1>

    <!-- üîç Filtros -->
    <div class="bg-white p-4 rounded-lg shadow mb-6">
  <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-7 gap-4">
    <!-- Cliente / c√≥digo interno / sender -->
    <input
      id="filtroCliente"
      type="text"
      placeholder="Cliente, c√≥digo o sender"
      class="border p-2 rounded w-full"
    />
        <!-- Tracking (meli_id o id_venta) -->
    <input
      id="filtroTracking"
      type="text"
      placeholder="Buscar por tracking (ML o id_venta)"
      class="border p-2 rounded w-full"
    />
          <input type="date" id="filtroDesde" class="border p-2 rounded w-full" />
        <input type="date" id="filtroHasta" class="border p-2 rounded w-full" />
   
      <!-- Bot√≥n + panel de checks -->
<div class="relative">
  <button id="btnPartidos" type="button"
    class="border p-2 rounded w-full flex justify-between items-center">
    Partidos (m√∫ltiple)
    <span class="text-gray-400 text-xs" id="countPartidos"></span>
  </button>
  <div id="panelPartidos"
       class="absolute z-10 mt-1 bg-white border rounded shadow w-64 p-2 hidden max-h-64 overflow-auto"></div>
</div>

<select id="filtroEstado" class="border p-2 rounded w-full">
  <option value="">‚Äî Todos los estados ‚Äî</option>
  <option value="pendiente">Pendiente</option>
  <option value="asignado">Asignado</option>
  <option value="en_camino">En camino</option>
  <option value="demorado">Demorado</option>
  <option value="reprogramado">Reprogramado</option>
  <option value="no_entregado">No entregado</option>
  <option value="entregado">Entregado</option>
  <option value="cancelado">Cancelado</option>
</select>


        <button onclick="aplicarFiltro()"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded shadow">
          üîç Filtrar
        </button>

        <button onclick="limpiarFiltros()"
                class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded border">
          Limpiar
        </button>
      </div>
    </div>

    <!-- üìã Tabla y Paginaci√≥n -->
    <div class="bg-white rounded-lg shadow overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200 text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2 text-left font-semibold">Tracking</th>
            <th class="px-4 py-2 text-left font-semibold">Cliente</th>
            <th class="px-4 py-2 text-left font-semibold">Fecha</th>
            <th class="px-4 py-2 text-left font-semibold">Zona/Partido</th>
            <th class="px-4 py-2 text-left font-semibold">Chofer</th>
            <th class="px-4 py-2 text-left font-semibold">Estado</th>
            <th class="px-4 py-2 text-left font-semibold">Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaEnvios" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>

    <div class="mt-4 flex justify-between items-center">
      <button id="prevBtn" onclick="cambiarPagina(-1)"
              class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Anterior</button>
      <span class="text-sm" id="infoPagina">P√°gina 1 de 1</span>
      <button id="nextBtn" onclick="cambiarPagina(1)"
              class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Siguiente</button>
    </div>
  </div>

  <!-- Modal Detalle -->
  <div id="modalDetalle"
       class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-11/12 md:w-2/3 lg:w-1/2 p-6 relative">
      <button onclick="cerrarModalDetalle()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">‚úï</button>
      <h2 class="text-2xl font-semibold mb-4">Detalle del Env√≠o</h2>
      <div id="contenidoDetalle" class="space-y-1"></div>
      <div id="mapa" class="h-64 mt-4 rounded bg-gray-100"></div>
    </div>
  </div>

  <!-- Modal Eliminar -->
  <div id="modalEliminar"
       class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-11/12 md:w-1/3 p-6 relative">
      <button onclick="cerrarModalEliminar()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">‚úï</button>
      <h2 class="text-xl font-semibold mb-2">Eliminar env√≠o</h2>
      <p class="text-sm text-gray-600">¬øSeguro que quer√©s eliminar este env√≠o? Esta acci√≥n no se puede deshacer.</p>
      <div class="mt-4 flex justify-end gap-2">
        <button onclick="cerrarModalEliminar()" class="px-4 py-2 rounded border">Cancelar</button>
        <button id="btnConfirmEliminar" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Eliminar</button>
      </div>
    </div>
  </div>

<script>
  // =================== Estado ===================
  let enviosCargados = [];
  let enviosFiltrados = [];
  let currentPage = 1;
  const pageSize = 10;
  let mapaInstancia = null;

  // =================== Utils ===================
  const normalize = s =>
    (s || '')
      .toString()
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .trim();

  // Filtro multi-partidos (Set vac√≠o = TODOS)
  const seleccionPartidos = new Set();
  function updateCountPartidos() {
    const el = document.getElementById('countPartidos');
    if (el) el.textContent = !seleccionPartidos.size ? '(Todos)' : `(${seleccionPartidos.size})`;
  }

  // =================== Mapa ===================
  function initMapa(lat, lng) {
    const cont = document.getElementById('mapa');
    if (!cont) return;
    // limpiar
    cont.innerHTML = '';
    if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
      cont.innerHTML =
        '<div class="flex items-center justify-center h-full text-gray-500">Sin coordenadas</div>';
      return;
    }
    if (mapaInstancia) {
      mapaInstancia.remove();
      mapaInstancia = null;
    }
    mapaInstancia = L.map('mapa').setView([lat, lng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(mapaInstancia);
    L.marker([lat, lng]).addTo(mapaInstancia);
    setTimeout(() => mapaInstancia.invalidateSize(), 0);
  }

  // =================== Resumen ===================
  async function cargarResumenDiario() {
    try {
      const res = await fetch('/api/envios/del-dia', { cache: 'no-store' });
      const data = await res.json();
      document.getElementById('total-paquetes').textContent = data.total ?? 0;
    } catch (e) {
      console.error('Error al cargar resumen diario:', e);
    }
  }

function uiStatus(envio) {
  const raw = (envio.estado || envio.status || envio.estado_meli?.status || '').toLowerCase();
  const sub = (envio.estado_meli?.substatus || '').toLowerCase();

  const norm = ({
    // ML ‚Üí internos
    pending: 'pendiente',
    handling: 'pendiente',
    ready_to_ship: 'pendiente',
    shipped: 'en_camino',
    delivered: 'entregado',
    not_delivered: 'no_entregado',
    cancelled: 'cancelado'
  })[raw] || raw || 'pendiente';

  const label = ({
    // Etiquetas en espa√±ol (una sola lista)
    pendiente: 'Pendiente',
    asignado: 'Asignado',
    en_camino: 'En camino',
    demorado: 'Demorado',
    reprogramado: 'Reprogramado',
    no_entregado: 'No entregado',
    entregado: 'Entregado',
    cancelado: 'Cancelado'
  })[norm] || 'Pendiente';

  return { key: norm, label, substatus: sub.replace(/_/g,' ') };
}  
  // =================== Partidos (checklist + "Todos") ===================
  async function cargarPartidos() {
    try {
      const res = await fetch('/api/partidos', { cache: 'no-store' });
      const lista = await res.json();

      const panel = document.getElementById('panelPartidos');
      panel.innerHTML = '';

      // "Todos"
      const rowAll = document.createElement('label');
      rowAll.className = 'flex items-center gap-2 p-1 cursor-pointer font-medium';
      rowAll.innerHTML = `
        <input type="checkbox" id="chk_all_partidos" class="accent-indigo-600" checked>
        <span>Todos</span>
      `;
      panel.appendChild(rowAll);

      const hr = document.createElement('hr');
      hr.className = 'my-1';
      panel.appendChild(hr);

      // Individuales
      lista.forEach(p => {
        const nombre = p.nombre;
        const nombreNorm = normalize(nombre);
        const row = document.createElement('label');
        row.className = 'flex items-center gap-2 p-1 cursor-pointer';
        row.innerHTML = `
          <input type="checkbox"
                 data-nombre="${nombre}"
                 data-nombre-norm="${nombreNorm}"
                 class="accent-indigo-600">
          <span>${nombre}</span>
        `;
        panel.appendChild(row);
      });

      // Toggle panel
      const btn = document.getElementById('btnPartidos');
      btn.addEventListener('click', () => panel.classList.toggle('hidden'));
      document.addEventListener('click', (e) => {
        if (!panel.contains(e.target) && e.target !== btn) panel.classList.add('hidden');
      });

      // Manejo de checks
      panel.addEventListener('change', (e) => {
        const target = e.target;
        if (target.id === 'chk_all_partidos') {
          if (target.checked) {
            seleccionPartidos.clear();
            panel.querySelectorAll('input[type="checkbox"][data-nombre-norm]')
                 .forEach(cb => cb.checked = false);
          }
          updateCountPartidos();
          aplicarFiltro();
          return;
        }
        if (target.matches('input[type="checkbox"][data-nombre-norm]')) {
          const all = document.getElementById('chk_all_partidos');
          all.checked = false;
          const nomNorm = target.dataset.nombreNorm;
          if (target.checked) seleccionPartidos.add(nomNorm);
          else seleccionPartidos.delete(nomNorm);
          updateCountPartidos();
          aplicarFiltro();
        }
      });

      updateCountPartidos();
    } catch (e) {
      console.error('No se pudo cargar partidos:', e);
    }
  }

  // =================== Filtros ===================
  async function aplicarFiltro() {
    const cliRaw       = (document.getElementById('filtroCliente')?.value || '');
    const trackingRaw  = (document.getElementById('filtroTracking')?.value || '');
    const desde        = (document.getElementById('filtroDesde')?.value || '');
    const hasta        = (document.getElementById('filtroHasta')?.value || '');
    const estadoSel    = (document.getElementById('filtroEstado')?.value || '').toLowerCase();

    const cliSearch    = cliRaw.trim().toLowerCase();
    const trackingTxt  = trackingRaw.trim().toLowerCase().replace(/\s+/g,'');

    try {
      if (!enviosCargados.length) {
        const res = await fetch('/api/envios', { cache: 'no-store' });
        enviosCargados = await res.json();
      }

      // Devuelve un <span> con color seg√∫n el estado unificado
function estadoBadge(key, label) {
  const css = {
    entregado:     'bg-green-100  text-green-700  border-green-200',
    en_camino:     'bg-sky-100    text-sky-700    border-sky-200',
    pendiente:     'bg-gray-100   text-gray-700   border-gray-200',
    asignado:      'bg-indigo-100 text-indigo-700 border-indigo-200',
    demorado:      'bg-red-100    text-red-700    border-red-200',
    reprogramado:  'bg-blue-100   text-blue-700   border-blue-200',
    no_entregado:  'bg-amber-100  text-amber-700  border-amber-200',
    cancelado:     'bg-slate-200  text-slate-700  border-slate-300',
  }[key] || 'bg-gray-100 text-gray-700 border-gray-200';

  return `<span class="inline-flex items-center text-xs px-2 py-0.5 rounded-full border ${css}">${label}</span>`;
}

// Chip neutro para substatus ML (si viene)
function substatusChip(sub) {
  if (!sub) return '';
  return `<span class="ml-2 text-xs px-2 py-0.5 rounded-full bg-gray-100 border text-gray-600">${sub}</span>`;
}

      enviosFiltrados = enviosCargados.filter(e => {
  // Cliente / sender
  const nom    = e.cliente_id?.nombre?.toLowerCase() || '';
  const sender = (e.sender_id || '').toLowerCase();
  const matchCli = !cliSearch || nom.includes(cliSearch) || sender.includes(cliSearch);

  // Tracking (meli_id o id_venta)
  const meliStr  = (e.meli_id   ?? '').toString().toLowerCase();
  const ventaStr = (e.id_venta  ?? '').toString().toLowerCase();
  const matchTracking = !trackingTxt || meliStr.includes(trackingTxt) || ventaStr.includes(trackingTxt);

  // Fechas
  const fechaISO = e.fecha ? new Date(e.fecha).toISOString().split('T')[0] : '';
  const afterDesde  = !desde || fechaISO >= desde;
  const beforeHasta = !hasta || fechaISO <= hasta;

  // Partidos (multi)
  const zonaNameNorm = normalize(e.partido || e.zona || '');
  const matchPartido = !seleccionPartidos.size || seleccionPartidos.has(zonaNameNorm);

  // Estado (unificado)
  const { key: estadoUnificado } = uiStatus(e);
  const matchEstado = !estadoSel || estadoUnificado === estadoSel;

  return matchCli && matchTracking && afterDesde && beforeHasta && matchPartido && matchEstado;
});
      
      // Orden: nuevos primero
      enviosFiltrados.sort((a, b) => {
        const fa = a.fecha ? new Date(a.fecha).getTime() : 0;
        const fb = b.fecha ? new Date(b.fecha).getTime() : 0;
        return fb - fa;
      });

      currentPage = 1;
      renderTabla();
      renderPaginacion();
    } catch (err) {
      console.error('Error aplicando filtro:', err);
    }
  }

  function limpiarFiltros() {
    document.getElementById('filtroCliente').value = '';
    document.getElementById('filtroTracking').value = '';
    document.getElementById('filtroDesde').value = '';
    document.getElementById('filtroHasta').value = '';
    document.getElementById('filtroEstado').value = '';

    // Restaurar "Todos" en partidos
    seleccionPartidos.clear();
    const all = document.getElementById('chk_all_partidos');
    if (all) all.checked = true;
    document
      .querySelectorAll('#panelPartidos input[type="checkbox"][data-nombre-norm]')
      .forEach(cb => (cb.checked = false));
    updateCountPartidos();

    enviosFiltrados = enviosCargados.slice().sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    currentPage = 1;
    renderTabla();
    renderPaginacion();
  }

  // =================== Tabla / Paginaci√≥n ===================
  function renderTabla() {
    const tbody = document.getElementById('tablaEnvios');
    tbody.innerHTML = '';

    if (!enviosFiltrados.length) {
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td class="px-4 py-6 text-center text-gray-500" colspan="7">No hay env√≠os para los filtros seleccionados</td>`;
      tbody.appendChild(tr);
      return;
    }

    const start = (currentPage - 1) * pageSize;
    const page = enviosFiltrados.slice(start, start + pageSize);

    page.forEach(e => {
      const fecha = e.fecha ? new Date(e.fecha).toLocaleString() : '-';
      const estadoKey = (e.estado || e.status || e.estado_meli?.status || '').toLowerCase();
      
      const { label: estadoLabel, substatus } = uiStatus(e);
      const subChip = substatus
       ? `<span class="ml-2 text-xs px-2 py-0.5 rounded-full bg-gray-100 border text-gray-600">${substatus}</span>`
       : '';
      const partidoUI = (e.partido && e.partido.trim()) ? e.partido : (e.zona || '-');
      const zonaFact = (e.zona && e.zona.trim()) ? e.zona : '';  
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
    <td class="px-4 py-2">
    <button
      class="text-indigo-600 hover:underline"
      data-id="${e._id}"
      onclick="mostrarDetalle(this.dataset.id)"
      title="Ver detalle"
     >
     ${e.meli_id || e.id_venta || '(sin id)'}
     </button>
     ${e.meli_id ? `
      <button
        class="ml-2 text-xs border px-2 py-0.5 rounded hover:bg-gray-50"
        onclick="forceSyncMeli('${e.meli_id}')"
        title="Actualizar estado desde MeLi">‚Üª</button>
    ` : ''}
  </td>
  <td class="px-4 py-2">${e.cliente_id?.nombre || ('ID:' + (e.sender_id || '-'))}</td>
  <td class="px-4 py-2">${fecha}</td>
  <td class="px-4 py-2" title="${zonaFact}">${partidoUI}</td>
  <td class="px-4 py-2">${e.chofer?.nombre || ''}</td>
  <td class="px-4 py-2">${estadoLabel}${subChip}</td>
  <td class="px-4 py-2">
    <button class="text-red-600 hover:text-red-700" title="Eliminar"
            onclick="abrirModalEliminar('${e._id}')">üóë</button>
  </td>
`;
tbody.appendChild(tr);

    });
  }

  function renderPaginacion() {
    const totalPages = Math.max(1, Math.ceil(enviosFiltrados.length / pageSize));
    document.getElementById('infoPagina').textContent = `P√°gina ${currentPage} de ${totalPages}`;
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = currentPage === totalPages;
  }

  function cambiarPagina(dir) {
    const totalPages = Math.max(1, Math.ceil(enviosFiltrados.length / pageSize));
    currentPage = Math.min(totalPages, Math.max(1, currentPage + dir));
    renderTabla();
    renderPaginacion();
  }

  // =================== Detalle / Modales ===================
  async function mostrarDetalle(envioId) {
    try {
      const res = await fetch(`/api/envios/${envioId}`, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      const clienteNombre = data.cliente_id?.nombre || '‚Äî sin nombre ‚Äî';
      const partido  = data.partido?.trim?.() || '-';
      const zonaFact = data.zona?.trim?.()    || '-';
      const precioFmt = (typeof data.precio === 'number') ? `$ ${data.precio.toFixed(2)}` : '-';

      const cd = document.getElementById('contenidoDetalle');
      cd.innerHTML = `
        <p><strong>Cliente:</strong> ${clienteNombre}</p>
        <p><strong>Direcci√≥n:</strong> ${data.direccion || '-'}</p>
        <p><strong>Tracking:</strong> ${data.meli_id || data.id_venta || '-'}</p>
        <p><strong>Estado:</strong> ${data.estado || data.status || '-'}</p>
        <p><strong>CP:</strong> ${data.codigo_postal || '-'}</p>
        <p><strong>Partido:</strong> ${partido}</p>
        <p><strong>Zona (facturaci√≥n):</strong> ${zonaFact}</p>
        <p><strong>Referencia:</strong> ${data.referencia || '-'}</p>
        <p><strong>Precio:</strong> ${precioFmt}</p>
      `;

      const modal = document.getElementById('modalDetalle');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.classList.add('overflow-hidden');

      if (Number.isFinite(data.latitud) && Number.isFinite(data.longitud)) {
        initMapa(data.latitud, data.longitud);
      } else {
        initMapa(NaN, NaN);
      }
    } catch (e) {
      console.error('Error mostrando detalle:', e);
      alert('No se pudo cargar el detalle del env√≠o.');
    }
  }

  function cerrarModalDetalle() {
    const modal = document.getElementById('modalDetalle');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    document.body.classList.remove('overflow-hidden');
    if (mapaInstancia) {
      mapaInstancia.remove();
      mapaInstancia = null;
    }
  }

  let envioAEliminar = null;
  function abrirModalEliminar(id) {
    envioAEliminar = id;
    const modal = document.getElementById('modalEliminar');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.classList.add('overflow-hidden');
  }
  function cerrarModalEliminar() {
    envioAEliminar = null;
    const modal = document.getElementById('modalEliminar');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    document.body.classList.remove('overflow-hidden');
  }
  document.getElementById('btnConfirmEliminar').addEventListener('click', async () => {
    if (!envioAEliminar) return;
    try {
      const res = await fetch(`/api/envios/${envioAEliminar}`, { method: 'DELETE', cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      enviosCargados = enviosCargados.filter(e => e._id !== envioAEliminar);
      enviosFiltrados = enviosFiltrados.filter(e => e._id !== envioAEliminar);
      cerrarModalEliminar();
      renderTabla();
      renderPaginacion();
    } catch (e) {
      console.error('Error eliminando env√≠o:', e);
      alert('No se pudo eliminar el env√≠o.');
    }
  });

  // Exponer funciones para los onclick del HTML
  window.aplicarFiltro = aplicarFiltro;
  window.limpiarFiltros = limpiarFiltros;
  window.cambiarPagina = cambiarPagina;
  window.mostrarDetalle = mostrarDetalle;
  window.abrirModalEliminar = abrirModalEliminar;
  window.cerrarModalEliminar = cerrarModalEliminar;
  window.cerrarModalDetalle = cerrarModalDetalle;

  // =================== Inicio ===================
  document.addEventListener('DOMContentLoaded', () => {
    // Atajos ENTER
    ['filtroCliente','filtroTracking','filtroDesde','filtroHasta'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('keydown', e => { if (e.key === 'Enter') aplicarFiltro(); });
    });

    // Cerrar modales por click afuera / ESC
    document.getElementById('modalDetalle').addEventListener('click', (e) => {
      if (e.target.id === 'modalDetalle') cerrarModalDetalle();
    });
    document.getElementById('modalEliminar').addEventListener('click', (e) => {
      if (e.target.id === 'modalEliminar') cerrarModalEliminar();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { cerrarModalDetalle(); cerrarModalEliminar(); }
    });

    cargarResumenDiario();
    cargarPartidos().then(() => aplicarFiltro());
  });

  async function forceSyncMeli(meli_id) {
  try {
    const r = await fetch(`/api/auth/meli/force-sync/${meli_id}`, { method: 'POST' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    // refrescamos la lista en memoria
    enviosCargados = []; // forz√° recarga
    await aplicarFiltro();
  } catch (e) {
    console.error('force-sync error', e);
    alert('No se pudo sincronizar con MeLi.');
  }
}
window.forceSyncMeli = forceSyncMeli;

</script>

  
</body>
</html>
