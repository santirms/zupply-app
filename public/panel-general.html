<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Zupply | Panel General</title>

<!-- Tailwind en modo dark por clase -->
<script>window.tailwind=window.tailwind||{};window.tailwind.config={darkMode:"class"};</script>
<script src="https://cdn.tailwindcss.com"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Tema inicial: system por defecto -->
<script>
(function(){
  try{
    const saved=localStorage.getItem('zpl_theme'); // 'light'|'dark'|'system'
    const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;
    const wantDark=(saved==='dark')||((!saved||saved==='system')&&prefersDark);
    document.documentElement.classList.toggle('dark', wantDark);
    if(!saved) localStorage.setItem('zpl_theme','system');
  }catch{}
})();
</script>

<style>
  :root{
    --z-primary:#F59E0B;       /* √°mbar suave */
    --z-primary-dark:#D97706;  /* hover */
    --z-primary-fg:#111827;    /* texto sobre √°mbar */
  }

  /* Fix para dropdowns en dark mode */
  html.dark select,
  html.dark select option {
    background-color:#0B1020;
    color:#e5e7eb;
    border-color:rgba(255,255,255,0.1);
  }

  html.dark select option:hover,
  html.dark select option:focus,
  html.dark select option:checked {
    background-color:#1e293b;
    color:#fff;
  }

  /* Fondo del dropdown cuando est√° abierto */
  html.dark select:focus {
    background-color:#0B1020;
    outline-color:#F59E0B;
  }

  /* Inputs de fecha tambi√©n */
  html.dark input[type="date"] {
    background-color:#0B1020;
    color:#e5e7eb;
    border-color:rgba(255,255,255,0.1);
  }

  html.dark input[type="date"]::-webkit-calendar-picker-indicator {
    filter:invert(1) opacity(0.7);
  }

  /* Dropdown de Partidos en dark */
  #panelPartidos{ backdrop-filter:saturate(120%) blur(6px); }
</style>

<!-- Modal de Confirmaci√≥n de Entrega -->
<script src="/js/confirmar-entrega-modal.js"></script>
<!-- Modal de Intento Fallido con Evidencia -->
<script src="/js/registrar-intento-fallido-modal.js"></script>
</head>

<body class="bg-slate-50 text-slate-900 dark:bg-[#0A1324] dark:text-slate-100 font-sans min-h-screen">
<div class="max-w-7xl mx-auto p-4 md:p-6">

  <!-- TOPBAR (sticky/transl√∫cida) -->
  <header class="sticky top-0 z-40 mb-4">
    <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white/80 dark:bg-[#0B1020]/70 backdrop-blur px-4 py-3 flex items-center gap-3">
      <!-- Logo/Home -->
      <a href="#" id="logoLink" class="flex items-center gap-3" title="Inicio">
        <img src="/assets/icon-zupply.svg" alt="Z" class="h-8 w-8 sm:hidden">
        <img src="/assets/logo-zupply.svg" alt="Zupply" class="h-5 hidden sm:block" onerror="this.remove()">
      </a>

      <div class="ml-2 h-6 w-px bg-slate-300/70 dark:bg-white/10"></div>
      <span class="text-sm opacity-80">Panel general de env√≠os</span>

      <!-- Usuario + Tema -->
      <div class="ml-auto flex items-center gap-2">
        <div class="relative" id="userMenuWrap">
          <button id="userBtn"
            class="flex items-center gap-2 px-3 py-1.5 rounded-xl text-sm border border-slate-300 dark:border-white/10 bg-white hover:bg-slate-50 dark:bg-white/10 dark:hover:bg-white/15">
            <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-200/60 dark:bg-white/10">üë§</span>
            <span id="username" class="max-w-[160px] truncate">Usuario</span>
            <span class="opacity-70">‚ñæ</span>
          </button>
          <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-[#0B1020]/90 backdrop-blur p-1 shadow-lg">
            <a href="#" id="homeLink" class="block w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 dark:hover:bg-white/10 text-sm">üè† Inicio</a>
            <div id="menuDivider" class="my-1 h-px bg-slate-200 dark:bg-white/10"></div>
            <button id="logoutBtn" class="w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 dark:hover:bg-white/10 text-sm">‚éã Cerrar sesi√≥n</button>
          </div>
        </div>

        <button id="themeBtn"
          class="px-3 py-1.5 rounded-xl text-sm border border-slate-300 dark:border-white/10 bg-white hover:bg-slate-50 text-slate-700 dark:bg-white/10 dark:hover:bg-white/15 dark:text-slate-100">
          Tema: auto
        </button>
      </div>
    </div>
  </header>

  <!-- Mini-KPIs -->
  <section class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
    <div onclick="filtrarPorEstado('pendiente')" style="cursor: pointer;"
         class="rounded-2xl p-4 text-left border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 hover:shadow-lg transition-shadow">
      <div class="text-xs opacity-70">Pendientes</div>
      <div id="kpi-pend" class="text-3xl font-semibold mt-1 tracking-tight text-amber-600">‚Äî</div>
    </div>

    <div onclick="filtrarPorEstado('en_camino')" style="cursor: pointer;"
         class="rounded-2xl p-4 text-left border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 hover:shadow-lg transition-shadow">
      <div class="text-xs opacity-70">En ruta</div>
      <div id="kpi-ruta" class="text-3xl font-semibold mt-1 tracking-tight text-sky-600 dark:text-sky-300">‚Äî</div>
    </div>

    <div onclick="filtrarPorEstado('entregado')" style="cursor: pointer;"
         class="rounded-2xl p-4 text-left border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 hover:shadow-lg transition-shadow">
      <div class="text-xs opacity-70">Entregados</div>
      <div id="kpi-ent" class="text-3xl font-semibold mt-1 tracking-tight text-emerald-600 dark:text-emerald-300">‚Äî</div>
    </div>

    <div onclick="filtrarPorIncidencias()" style="cursor: pointer;"
         class="rounded-2xl p-4 text-left border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 hover:shadow-lg transition-shadow">
      <div class="text-xs opacity-70">Incidencias</div>
      <div id="kpi-inc" class="text-3xl font-semibold mt-1 tracking-tight text-rose-600 dark:text-rose-300">‚Äî</div>
    </div>
  </section>

  <h1 class="text-2xl font-bold mb-4 text-center">üì¶ Panel de Env√≠os</h1>

  <!-- Filtros -->
  <div class="rounded-2xl border border-slate-200 dark:border-white/15 bg-white dark:bg-white/5 p-4 mb-4">
    <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-8 gap-3">
      <input id="filtroCliente" type="text" placeholder="Cliente, c√≥digo o sender"
        class="w-full px-3 py-2 rounded-xl bg-white border border-slate-300
               dark:bg-white/10 dark:border-white/10" />

      <input id="filtroTracking" type="text" placeholder="Buscar por tracking (ML o id_venta)"
        class="w-full px-3 py-2 rounded-xl bg-white border border-slate-300
               dark:bg-white/10 dark:border-white/10" />

      <input id="filtroIdVenta" type="text" placeholder="Buscar por ID de venta"
        class="w-full px-3 py-2 rounded-xl bg-white border border-slate-300
               dark:bg-white/10 dark:border-white/10" />

      <input type="date" id="filtroDesde"
        class="w-full px-3 py-2 rounded-xl bg-white border border-slate-300
               dark:bg-white/10 dark:border-white/10" />

      <input type="date" id="filtroHasta"
        class="w-full px-3 py-2 rounded-xl bg-white border border-slate-300
               dark:bg-white/10 dark:border-white/10" />

      <!-- Partidos (dropdown) -->
      <div class="relative">
        <button id="btnPartidos" type="button"
          class="w-full px-3 py-2 rounded-xl bg-white border border-slate-300
                 dark:bg-white/10 dark:border-white/10 flex justify-between items-center">
          <span>Partidos (m√∫ltiple)</span>
          <span class="text-slate-400 text-xs" id="countPartidos"></span>
        </button>
        <div id="panelPartidos"
          class="absolute z-20 mt-1 w-64 p-2 max-h-64 overflow-auto rounded-2xl border
                 border-slate-200 dark:border-white/10 bg-white dark:bg-[#0B1020]/95 hidden shadow-lg">
          <!-- se llena por JS -->
        </div>
      </div>

      <select id="filtroEstado"
        class="w-full px-3 py-2 rounded-xl bg-white border border-slate-300 dark:bg-[#0B1020] dark:border-white/10 dark:text-slate-100">
        <option value="">‚Äî Todos los estados ‚Äî</option>
        <option value="pendiente">Pendiente</option>
        <option value="en_planta">En planta</option>
        <option value="asignado">Asignado</option>
        <option value="en_camino">En camino</option>

        <optgroup label="Problemas de entrega" class="dark:bg-[#1e293b]">
          <option value="comprador_ausente">Comprador ausente</option>
          <option value="inaccesible">Inaccesible/Aver√≠a</option>
          <option value="direccion_erronea">Direcci√≥n err√≥nea</option>
          <option value="demorado">Demorado</option>
          <option value="reprogramado">Reprogramado</option>
          <option value="no_entregado">No entregado</option>
        </optgroup>

        <option value="entregado">Entregado</option>
        <option value="cancelado">Cancelado</option>
      </select>

      <select id="filtroOrigen"
        class="w-full px-3 py-2 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-[#0B1020] dark:text-slate-100">
        <option value="">‚Äî Todos ‚Äî</option>
        <option value="mercadolibre"> MercadoLibre Flex</option>
        <option value="etiquetas"> Etiquetas PDF</option>
        <option value="ingreso_manual"> Ingreso Manual</option>
        <option value="tiendanube"> TiendaNube</option>
      </select>

      <select id="filtroChofer"
        class="w-full px-3 py-2 rounded-xl bg-white border border-slate-300 dark:bg-[#0B1020] dark:border-white/10 dark:text-slate-100">
        <option value="">‚Äî Todos los choferes ‚Äî</option>
      </select>

      <button onclick="aplicarFiltro()"
        class="px-4 py-2 rounded-xl font-medium shadow-sm bg-[var(--z-primary)] text-[var(--z-primary-fg)] hover:bg-[var(--z-primary-dark)]">
        üîç Filtrar
      </button>
      <button onclick="limpiarFiltros()"
        class="px-4 py-2 rounded-xl border border-slate-300 bg-white text-slate-700 hover:bg-slate-50
               dark:border-white/10 dark:bg-white/10 dark:text-slate-100 dark:hover:bg-white/15">
        Limpiar
      </button>
      <button onclick="abrirModalReportes()"
        class="px-4 py-2 rounded-xl font-semibold shadow-sm bg-[var(--z-primary)] hover:bg-[var(--z-primary-dark)] text-[var(--z-primary-fg)]">
        üìä Reportes
      </button>
    </div>

    <!-- B√∫squeda por direcci√≥n (l√≠nea completa) -->
    <div class="mt-3">
      <input id="filtroDireccion" type="text"
        placeholder="üîç Buscar por direcci√≥n (ej: san martin, rivadavia, etc)"
        class="w-full px-3 py-2 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-[#0B1020] dark:text-slate-100"
        onkeydown="if(event.key==='Enter') aplicarFiltro()">
    </div>
  </div>

  <!-- Tabla -->
  <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50 dark:bg-white/5">
        <tr>
          <th class="px-4 py-2 text-left font-semibold">Tracking</th>
          <th class="px-4 py-2 text-left font-semibold">ID de venta</th>
          <th class="px-4 py-2 text-left font-semibold">Cliente</th>
          <th class="px-4 py-2 text-left font-semibold">Fecha</th>
          <th class="px-4 py-2 text-left font-semibold">Partido</th>
          <th class="px-4 py-2 text-left font-semibold">Chofer</th>
          <th class="px-4 py-2 text-left font-semibold">Estado</th>
          <th class="px-4 py-2 text-left font-semibold">Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaEnvios" class="divide-y divide-slate-200/70 dark:divide-white/10"></tbody>
    </table>
  </div>

  <div class="mt-4 flex justify-between items-center">
    <span class="text-sm opacity-80" id="infoPagina"></span>
    <button id="btnMas" onclick="cargarMas()"
      class="px-4 py-2 rounded-xl border border-slate-300 bg-white text-slate-700 hover:bg-slate-50
             dark:border-white/10 dark:bg-white/10 dark:text-slate-100 dark:hover:bg-white/15">
      Cargar m√°s
    </button>
  </div>
</div>

<!-- Modal Detalle -->
<div id="modalDetalle" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-40">
  <div class="bg-white dark:bg-[#0B1020] rounded-2xl shadow-xl w-11/12 md:w-2/3 lg:w-1/2 p-6 relative border border-slate-200 dark:border-white/10">
    <button onclick="cerrarModalDetalle()" class="absolute top-4 right-4 text-slate-500 hover:text-slate-700 dark:hover:text-slate-200">‚úï</button>
    <h2 class="text-xl font-semibold mb-4">Seguimiento del env√≠o</h2>

    <!-- Tabs -->
    <div class="mb-4 border-b border-slate-200 dark:border-white/10">
      <nav class="flex gap-2" role="tablist">
        <button id="tabBtnDetalle"
          class="px-3 py-2 rounded-t border-b-2 border-amber-500/80 text-amber-600 dark:text-amber-400 font-medium"
          onclick="switchTab('detalle')">Detalle del env√≠o</button>
        <button id="tabBtnHist"
          class="px-3 py-2 rounded-t border-b-2 border-transparent text-slate-600 dark:text-slate-300 hover:text-slate-800 dark:hover:text-slate-100"
          onclick="switchTab('historial')">Historial</button>
        <button id="tabBtnEvidencias"
          class="px-3 py-2 rounded-t border-b-2 border-transparent text-slate-600 dark:text-slate-300 hover:text-slate-800 dark:hover:text-slate-100"
          onclick="switchTab('evidencias')">
          <span id="tabEvidenciasLabel">Evidencias</span>
        </button>
      </nav>
    </div>

    <!-- Detalle -->
    <div id="tabDetalle">
      <div id="contenidoDetalle" class="space-y-1 text-sm"></div>
      <div id="mapa" class="h-64 mt-4 rounded-xl bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10"></div>
    </div>

    <!-- Historial -->
    <div id="tabHistorial" class="hidden">
      <div id="contenidoHistorial" class="space-y-2">
        <div class="text-sm text-slate-500">Cargando historial‚Ä¶</div>
      </div>
    </div>

    <!-- Evidencias -->
    <div id="tabEvidencias" class="hidden">
      <div id="contenidoEvidencias" class="p-6">
        <div class="text-sm text-slate-500">Cargando evidencias‚Ä¶</div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Eliminar -->
<div id="modalEliminar" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white dark:bg-[#0B1020] rounded-2xl shadow-xl w-11/12 md:w-1/3 p-6 relative border border-slate-200 dark:border-white/10">
    <button onclick="cerrarModalEliminar()" class="absolute top-4 right-4 text-slate-500 hover:text-slate-700 dark:hover:text-slate-200">‚úï</button>
    <h2 class="text-lg font-semibold mb-2">Eliminar env√≠o</h2>
    <p class="text-sm opacity-80">¬øSeguro que quer√©s eliminar este env√≠o? Esta acci√≥n no se puede deshacer.</p>
    <div class="mt-4 flex justify-end gap-2">
      <button onclick="cerrarModalEliminar()" class="px-4 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50
             dark:border-white/10 dark:bg-white/10">Cancelar</button>
      <button id="btnConfirmEliminar" class="px-4 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700">Eliminar</button>
    </div>
  </div>
</div>

<!-- Modal Notas -->
<div id="modalNotas" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white dark:bg-[#0B1020] w-11/12 md:w-[640px] rounded-2xl shadow-xl border border-slate-200 dark:border-white/10">
    <div class="flex items-center justify-between px-5 py-3 border-b border-slate-200 dark:border-white/10">
      <h3 class="text-lg font-semibold">Notas del env√≠o</h3>
      <button class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-200" onclick="cerrarModalNotas()">‚úï</button>
    </div>

    <div class="p-5 space-y-4">
      <div id="listaNotas" class="space-y-3 max-h-72 overflow-auto">
        <div class="text-sm text-slate-500">Cargando notas‚Ä¶</div>
      </div>

      <div>
        <label for="notaTexto" class="block text-sm font-medium mb-1">Agregar nota</label>
        <textarea id="notaTexto" rows="3"
          class="w-full border rounded-xl px-3 py-2 text-sm bg-white border-slate-300
                 dark:bg-white/10 dark:border-white/10"
          placeholder="Describe la incidencia, reprogramado por cliente, etc."></textarea>
      </div>
    </div>

    <div class="flex justify-end gap-2 px-5 py-3 border-t border-slate-200 dark:border-white/10">
      <button class="px-4 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50
             dark:border-white/10 dark:bg-white/10" onclick="cerrarModalNotas()">Cancelar</button>
      <button id="btnGuardarNota" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Guardar nota</button>
    </div>
  </div>
</div>

<!-- Mini-modal QR -->
<div id="qrViewModal" class="fixed inset-0 hidden bg-black/60 z-50 grid place-items-center p-4">
  <div class="bg-white dark:bg-[#0B1020] p-4 rounded-2xl w-full max-w-sm border border-slate-200 dark:border-white/10">
    <div class="flex items-center justify-between mb-2">
      <h3 class="font-semibold">QR de respaldo</h3>
      <button id="qrViewClose" class="px-2 py-1 border rounded text-sm border-slate-300 dark:border-white/10">Cerrar</button>
    </div>
    <img id="qrViewImg" alt="QR" class="w-full h-auto rounded border border-slate-200 dark:border-white/10" />
    <p id="qrViewHint" class="text-xs text-slate-500 mt-2">Disponible 7 d√≠as desde el √∫ltimo escaneo.</p>
  </div>
</div>

<!-- Modal Visualizador de Evidencias -->
<div id="modalFotoEvidencia" class="fixed inset-0 hidden bg-black/95 z-[10001] items-center justify-center p-5" onclick="cerrarModalFotoEvidencia()">
  <div style="width: 100%; max-width: 1000px; display: flex; flex-direction: column; align-items: center;">
    <!-- Header -->
    <div style="width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <div>
        <h4 id="modalFotoTitulo" style="color: white; margin: 0; font-weight: 600; font-size: 1.25rem;"></h4>
        <small id="modalFotoSubtitulo" style="color: #adb5bd; font-size: 0.875rem;"></small>
      </div>
      <button onclick="cerrarModalFotoEvidencia()" class="px-3 py-3 bg-white text-slate-900 rounded-full hover:bg-slate-100" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; font-size: 1.25rem;">‚úï</button>
    </div>

    <!-- Imagen -->
    <div style="max-width: 95%; max-height: 80vh; background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);" onclick="event.stopPropagation()">
      <div id="modalFotoLoading" style="padding: 80px; text-align: center;">
        <div class="spinner-border" role="status" style="width: 3rem; height: 3rem; border-width: 0.25rem;"></div>
        <div style="margin-top: 16px; color: #6c757d;">Cargando imagen...</div>
      </div>
      <img id="modalFotoImg" alt="Evidencia" style="max-width: 100%; max-height: 75vh; object-fit: contain; display: none; margin: 0 auto;" />
    </div>

    <!-- Footer -->
    <div id="modalFotoFooter" style="margin-top: 16px; padding: 12px 20px; background-color: rgba(40, 167, 69, 0.2); border: 1px solid rgba(40, 167, 69, 0.4); border-radius: 6px; color: #d4edda; font-size: 0.9em; text-align: center; display: none;">
      Comprobante con validez legal de entrega
    </div>
  </div>
</div>

<!-- Modal Reportes -->
<div id="modal-reportes" class="fixed inset-0 hidden z-50 bg-black/50 items-center justify-center">
  <div class="bg-white dark:bg-[#0B1020] rounded-2xl border border-slate-200 dark:border-white/10 w-full max-w-2xl mx-4 p-6 max-h-[90vh] overflow-y-auto">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-bold">Generar Reporte</h3>
      <button onclick="cerrarModalReportes()"
        class="px-3 py-1.5 rounded-xl border border-slate-300 dark:border-white/10 hover:bg-slate-50 dark:hover:bg-white/10">
        ‚úï
      </button>
    </div>

    <!-- Presets r√°pidos -->
    <div class="mb-6">
      <p class="text-sm font-medium mb-3">Presets r√°pidos:</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <button onclick="generarReportePreset('incidencias')"
          class="px-4 py-3 rounded-xl border border-slate-300 dark:border-white/10 hover:bg-red-50 dark:hover:bg-red-900/20 text-left">
          <div class="font-semibold">üî¥ Incidencias</div>
          <div class="text-xs opacity-70 mt-1">Ausente, inaccesible, demorado</div>
        </button>

        <button onclick="generarReportePreset('pendientes')"
          class="px-4 py-3 rounded-xl border border-slate-300 dark:border-white/10 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 text-left">
          <div class="font-semibold">üì¶ Pendientes 3+ d√≠as</div>
          <div class="text-xs opacity-70 mt-1">Sin asignar hace tiempo</div>
        </button>

        <button onclick="generarReportePreset('en_planta')"
          class="px-4 py-3 rounded-xl border border-slate-300 dark:border-white/10 hover:bg-blue-50 dark:hover:bg-blue-900/20 text-left">
          <div class="font-semibold">üè≠ En planta estancados</div>
          <div class="text-xs opacity-70 mt-1">3+ d√≠as sin despachar</div>
        </button>
      </div>
    </div>

    <div class="border-t border-slate-200 dark:border-white/10 my-6"></div>

    <!-- Personalizaci√≥n -->
    <div class="space-y-4">
      <p class="text-sm font-medium">O personalizar:</p>

      <!-- Cliente(s) -->
      <div>
        <label class="block text-sm font-medium mb-1">Cliente(s)</label>
        <select id="reporteClientes" multiple
          class="w-full p-2 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-transparent dark:[color-scheme:dark]">
          <option value="">Todos</option>
        </select>
        <p class="text-xs opacity-70 mt-1">Ctrl/Cmd + click para selecci√≥n m√∫ltiple</p>
      </div>

      <!-- Estados -->
      <div>
        <label class="block text-sm font-medium mb-1">Estados</label>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
          <label class="flex items-center gap-2">
            <input type="checkbox" name="reporte-estado" value="comprador_ausente" class="rounded">
            <span>Comprador ausente</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" name="reporte-estado" value="inaccesible" class="rounded">
            <span>Inaccesible</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" name="reporte-estado" value="demorado" class="rounded">
            <span>Demorado</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" name="reporte-estado" value="pendiente" class="rounded">
            <span>Pendiente</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" name="reporte-estado" value="en_planta" class="rounded">
            <span>En planta</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" name="reporte-estado" value="reprogramado" class="rounded">
            <span>Reprogramado</span>
          </label>
        </div>
      </div>

      <!-- Fechas -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Desde</label>
          <input type="date" id="reporteDesde"
            class="w-full p-2 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Hasta</label>
          <input type="date" id="reporteHasta"
            class="w-full p-2 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-transparent">
        </div>
      </div>

      <!-- Opciones adicionales -->
      <div>
        <label class="block text-sm font-medium mb-2">Incluir en el reporte:</label>
        <div class="space-y-2 text-sm">
          <label class="flex items-center gap-2">
            <input type="checkbox" id="incluirHistorial" checked class="rounded">
            <span>Historial de estados</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" id="incluirIntentos" checked class="rounded">
            <span>Intentos fallidos</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" id="incluirCoordenadas" class="rounded">
            <span>Coordenadas GPS</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Botones de acci√≥n -->
    <div class="flex flex-wrap gap-3 mt-6">
      <button onclick="generarReportePersonalizado('preview')"
        class="flex-1 px-4 py-2 rounded-xl border border-slate-300 dark:border-white/10 hover:bg-slate-50 dark:hover:bg-white/10 font-medium">
        üìä Vista previa
      </button>
      <button onclick="generarReportePersonalizado('xls')"
        class="flex-1 px-4 py-2 rounded-xl bg-green-500 hover:bg-green-600 text-white font-medium">
        ‚¨áÔ∏è Descargar XLS
      </button>
      <button onclick="generarReportePersonalizado('pdf')"
        class="flex-1 px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-white font-medium">
        üìÑ Descargar PDF
      </button>
    </div>

  </div>
</div>

<script>
/* ======== Header: usuario + tema ======== */
document.getElementById('anio')?.remove(); // no se usa ac√°
(function userMenu(){
  const btn  = document.getElementById('userBtn');
  const menu = document.getElementById('userMenu');
  const wrap = document.getElementById('userMenuWrap');
  btn.addEventListener('click', ()=> menu.classList.toggle('hidden'));
  document.addEventListener('click', (e)=>{ if (!wrap.contains(e.target)) menu.classList.add('hidden'); });

  document.getElementById('logoutBtn').addEventListener('click', async ()=>{
    try { await fetch('/auth/logout', { method:'POST' }); } catch {}
    try { localStorage.removeItem('zpl_auth'); localStorage.removeItem('zpl_username'); } catch {}
    location.href = '/auth/login';
  });

  // Funci√≥n para obtener la ruta de inicio seg√∫n el rol
  function getHomeRoute(role) {
    switch(role) {
      case 'cliente':
        return '/client-panel.html';
      case 'admin':
      case 'coordinador':
        return '/index.html';
      case 'chofer':
        return '/mis-envios.html';
      default:
        return '/';
    }
  }

  fetch('/me', { cache:'no-store' })
    .then(r => { if (!r.ok) throw new Error('unauth'); return r.json(); })
    .then(me => {
      const name = me.name || me.username || me.email || 'Usuario';
      document.getElementById('username').textContent = name;
      try { localStorage.setItem('zpl_username', name); } catch {}

      // Configurar redirecci√≥n del logo seg√∫n rol
      const userRole = me.role || 'admin';
      const homeRoute = getHomeRoute(userRole);

      const logoLink = document.getElementById('logoLink');
      const homeLink = document.getElementById('homeLink');

      // Actualizar href del logo y link de inicio
      if (logoLink) {
        logoLink.href = homeRoute;
      }
      if (homeLink) {
        homeLink.href = homeRoute;
      }
    })
    .catch(()=> location.href='/auth/login');
})();
(function themeToggle(){
  const order = ['light','dark','system'];
  const btn = document.getElementById('themeBtn');
  const apply = (mode) => {
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const wantDark = mode === 'dark' || (mode === 'system' && prefersDark);
    document.documentElement.classList.toggle('dark', wantDark);
    localStorage.setItem('zpl_theme', mode);
    btn.textContent = 'Tema: ' + (mode === 'system' ? 'auto' : mode);
  };
  apply(localStorage.getItem('zpl_theme') || 'system');
  btn.addEventListener('click', ()=> {
    const current = localStorage.getItem('zpl_theme') || 'system';
    const next = order[(order.indexOf(current)+1)%order.length];
    apply(next);
  });
})();
</script>

<!-- ==================== TU SCRIPT ORIGINAL (LOGICA) ==================== -->
<script>
window.USER_ROLE = window.USER_ROLE || 'admin';
/* === (aqu√≠ va exactamente el mismo JS que me pasaste; no toqu√© endpoints) ===
   He respetado todas las funciones: cargarResumenDiario, cargarPartidos, aplicarFiltro,
   limpiarFiltros, renderTabla, mostrarDetalle, notas, QR, etc.  */

<!-- PEGADO √çNTEGRO DE TU SCRIPT: -->
// =================== Estado ===================
let enviosCargados = []; let nextCursor = null; let filtrosActivos = {}; let mapaInstancia = null;
const normalize = s => (s || '').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
const cleanZona = z => (z || '').replace(/\s+(N|S|E|O|NE|NO|SE|SO)$/i, '').trim();
const nombreClienteEnvio = (envio = {}) => {
  const cliente = envio.cliente_id || {};
  const pick = (value) => (typeof value === 'string' ? value.trim() : '');

  const senderCliente = Array.isArray(cliente.sender_id)
    ? pick(cliente.sender_id[0])
    : pick(cliente.sender_id);

  return (
    pick(cliente.nombre) ||
    pick(cliente.razon_social) ||
    pick(cliente.codigo_cliente) ||
    senderCliente ||
    pick(envio.sender_id) ||
    '‚Äî'
  );
};
window.nombreClienteEnvio = nombreClienteEnvio;

function buildQueryParams({ tracking, id_venta, cliente, direccion, desde, hasta, estado, origen, partidos, chofer, cursor, incidencias, limit=100 }) {
  const p = new URLSearchParams();
  if (tracking) p.set('tracking', tracking);
  if (id_venta) p.set('id_venta', id_venta);
  if (cliente)  p.set('cliente', cliente);
  if (direccion) p.set('direccion', direccion);
  if (!tracking) { if (desde) p.set('desde', desde); if (hasta) p.set('hasta', hasta); }
  if (estado) p.set('estado', estado);
  if (origen) p.set('origen', origen);
  if (chofer) p.set('chofer', chofer);
  if (incidencias) p.set('incidencias', incidencias);
  if (Array.isArray(partidos) && partidos.length) p.set('partidos', partidos.join(','));
  if (cursor && !tracking) p.set('cursor', cursor);
  p.set('limit', String(limit)); p.set('ts', String(Date.now()));
  return p;
}

async function cargarPrimerPagina() {
  try {
    filtrosActivos = { limit: 100 };

    // Leer filtros desde URL si existen
    const urlParams = new URLSearchParams(window.location.search);
    const filtroEstado = urlParams.get('estado');
    const filtroIncidencias = urlParams.get('incidencias');

    if (filtroEstado) {
      filtrosActivos.estado = filtroEstado;
    }

    if (filtroIncidencias === 'true' || window._filtroIncidencias) {
      filtrosActivos.incidencias = 'true';
    }

    const q = buildQueryParams(filtrosActivos);
    const res = await fetch(`/api/envios?${q.toString()}`, { cache: 'no-store' });
    const data = await res.json();
    enviosCargados = data.rows || data || [];
    nextCursor = data.nextCursor || null;
    renderTabla(); renderPaginacionLikeCursor();
  } catch (e) { console.error('cargarPrimerPagina error', e); }
}

async function cargarMas() {
  try {
    if (!nextCursor) return;
    const q = buildQueryParams({ ...filtrosActivos, cursor: nextCursor });
    const res = await fetch(`/api/envios?${q.toString()}`, { cache: 'no-store' });
    const data = await res.json();
    const nuevos = data.rows || data || [];
    const seen = new Set(enviosCargados.map(e => e._id));
    const unique = nuevos.filter(e => !seen.has(e._id));
    enviosCargados = enviosCargados.concat(unique);
    nextCursor = data.nextCursor || null;
    renderTabla(); renderPaginacionLikeCursor();
  } catch (e) { console.error('cargarMas error', e); }
}

const seleccionPartidos = new Set();
function updateCountPartidos(){ const el = document.getElementById('countPartidos'); if (el) el.textContent = !seleccionPartidos.size ? '(Todos)' : `(${seleccionPartidos.size})`; }
function hasNotesFlag(e){ return (e.notas_count>0) || (Array.isArray(e.notas)&&e.notas.length>0) || !!e.has_notes; }
function hasQr(envio){ const vu = envio?.qr_meta?.valid_until || envio?.qr_valid_until || envio?.qrValidUntil; if (vu) return new Date(vu) > new Date(); return !!(envio?.qr_meta?.last_hash || envio?.qr_last_hash || envio?.has_qr); }
function qrIconButtonHtml(envioId){ return `<button class="ml-2 inline-flex items-center gap-1 text-emerald-700 bg-emerald-100 border border-emerald-200 rounded px-1.5 py-0.5 text-[11px]" title="QR de respaldo disponible ‚Äî abrir" onclick="cargarQrRespaldo('${envioId}')"><svg viewBox="0 0 24 24" class="w-3.5 h-3.5" fill="currentColor"><rect x="3" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="3" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect><path d="M14 14h3v3h-3zM18 14h3v3h-3zM18 18h3v3h-3zM14 18h3v3h-3z"></path></svg></button>`; }
async function probeQrButtons(){ const slots = Array.from(document.querySelectorAll('[data-qr-probe]')); await Promise.all(slots.map(async slot => { const id = slot.getAttribute('data-qr-probe'); try { const r = await fetch(`/api/scan-meli/latest-render/${id}`, { cache: 'no-store' }); const j = await r.json().catch(()=>null); if (r.ok && j && j.ok && j.url) { slot.outerHTML = qrIconButtonHtml(id); } else { slot.remove(); } } catch { slot.remove(); } })); }

function initMapa(lat,lng){ const cont=document.getElementById('mapa'); if(!cont) return; cont.innerHTML=''; if(!Number.isFinite(lat)||!Number.isFinite(lng)){ cont.innerHTML='<div class="flex items-center justify-center h-full text-slate-500">Sin coordenadas</div>'; return; } if(mapaInstancia){ mapaInstancia.remove(); mapaInstancia=null; } mapaInstancia=L.map('mapa').setView([lat,lng],13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' }).addTo(mapaInstancia); L.marker([lat,lng]).addTo(mapaInstancia); setTimeout(()=>mapaInstancia.invalidateSize(),0); }

function estadoBadge(key,label){
  const BADGE_CLASSES = {
    // Estados manuales
    en_planta: 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800',
    comprador_ausente: 'bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-900/30 dark:text-orange-300 dark:border-orange-800',
    rechazado: 'bg-rose-100 text-rose-700 border-rose-200 dark:bg-rose-900/30 dark:text-rose-300 dark:border-rose-800',

    // Estados comunes
    pendiente: 'bg-gray-100 text-gray-700 border-gray-200 dark:bg-gray-900/30 dark:text-gray-300 dark:border-gray-800',
    en_camino: 'bg-cyan-100 text-cyan-700 border-cyan-200 dark:bg-cyan-900/30 dark:text-cyan-300 dark:border-cyan-800',
    asignado: 'bg-indigo-100 text-indigo-700 border-indigo-200 dark:bg-indigo-900/30 dark:text-indigo-300 dark:border-indigo-800',
    entregado: 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-300 dark:border-green-800',
    no_entregado: 'bg-amber-100 text-amber-700 border-amber-200 dark:bg-amber-900/30 dark:text-amber-300 dark:border-amber-800',

    // Estados de demora/problema
    demorado: 'bg-red-100 text-red-800 border-red-300 dark:bg-red-900/40 dark:text-red-200 dark:border-red-700 font-semibold',  // ‚Üê Cambiar esta l√≠nea
    no_visitado: 'bg-red-100 text-red-800 border-red-300 dark:bg-red-900/40 dark:text-red-200 dark:border-red-700 font-semibold',
    reprogramado_comprador: 'bg-purple-100 text-purple-700 border-purple-200 dark:bg-purple-900/30 dark:text-purple-300 dark:border-purple-800',
    rechazado_comprador: 'bg-orange-100 text-orange-800 border-orange-300 dark:bg-orange-900/40 dark:text-orange-200 dark:border-orange-700',
    cancelado: 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-300 dark:border-red-800',
    cancelled: 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-300 dark:border-red-800',

    // Estados de error de direcci√≥n
    direccion_erronea: 'bg-rose-100 text-rose-800 border-rose-300 dark:bg-rose-900/40 dark:text-rose-200 dark:border-rose-700',
    inaccesible: 'bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-900/30 dark:text-orange-300 dark:border-orange-800',
    
    // Estados de tr√°nsito
    en_transito: 'bg-sky-100 text-sky-700 border-sky-200 dark:bg-sky-900/30 dark:text-sky-300 dark:border-sky-800',
    shipped: 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800',
    handling: 'bg-violet-100 text-violet-700 border-violet-200 dark:bg-violet-900/30 dark:text-violet-300 dark:border-violet-800',

    // Estados de recepci√≥n
    ready_for_pickup: 'bg-teal-100 text-teal-700 border-teal-200 dark:bg-teal-900/30 dark:text-teal-300 dark:border-teal-800',
    picking: 'bg-cyan-100 text-cyan-700 border-cyan-200 dark:bg-cyan-900/30 dark:text-cyan-300 dark:border-cyan-800',
    listo_retiro: 'bg-teal-100 text-teal-700 border-teal-200 dark:bg-teal-900/30 dark:text-teal-300 dark:border-teal-800'
  };

  const classes = BADGE_CLASSES[key] || 'bg-gray-100 text-gray-700 border-gray-200 dark:bg-gray-900/30 dark:text-gray-300';

  return `<span class="inline-flex items-center text-xs px-2.5 py-0.5 rounded-full border ${classes}">${label}</span>`;
}
window.estadoBadge = estadoBadge;

function substatusChip(sub){
  if(!sub) return '';
  return `<small class="text-xs text-slate-500 dark:text-slate-300 whitespace-nowrap">${sub}</small>`;
}
window.substatusChip = substatusChip;

function getEstadoColorClass(estado){
  const COLORES = {
    pendiente: 'bg-gray-50 dark:bg-gray-900/20 text-gray-700 dark:text-gray-300 border-gray-200 dark:border-gray-800',
    en_planta: 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 border-blue-200 dark:border-blue-800',
    en_camino: 'bg-cyan-50 dark:bg-cyan-900/20 text-cyan-700 dark:text-cyan-300 border-cyan-200 dark:border-cyan-800',
    comprador_ausente: 'bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-300 border-orange-200 dark:border-orange-800',
    entregado: 'bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 border-green-200 dark:border-green-800',
    rechazado: 'bg-rose-50 dark:bg-rose-900/20 text-rose-700 dark:text-rose-300 border-rose-200 dark:border-rose-800'
  };
  return COLORES[estado] || 'bg-gray-50 dark:bg-gray-900/20 text-slate-700 dark:text-slate-200 border-slate-300 dark:border-white/10';
}
window.getEstadoColorClass = getEstadoColorClass;

function renderEstadoChip(envio) {
  if (!envio) return '';

  const estado = envio.estado || 'pendiente';
  const mlSubstatus = envio.ml_substatus;

  const estadosSinSubstatus = ['entregado', 'cancelado'];
  const mostrarSubstatus = !estadosSinSubstatus.includes(estado) && mlSubstatus;

  let html = '<div class="estado-chip flex items-center gap-2 flex-wrap">';
  html += estadoBadge(estado, getNombreEstado(estado));

  if (mostrarSubstatus) {
    html += substatusChip(String(mlSubstatus).replace(/_/g, ' '));
  }

  html += '</div>';

  return html;
}
window.renderEstadoChip = renderEstadoChip;

function getNombreEstado(estado) {
  const nombres = {
    'pendiente': 'Pendiente',
    'en_camino': 'En camino',
    'en_planta': 'En planta',
    'llega_pronto': 'Llega pronto',
    'entregado': 'Entregado',
    'reprogramado_comprador': 'Reprogramado por comprador',
    'demorado': 'Demorado',
    'no_visitado': 'No visitado',
    'comprador_ausente': 'Comprador ausente',
    'direccion_erronea': 'Direcci√≥n err√≥nea',
    'rechazado_comprador': 'Rechazado por comprador',
    'devolucion': 'Devoluci√≥n',
    'no_entregado': 'No entregado',
    'cancelado': 'Cancelado'
  };

  if (!estado) return 'Pendiente';
  return nombres[estado] || String(estado).replace(/_/g, ' ');
}

function uiStatus(envio){
  const raw=(envio.estado||envio.status||envio.estado_meli?.status||'').toLowerCase();

  const STATUS_ALIAS = {
    pending: 'pendiente',
    ready_to_ship: 'pendiente',
    handling: 'en_planta',
    shipped: 'en_camino',
    delivered: 'entregado',
    not_delivered: 'no_entregado',
    cancelled: 'cancelado'
  };

  const norm = STATUS_ALIAS[raw] || raw || 'pendiente';

  const STATUS_LABELS = {
    // Estados manuales
    pendiente: 'Pendiente',
    en_planta: 'En planta',
    comprador_ausente: 'Comprador ausente',
    rechazado: 'Rechazado',

    // Estados comunes
    pendiente: 'Pendiente',
    en_camino: 'En camino',
    asignado: 'Asignado',
    entregado: 'Entregado',
    no_entregado: 'No entregado',

    // Estados de demora
    reprogramado: 'Reprogramado',
    demorado: 'Demorado',
    cancelado: 'Cancelado',
    cancelled: 'Cancelado',

    // Estados de error
    direccion_erronea: 'Direcci√≥n err√≥nea',
    inaccesible: 'Inaccesible',
    
    // Estados de tr√°nsito
    en_transito: 'En tr√°nsito',
    shipped: 'Enviado',
    handling: 'En proceso',

    // Estados de recepci√≥n
    ready_for_pickup: 'Listo para retirar',
    picking: 'Preparando',

    // Estados especiales
    listo_retiro: 'Listo para retirar'
  };

  let cardLabel = STATUS_LABELS[norm];
  if (!cardLabel) {
    const fallback = norm ? norm.replace(/_/g,' ') : 'Pendiente';
    cardLabel = fallback.replace(/\b\w/g, c => c.toUpperCase());
  }

  const mlSubstatus = envio.ml_substatus || envio.substatus || envio.estado_meli?.substatus || '';
  const substatusDisplay = mlSubstatus ? String(mlSubstatus).replace(/_/g, ' ') : '';

  return { key:norm, label:cardLabel, substatus:substatusDisplay };
}

async function cargarChoferes(){
  try{
    const res = await fetch('/api/choferes', { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const choferes = await res.json();
    const sel = document.getElementById('filtroChofer');
    if (!sel) return;
    sel.innerHTML = '<option value="">‚Äî Todos los choferes ‚Äî</option>';
    choferes
      .slice()
      .sort((a,b)=> (a?.nombre||'').localeCompare(b?.nombre||''))
      .forEach(c=>{
        const opt = document.createElement('option');
        opt.value = c._id;
        opt.textContent = c.nombre || c.username || c._id;
        sel.appendChild(opt);
      });
  }catch(e){ console.error('Error cargando choferes:', e); }
}

async function cargarPartidos(){
  try{
    const res=await fetch('/api/partidos',{cache:'no-store'}); const lista=await res.json();
    const panel=document.getElementById('panelPartidos'); panel.innerHTML='';
    const rowAll=document.createElement('label'); rowAll.className='flex items-center gap-2 p-1 cursor-pointer font-medium'; rowAll.innerHTML=`<input type="checkbox" id="chk_all_partidos" class="accent-amber-600" checked><span>Todos</span>`; panel.appendChild(rowAll);
    const hr=document.createElement('hr'); hr.className='my-1 border-slate-200 dark:border-white/10'; panel.appendChild(hr);
    lista.forEach(p=>{ const nombre=p.nombre; const nombreNorm=normalize(nombre); const row=document.createElement('label'); row.className='flex items-center gap-2 p-1 cursor-pointer'; row.innerHTML=`<input type="checkbox" data-nombre="${nombre}" data-nombre-norm="${nombreNorm}" class="accent-amber-600"><span>${nombre}</span>`; panel.appendChild(row); });
    const btn=document.getElementById('btnPartidos');
    btn.addEventListener('click',()=> panel.classList.toggle('hidden'));
    document.addEventListener('click',(e)=>{ if(!panel.contains(e.target) && e.target!==btn) panel.classList.add('hidden'); });
    panel.addEventListener('change',(e)=>{
      const target=e.target;
      if(target.id==='chk_all_partidos'){ if(target.checked){ seleccionPartidos.clear(); panel.querySelectorAll('input[type="checkbox"][data-nombre-norm]').forEach(cb=>cb.checked=false);} updateCountPartidos(); aplicarFiltro(); return; }
      if(target.matches('input[type="checkbox"][data-nombre-norm]')){ const all=document.getElementById('chk_all_partidos'); all.checked=false; const nomNorm=target.dataset.nombreNorm; if(target.checked) seleccionPartidos.add(nomNorm); else seleccionPartidos.delete(nomNorm); updateCountPartidos(); aplicarFiltro(); }
    });
    updateCountPartidos();
  }catch(e){ console.error('No se pudo cargar partidos:', e); }
}

async function aplicarFiltro(){
  const cliRaw=(document.getElementById('filtroCliente')?.value||'');
  const trackingRaw=(document.getElementById('filtroTracking')?.value||'');
  const idVentaRaw=(document.getElementById('filtroIdVenta')?.value||'');
  const direccionRaw=(document.getElementById('filtroDireccion')?.value||'');
  const desde=(document.getElementById('filtroDesde')?.value||'');
  const hasta=(document.getElementById('filtroHasta')?.value||'');
  const estadoSel=(document.getElementById('filtroEstado')?.value||'').toLowerCase();
  const origenSel=(document.getElementById('filtroOrigen')?.value||'');
  const choferSel=(document.getElementById('filtroChofer')?.value||'');
  const tracking=trackingRaw.trim(); const id_venta=idVentaRaw.trim(); const estado=estadoSel||'';
  const direccion=direccionRaw.trim();
  const partidos=[]; document.querySelectorAll('#panelPartidos input[type="checkbox"][data-nombre-norm]:checked').forEach(cb=>partidos.push(cb.getAttribute('data-nombre')));
  const all=document.getElementById('chk_all_partidos'); if(all && all.checked) partidos.length=0;

  try{
    filtrosActivos={ cliente:cliRaw.trim()||undefined, tracking:tracking||undefined, id_venta:id_venta||undefined, direccion:direccion||undefined, desde:desde||undefined, hasta:hasta||undefined, estado:estado||undefined, origen:origenSel||undefined, chofer:choferSel||undefined, partidos:partidos, limit:100 };

    // Si el usuario seleccion√≥ un estado manualmente, desactivar filtro de incidencias
    const estadoSeleccionado = document.getElementById('filtroEstado')?.value || '';

    if (estadoSeleccionado) {
      // Usuario eligi√≥ estado espec√≠fico ‚Üí desactivar incidencias
      window._filtroIncidencias = false;
      filtrosActivos.estado = estadoSeleccionado;
    } else if (window._filtroIncidencias) {
      // No hay estado seleccionado pero incidencias est√° activo
      filtrosActivos.incidencias = 'true';
    }

    const q=buildQueryParams(filtrosActivos);
    console.log('Query partidos:', q.toString());
    const res=await fetch(`/api/envios?${q.toString()}`,{cache:'no-store'}); const data=await res.json();
    enviosCargados=data.rows||data||[]; nextCursor=data.nextCursor||null;
    renderTabla(); renderPaginacionLikeCursor();
  }catch(err){ console.error('Error aplicando filtro:', err); }
}

async function limpiarFiltros(){
  document.getElementById('filtroCliente').value='';
  document.getElementById('filtroTracking').value='';
  document.getElementById('filtroIdVenta').value='';
  document.getElementById('filtroDireccion').value='';
  document.getElementById('filtroDesde').value='';
  document.getElementById('filtroHasta').value='';
  document.getElementById('filtroEstado').value='';
  document.getElementById('filtroOrigen').value='';
  const choferSel=document.getElementById('filtroChofer'); if(choferSel) choferSel.value='';
  seleccionPartidos.clear(); const all=document.getElementById('chk_all_partidos'); if(all) all.checked=true;
  document.querySelectorAll('#panelPartidos input[type="checkbox"][data-nombre-norm]').forEach(cb=>cb.checked=false);

  // Limpiar filtro de incidencias
  window._filtroIncidencias = false;

  // Limpiar par√°metros de URL
  window.history.replaceState({}, document.title, window.location.pathname);

  updateCountPartidos(); await cargarPrimerPagina();
}

function renderTabla(){
  const tbody=document.getElementById('tablaEnvios'); tbody.innerHTML='';
  const lista=enviosCargados||[];
  if(!lista.length){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="px-4 py-6 text-center opacity-70" colspan="8">No hay env√≠os para los filtros seleccionados</td>`;
    tbody.appendChild(tr); return;
  }
  lista.forEach(e=>{
    const fecha=new Date(e.updatedAt||e.fecha||e.createdAt||Date.now()).toLocaleString();
    const { key:eKey, label:eLabel, substatus }=uiStatus(e);

    // Agregar icono de alerta para estados que necesitan atenci√≥n
    const needsAttention = [
      'comprador_ausente', 'inaccesible', 'direccion_erronea',
       'demorado', 'reprogramado', 'no_entregado', 'rechazado'
    ];

    let iconoAlerta = '';
    if (needsAttention.includes(eKey)) {
      iconoAlerta = '<span class="mr-1" title="Requiere atenci√≥n">‚ö†Ô∏è</span>';
    }

    let estadoHTML;
    const estadoActual = (e.estado || '').toLowerCase();

    if (e.requiere_sync_meli === false) {
      const actual = estadoActual || 'pendiente';
      const colorClass = getEstadoColorClass(actual);
      estadoHTML = (
        `${iconoAlerta}<select onchange="cambiarEstadoEnvio('${e._id}', this.value)"
          class="text-xs px-2 py-1 rounded-lg border border-slate-300 dark:border-white/10 bg-white dark:bg-[#0B1020] text-slate-900 dark:text-slate-100 ${colorClass} cursor-pointer hover:border-slate-400 dark:hover:border-white/20 transition-colors">
          <option value="pendiente" ${actual === 'pendiente' ? 'selected' : ''}>
            Pendiente
          </option>
          <option value="en_planta" ${actual === 'en_planta' ? 'selected' : ''}>
            En planta
          </option>
          <option value="en_camino" ${actual === 'en_camino' ? 'selected' : ''}>
            En camino
          </option>
          <option value="comprador_ausente" ${actual === 'comprador_ausente' ? 'selected' : ''}>
            Comprador ausente
          </option>
          <option value="entregado" ${actual === 'entregado' ? 'selected' : ''}>
            Entregado
          </option>
          <option value="rechazado" ${actual === 'rechazado' ? 'selected' : ''}>
            Rechazado
          </option>
        </select>`
      ).trim();
    } else {
      estadoHTML = iconoAlerta + renderEstadoChip(e);
    }
    const partidoUI=(e.partido && e.partido.trim())? e.partido : '-';
    const zonaFact=(e.zona && e.zona.trim())? cleanZona(e.zona) : '';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="px-4 py-2">
        <button class="text-indigo-600 dark:text-indigo-400 hover:underline" data-id="${e._id}" onclick="mostrarDetalle(this.dataset.id)" title="Ver detalle">
          ${e.meli_id || e.id_venta || '(sin id)'}
        </button>
        ${ hasQr(e) ? qrIconButtonHtml(e._id) : `<span class="inline-block align-middle" data-qr-probe="${e._id}"></span>` }
        ${ e.meli_id ? `<button class="ml-2 text-xs border px-2 py-0.5 rounded hover:bg-slate-50 dark:hover:bg-white/10" onclick="forceSyncMeli('${e.meli_id}')" title="Actualizar estado desde MeLi">‚Üª</button>` : '' }
      </td>
      <td class="px-4 py-2 font-mono">${e.id_venta || '-'}</td>
      <td class="px-4 py-2">${nombreClienteEnvio(e)}</td>
      <td class="px-4 py-2">${fecha}</td>
      <td class="px-4 py-2" title="${zonaFact}">${partidoUI}</td>
      <td class="px-4 py-2">${e.chofer?.nombre || ''}</td>
      <td class="px-4 py-2">${estadoHTML}</td>
      <td class="px-4 py-2">
        <button class="text-rose-600 hover:text-rose-700" title="Eliminar" onclick="abrirModalEliminar('${e._id}')">üóë</button>
        <button class="text-slate-600 hover:text-slate-800 dark:text-slate-300 dark:hover:text-slate-100 mr-2" title="Notas" onclick="abrirModalNotas('${e._id}')">üìù</button>
        ${ hasNotesFlag(e) ? `<span title="Tiene notas" class="mr-1">üö©</span>` : '' }
      </td>`;
    tbody.appendChild(tr);
  });
  probeQrButtons();
}

function renderPaginacionLikeCursor(){
  const info=document.getElementById('infoPagina'); const btnMas=document.getElementById('btnMas');
  if(info) info.textContent = `${enviosCargados.length} items` + (nextCursor ? ' (hay m√°s‚Ä¶)' : '');
  if(btnMas) btnMas.disabled=!nextCursor;
}

async function mostrarDetalle(envioId){
  try{
    const res=await fetch(`/api/envios/${envioId}`,{cache:'no-store'}); if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data=await res.json();
    const clienteNombreRaw = nombreClienteEnvio(data);
    const clienteNombre = clienteNombreRaw === '‚Äî' ? '‚Äî sin nombre ‚Äî' : clienteNombreRaw;
    const partido=data.partido?.trim?.()||'-'; const zonaFact=data.zona?.trim?.()||'-';
    const s=uiStatus(data); const hist=data.timeline||data.historial||data.eventos||[];
    renderHistorial(hist, data);
    renderEvidencias(data);
    switchTab('detalle');
    const cd=document.getElementById('contenidoDetalle');

    // Preparar info de cobro en destino
    let cobroHtml = '';
    if (data.cobroEnDestino?.habilitado) {
      const monto = data.cobroEnDestino.monto || 0;
      const cobrado = data.cobroEnDestino.cobrado;
      const metodoPago = data.cobroEnDestino.metodoPago;

      let estadoCobro = '';
      if (cobrado) {
        const metodoTexto = metodoPago === 'efectivo' ? 'Efectivo' :
                           metodoPago === 'transferencia' ? 'Transferencia' : 'Otro';
        estadoCobro = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300">
          ‚úì Cobrado (${metodoTexto})
        </span>`;
      } else {
        estadoCobro = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300">
          ‚è≥ Pendiente
        </span>`;
      }

      cobroHtml = `<p><strong>Cobro en destino:</strong> $${monto.toLocaleString('es-AR')} ${estadoCobro}</p>`;
    }

    cd.innerHTML=`
      <p><strong>Cliente:</strong> ${clienteNombre}</p>
      <p><strong>Destinatario:</strong> ${data.destinatario || '-'}</p>
      <p><strong>Direcci√≥n:</strong> ${data.direccion || '-'}</p>
      <p><strong>Tracking (ML):</strong> ${data.meli_id || '-'}</p>
      <p><strong>ID de venta:</strong> ${data.id_venta || '-'}</p>
      <p><strong>Estado:</strong> ${renderEstadoChip(data)}</p>
      <p><strong>CP:</strong> ${data.codigo_postal || '-'}</p>
      <p><strong>Partido:</strong> ${partido}</p>
      <p><strong>Referencia:</strong> ${data.referencia || '-'}</p>
      ${cobroHtml}`;

    // Mostrar intentos si existen
    const ultimoEvento = (data.historial || [])
      .filter(h => h.estado_meli?.substatus === 'receiver_absent')
      .sort((a,b) => new Date(b.at) - new Date(a.at))[0];

    if (ultimoEvento?.metadata?.intentos) {
      cd.innerHTML += `<p><strong>Intentos de entrega:</strong> ${ultimoEvento.metadata.intentos}</p>`;
    }

    // Bot√≥n ‚ÄúVer QR de respaldo‚Äù
    (() => {
      const cd=document.getElementById('contenidoDetalle');
      let btn=document.getElementById('btnVerQrRespaldo');
      if(!btn){
        btn=document.createElement('button'); btn.id='btnVerQrRespaldo'; btn.type='button';
        btn.className='mt-3 px-3 py-2 border rounded text-sm hover:bg-slate-50 dark:hover:bg-white/10';
        btn.textContent='Ver QR de respaldo (7 d√≠as)'; cd.appendChild(btn);
      }
      btn.disabled=false; btn.onclick=()=>cargarQrRespaldo(data._id);
    })();

    const modal=document.getElementById('modalDetalle');
    modal.classList.remove('hidden'); modal.classList.add('flex'); document.body.classList.add('overflow-hidden');
    if(Number.isFinite(data.latitud) && Number.isFinite(data.longitud)) initMapa(data.latitud,data.longitud); else initMapa(NaN,NaN);
  }catch(e){ console.error('Error mostrando detalle:', e); alert('No se pudo cargar el detalle del env√≠o.'); }
}
function cerrarModalDetalle(){ const m=document.getElementById('modalDetalle'); m.classList.add('hidden'); m.classList.remove('flex'); document.body.classList.remove('overflow-hidden'); if(mapaInstancia){ mapaInstancia.remove(); mapaInstancia=null; } }

function openQrModal(url){ const m=document.getElementById('qrViewModal'); const img=document.getElementById('qrViewImg'); img.src=url; m.classList.remove('hidden'); }
function closeQrModal(){ const m=document.getElementById('qrViewModal'); const img=document.getElementById('qrViewImg'); img.src=''; m.classList.add('hidden'); }
document.getElementById('qrViewClose')?.addEventListener('click', closeQrModal);
document.getElementById('qrViewModal')?.addEventListener('click', (e)=>{ if (e.target===e.currentTarget) closeQrModal(); });
async function cargarQrRespaldo(envioId){
  try{
    const r=await fetch(`/api/scan-meli/latest-render/${envioId}`); const j=await r.json();
    if(!r.ok || !j.ok || !j.url){ return alert('Sin QR vinculado o vencido'); }
    openQrModal(j.url);
  }catch(e){ console.error(e); alert('No se pudo obtener el QR'); }
}

let envioAEliminar=null;
function abrirModalEliminar(id){ envioAEliminar=id; const m=document.getElementById('modalEliminar'); m.classList.remove('hidden'); m.classList.add('flex'); document.body.classList.add('overflow-hidden'); }
function cerrarModalEliminar(){ envioAEliminar=null; const m=document.getElementById('modalEliminar'); m.classList.add('hidden'); m.classList.remove('flex'); document.body.classList.remove('overflow-hidden'); }
document.getElementById('btnConfirmEliminar').addEventListener('click', async ()=>{
  if(!envioAEliminar) return;
  try{
    const res=await fetch(`/api/envios/${envioAEliminar}`,{method:'DELETE',cache:'no-store'});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    enviosCargados=enviosCargados.filter(e=>e._id!==envioAEliminar);
    cerrarModalEliminar(); renderTabla(); renderPaginacionLikeCursor();
  }catch(e){ console.error('Error eliminando env√≠o:', e); alert('No se pudo eliminar el env√≠o.'); }
});

// Notas
let envioNotasId=null;
const IS_ADMIN = (window.USER_ROLE === 'admin');
const PUEDE_AGREGAR_NOTAS = (window.USER_ROLE === 'admin' || window.USER_ROLE === 'coordinador');
function abrirModalNotas(id){
  envioNotasId=id;
  const m=document.getElementById('modalNotas');
  m.classList.remove('hidden');
  m.classList.add('flex');
  document.body.classList.add('overflow-hidden');
  document.getElementById('notaTexto').value='';
  cargarNotas();

  // Habilitar/deshabilitar formulario seg√∫n permisos
  const textarea = document.getElementById('notaTexto');
  const btnGuardar = document.getElementById('btnGuardarNota');

  if (textarea && btnGuardar) {
    if (!PUEDE_AGREGAR_NOTAS) {
      textarea.disabled = true;
      textarea.placeholder = 'No ten√©s permisos para agregar notas';
      btnGuardar.disabled = true;
      btnGuardar.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
      textarea.disabled = false;
      textarea.placeholder = 'Escribir nota...';
      btnGuardar.disabled = false;
      btnGuardar.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }
}
function cerrarModalNotas(){ envioNotasId=null; const m=document.getElementById('modalNotas'); m.classList.add('hidden'); m.classList.remove('flex'); document.body.classList.remove('overflow-hidden'); }
document.getElementById('modalNotas').addEventListener('click',(e)=>{ if(e.target===e.currentTarget) cerrarModalNotas(); });
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') cerrarModalNotas(); });

function renderListaNotas(notas=[]){
  const box=document.getElementById('listaNotas');
  if(!Array.isArray(notas)||!notas.length){ box.innerHTML=`<div class="text-sm text-slate-500">A√∫n no hay notas para este env√≠o.</div>`; return; }
  box.innerHTML=notas.map(n=>{
    const fecha=n.at ? new Date(n.at).toLocaleString() : '';
    const autor=n.actor_name || '‚Äî';
    const texto=(n.texto||n.note||'').toString().replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const acciones=IS_ADMIN ? `<button class="text-rose-600 hover:text-rose-700 text-xs" title="Eliminar nota" onclick="eliminarNota('${n._id}')">üóë</button>` : '';
    return `<div class="border border-slate-200 dark:border-white/10 rounded-xl p-3">
      <div class="flex items-center justify-between text-xs opacity-70">
        <div class="flex items-center gap-2"><span>${fecha}</span><span class="opacity-50">‚Ä¢</span><span>${autor}</span></div>
        <div>${acciones}</div>
      </div>
      <div class="mt-1 text-sm whitespace-pre-wrap">${texto}</div>
    </div>`;
  }).join('');
}
async function cargarNotas(){
  const box=document.getElementById('listaNotas');
  try{
    const r=await fetch(`/api/envios/${envioNotasId}/notas`,{cache:'no-store'}); if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const data=await r.json(); renderListaNotas(data);
  }catch(e){ console.error('Notas GET error', e); box.innerHTML=`<div class="text-sm text-rose-600">No se pudieron cargar las notas.</div>`; }
}
document.getElementById('btnGuardarNota').addEventListener('click', async ()=>{
  const texto=document.getElementById('notaTexto').value.trim(); if(!texto) return alert('Escrib√≠ una nota.');
  try{
    const r=await fetch(`/api/envios/${envioNotasId}/notas`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({texto})});
    if(!r.ok) throw new Error(`HTTP ${r.status}`); document.getElementById('notaTexto').value=''; await cargarNotas();
    const abierto=!document.getElementById('modalDetalle').classList.contains('hidden'); if(abierto) await mostrarDetalle(envioNotasId);
  }catch(e){ console.error('Notas POST error', e); alert('No se pudo guardar la nota.'); }
});
async function eliminarNota(notaId){
  if(!IS_ADMIN){ alert('Solo administradores pueden eliminar notas.'); return; }
  if(!confirm('¬øEliminar esta nota?')) return;
  try{
    const r=await fetch(`/api/envios/${envioNotasId}/notas/${notaId}`,{method:'DELETE'});
    if(r.status===403){ alert('No ten√©s permisos para eliminar notas.'); return; }
    if(!r.ok) throw new Error(`HTTP ${r.status}`); await cargarNotas();
    const abierto=!document.getElementById('modalDetalle').classList.contains('hidden'); if(abierto) await mostrarDetalle(envioNotasId);
  }catch(e){ console.error('Notas DELETE error', e); alert('No se pudo eliminar la nota.'); }
}

window.abrirModalNotas=abrirModalNotas; window.cerrarModalNotas=cerrarModalNotas;
window.aplicarFiltro=aplicarFiltro; window.limpiarFiltros=limpiarFiltros;
window.mostrarDetalle=mostrarDetalle; window.abrirModalEliminar=abrirModalEliminar;
window.cerrarModalEliminar=cerrarModalEliminar; window.cerrarModalDetalle=cerrarModalDetalle;

// ===== CARGA MANUAL DE EVIDENCIAS (ADMIN/COORDINADOR) =====
let modalIntentoFallidoManual = null;
let modalEntregaManual = null;
let envioActualParaEvidencias = null;

async function abrirModalIntentoFallidoManual(envioId) {
  try {
    // Cargar env√≠o completo
    const response = await fetch(`/api/envios/${envioId}`, {
      credentials: 'same-origin'
    });

    if (!response.ok) {
      throw new Error(`Error al cargar env√≠o: ${response.status}`);
    }

    const envio = await response.json();
    envioActualParaEvidencias = envio;

    // Inicializar modal si no existe
    if (!modalIntentoFallidoManual) {
      modalIntentoFallidoManual = new RegistrarIntentoFallidoModal();
    }

    // Abrir modal
    modalIntentoFallidoManual.open(
      envio,
      // onConfirm
      () => {
        console.log('Intento fallido registrado manualmente');
        // Recargar evidencias
        setTimeout(async () => {
          const respuesta = await fetch(`/api/envios/${envioId}`);
          const envioActualizado = await respuesta.json();
          renderEvidencias(envioActualizado);
          renderHistorial(envioActualizado.historial, envioActualizado);
          // Recargar lista principal
          cargarPrimerPagina();
        }, 1000);
      },
      // onClose
      () => {
        console.log('Modal intento fallido cerrado');
      }
    );
  } catch (error) {
    console.error('Error al abrir modal de intento fallido:', error);
    alert('Error al cargar los datos del env√≠o. Por favor, intente nuevamente.');
  }
}

async function abrirModalEntregaManual(envioId) {
  try {
    // Cargar env√≠o completo
    const response = await fetch(`/api/envios/${envioId}`, {
      credentials: 'same-origin'
    });

    if (!response.ok) {
      throw new Error(`Error al cargar env√≠o: ${response.status}`);
    }

    const envio = await response.json();
    envioActualParaEvidencias = envio;

    // Inicializar modal si no existe
    if (!modalEntregaManual) {
      modalEntregaManual = new ConfirmarEntregaModal();
    }

    // Abrir modal
    modalEntregaManual.open(
      envio,
      // onConfirm
      (envioActualizado) => {
        console.log('Entrega confirmada manualmente:', envioActualizado);
        // Recargar evidencias
        setTimeout(async () => {
          const respuesta = await fetch(`/api/envios/${envioId}`);
          const envioNuevo = await respuesta.json();
          renderEvidencias(envioNuevo);
          renderHistorial(envioNuevo.historial, envioNuevo);
          // Recargar lista principal
          cargarPrimerPagina();
        }, 1000);
      },
      // onClose
      () => {
        console.log('Modal entrega cerrado');
      }
    );
  } catch (error) {
    console.error('Error al abrir modal de entrega:', error);
    alert('Error al cargar los datos del env√≠o. Por favor, intente nuevamente.');
  }
}

window.abrirModalIntentoFallidoManual = abrirModalIntentoFallidoManual;
window.abrirModalEntregaManual = abrirModalEntregaManual;

function switchTab(which){
  const det=document.getElementById('tabDetalle');
  const his=document.getElementById('tabHistorial');
  const evi=document.getElementById('tabEvidencias');
  const bDet=document.getElementById('tabBtnDetalle');
  const bHis=document.getElementById('tabBtnHist');
  const bEvi=document.getElementById('tabBtnEvidencias');
  const activate=(btn)=>{ btn.classList.remove('text-slate-600','dark:text-slate-300','border-transparent'); btn.classList.add('text-amber-600','dark:text-amber-400','border-amber-500/80','font-medium'); };
  const deactivate=(btn)=>{ btn.classList.add('text-slate-600','dark:text-slate-300','border-transparent'); btn.classList.remove('text-amber-600','dark:text-amber-400','border-amber-500/80','font-medium'); };

  if(which==='detalle'){
    det.classList.remove('hidden');
    his.classList.add('hidden');
    evi.classList.add('hidden');
    activate(bDet);
    deactivate(bHis);
    deactivate(bEvi);
  }
  else if(which==='historial') {
    det.classList.add('hidden');
    his.classList.remove('hidden');
    evi.classList.add('hidden');
    activate(bHis);
    deactivate(bDet);
    deactivate(bEvi);
  }
  else if(which==='evidencias') {
    det.classList.add('hidden');
    his.classList.add('hidden');
    evi.classList.remove('hidden');
    activate(bEvi);
    deactivate(bDet);
    deactivate(bHis);
  }
}

function renderHistorial(histArray=[], envio=null) {
  const cont = document.getElementById('contenidoHistorial');
  if (!Array.isArray(histArray) || !histArray.length) {
    cont.innerHTML = `<p class="text-sm text-slate-500">Sin eventos por ahora.</p>`;
    return;
  }

  const rows = histArray.slice().sort((a,b)=>
    new Date(b.at||b.fecha||b.updatedAt||0)-new Date(a.at||a.fecha||a.updatedAt||0)
  ).map(h => {
    const fechaStr = h.at ? new Date(h.at).toLocaleString('es-AR') :
                     h.updatedAt ? new Date(h.updatedAt).toLocaleString('es-AR') : '-';

    let badge = '';
    let detalleNota = '';

    if ((h.estado && h.estado.toLowerCase() === 'nota') || h.note) {
      badge = `<span class="inline-flex items-center text-xs px-2 py-0.5 rounded-full border bg-gray-100 text-gray-700 dark:bg-gray-900/30 dark:text-gray-300">Nota</span>`;
      const safe = (h.note||'').toString().replace(/</g,'&lt;').replace(/>/g,'&gt;');
      detalleNota = `<div class="mt-1 text-xs italic text-slate-600 dark:text-slate-300 whitespace-pre-wrap">${safe}</div>`;
    } else {
      // Construir objeto temporal para uiStatus
      const tempEnvio = {
        estado: h.estado,
        estado_meli: h.estado_meli || {}
      };

      const { key, label } = uiStatus(tempEnvio);
      // Badge principal
      badge = estadoBadge(key, label);
      
      // Si es un evento de entrega, agregar detalles del receptor
      if (key === 'entregado' && envio?.confirmacionEntrega) {
        const conf = envio.confirmacionEntrega;
        let detalleEntrega = '<div class="mt-1 text-xs text-slate-700 dark:text-slate-300">';

        if (conf.nombreReceptor) {
          detalleEntrega += `<div><strong>Recibi√≥:</strong> ${conf.nombreReceptor}`;
          if (conf.tipoReceptor) {
            detalleEntrega += ` <span style="color:#666;font-size:0.9em">(${conf.tipoReceptor})</span>`;
          }
          detalleEntrega += '</div>';
        }

        if (conf.dniReceptor) {
          detalleEntrega += `<div><strong>DNI:</strong> ${conf.dniReceptor}</div>`;
        }

        detalleEntrega += '</div>';
        detalleNota = detalleEntrega;
      }
    }

    const usuario = h.actor_name || h.usuario || '‚Äî';

    return `<tr class="border-b border-slate-200 dark:border-white/10">
      <td class="px-3 py-2 whitespace-nowrap text-xs text-slate-900 dark:text-slate-100">${fechaStr}</td>
      <td class="px-3 py-2">${badge}${detalleNota}</td>
      <td class="px-3 py-2 whitespace-nowrap opacity-80 text-xs text-slate-900 dark:text-slate-100">${usuario}</td>
    </tr>`;
  }).join('');

  cont.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full text-sm">
    <thead class="bg-slate-50 dark:bg-white/5">
      <tr>
        <th class="px-3 py-2 text-left font-semibold">Fecha y hora</th>
        <th class="px-3 py-2 text-left font-semibold">Estado</th>
        <th class="px-3 py-2 text-left font-semibold">Usuario</th>
      </tr>
    </thead>
    <tbody>${rows}</tbody>
  </table></div>`;
}

// ========== EVIDENCIAS ==========

function renderEvidencias(envio) {
  const cont = document.getElementById('contenidoEvidencias');
  if (!envio) {
    cont.innerHTML = '<div class="text-sm text-slate-500">No se pudo cargar las evidencias.</div>';
    return;
  }

  // NUEVO: Verificar permisos para botones de carga manual
  const PUEDE_SUBIR_EVIDENCIAS = (window.USER_ROLE === 'admin' || window.USER_ROLE === 'coordinador');

  const intentosFallidos = envio.intentosFallidos || [];
  const confirmacion = envio.confirmacionEntrega;
  const tieneEvidencias = intentosFallidos.length > 0 || (confirmacion && confirmacion.confirmada);

  // Actualizar badge del tab
  const badgeCount = intentosFallidos.length + (confirmacion?.confirmada ? 1 : 0);
  const labelElem = document.getElementById('tabEvidenciasLabel');
  if (labelElem) {
    if (badgeCount > 0) {
      labelElem.innerHTML = `Evidencias <span class="ml-2 inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold leading-none text-white bg-amber-600 rounded-full">${badgeCount}</span>`;
    } else {
      labelElem.textContent = 'Evidencias';
    }
  }

  if (!tieneEvidencias) {
    let botonesHtml = '';

    if (PUEDE_SUBIR_EVIDENCIAS) {
      botonesHtml = `
        <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center">
          <button
            onclick="abrirModalIntentoFallidoManual('${envio._id}')"
            class="px-4 py-2 rounded-xl bg-orange-500 hover:bg-orange-600 text-white font-medium shadow-sm flex items-center gap-2 justify-center">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            Registrar Intento Fallido
          </button>

          <button
            onclick="abrirModalEntregaManual('${envio._id}')"
            class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white font-medium shadow-sm flex items-center gap-2 justify-center">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Confirmar Entrega
          </button>
        </div>
      `;
    }

    cont.innerHTML = `
      <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
        <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">üìã</div>
        <h5 style="color: #495057; margin-bottom: 8px; font-size: 1.1rem; font-weight: 600;">Sin evidencias registradas</h5>
        <p style="color: #6c757d; margin-bottom: 16px;">Este env√≠o no tiene intentos fallidos ni firma digital.</p>
        ${botonesHtml}
      </div>
    `;
    return;
  }

  let html = '';

  // INTENTOS FALLIDOS
  if (intentosFallidos.length > 0) {
    html += `
      <div style="margin-bottom: ${confirmacion?.confirmada ? '32px' : '0'};">
        <!-- Header de secci√≥n -->
        <div style="margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #ffc107;">
          <h5 style="margin: 0; color: #856404; font-weight: 600; font-size: 1.1em;">Intentos de Entrega Fallidos</h5>
          <small style="color: #6c757d;">${intentosFallidos.length} registro${intentosFallidos.length > 1 ? 's' : ''}</small>
        </div>

        <!-- Lista de intentos -->
        <div class="intentos-list">
    `;

    intentosFallidos.forEach((intento, index) => {
      const fecha = new Date(intento.fecha);
      html += `
        <div style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 20px; margin-bottom: ${index < intentosFallidos.length - 1 ? '16px' : '0'};">
          <!-- Badge de n√∫mero -->
          <div style="display: inline-block; background-color: #856404; color: white; padding: 4px 12px; border-radius: 4px; font-size: 0.8em; font-weight: 600; margin-bottom: 16px; letter-spacing: 0.5px;">
            INTENTO ${index + 1}
          </div>

          <!-- Grid de informaci√≥n -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 16px;">
            <div>
              <label style="display: block; font-size: 0.75em; font-weight: 600; color: #856404; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Fecha y Hora</label>
              <div style="font-weight: 500; font-size: 0.95em;">
                ${fecha.toLocaleDateString('es-AR', { day: '2-digit', month: 'short', year: 'numeric' })}
              </div>
              <div style="font-size: 0.9em; color: #6c757d;">
                ${fecha.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' })} hs
              </div>
            </div>

            <div>
              <label style="display: block; font-size: 0.75em; font-weight: 600; color: #856404; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Motivo</label>
              <div style="font-weight: 500; font-size: 0.95em;">
                ${intento.motivo === 'ausente' ? 'Comprador Ausente' :
                  intento.motivo === 'inaccesible' ? 'Direcci√≥n Inaccesible' :
                  intento.motivo === 'rechazado' ? 'Paquete Rechazado' :
                  `<span style="text-transform: capitalize;">${intento.motivo}</span>`}
              </div>
            </div>

            ${intento.chofer ? `
            <div>
              <label style="display: block; font-size: 0.75em; font-weight: 600; color: #856404; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Chofer</label>
              <div style="font-weight: 500; font-size: 0.95em;">${intento.chofer.nombre || 'No especificado'}</div>
            </div>
            ` : ''}
          </div>

          ${intento.descripcion ? `
          <div style="background-color: rgba(255,255,255,0.7); border: 1px solid rgba(133,100,4,0.2); border-radius: 4px; padding: 12px; margin-bottom: 16px;">
            <label style="display: block; font-size: 0.75em; font-weight: 600; color: #856404; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Descripci√≥n</label>
            <div style="font-size: 0.9em; line-height: 1.5; color: #495057;">${intento.descripcion}</div>
          </div>
          ` : ''}

          <!-- Botones de acci√≥n -->
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            ${intento.geolocalizacion ? `
            <a href="https://www.google.com/maps?q=${intento.geolocalizacion.lat},${intento.geolocalizacion.lng}"
               target="_blank" rel="noopener noreferrer"
               class="px-3 py-1.5 text-sm border border-slate-300 dark:border-white/10 rounded-lg hover:bg-slate-50 dark:hover:bg-white/10"
               style="text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              Ver Ubicaci√≥n
            </a>
            ` : ''}

            ${intento.fotoS3Key ? `
            <button onclick="handleVerFotoEvidencia('${envio._id}', '${intento.fotoS3Key}', 'intento')"
                    class="px-3 py-1.5 text-sm bg-amber-500 hover:bg-amber-600 text-white rounded-lg"
                    style="display: inline-flex; align-items: center; gap: 6px; border: none; cursor: pointer;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
              Ver Evidencia Fotogr√°fica
            </button>
            ` : ''}
          </div>
        </div>
      `;
    });

    html += '</div></div>';
  }

  // COMPROBANTE DE ENTREGA
  if (confirmacion && confirmacion.confirmada) {
    const fechaEntrega = confirmacion.fechaEntrega ? new Date(confirmacion.fechaEntrega) : null;
    html += `
      <div>
        <!-- Header de secci√≥n -->
        <div style="margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #28a745;">
          <h5 style="margin: 0; color: #155724; font-weight: 600; font-size: 1.1em;">‚úÖ Comprobante de Entrega</h5>
          <small style="color: #6c757d;">
            ${confirmacion.firmaS3Key ? 'Firmado digitalmente por el receptor' : 'Entrega confirmada'}
          </small>
        </div>

        <!-- Card de confirmaci√≥n -->
        <div style="background-color: #d4edda; border: 1px solid #28a745; border-radius: 6px; padding: 20px;">
          <!-- Grid de informaci√≥n -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 16px;">
            <div>
              <label style="display: block; font-size: 0.75em; font-weight: 600; color: #155724; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">üë§ Receptor</label>
              <div style="font-weight: 500; font-size: 0.95em;">${confirmacion.nombreReceptor || 'N/A'}</div>
            </div>

            <div>
              <label style="display: block; font-size: 0.75em; font-weight: 600; color: #155724; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">üÜî DNI</label>
              <div style="font-weight: 500; font-size: 0.95em;">${confirmacion.dniReceptor || 'N/A'}</div>
            </div>

            <div>
              <label style="display: block; font-size: 0.75em; font-weight: 600; color: #155724; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">üìã Tipo de Receptor</label>
              <div style="font-weight: 500; font-size: 0.95em;">
                ${confirmacion.tipoReceptor === 'destinatario' ? 'üë§ Destinatario' :
                  confirmacion.tipoReceptor === 'porteria' ? 'üè¢ Porter√≠a' :
                  confirmacion.tipoReceptor === 'familiar' ? 'üë• Familiar' :
                  confirmacion.tipoReceptor === 'otro' ? 'üìù Otro' : confirmacion.tipoReceptor}
              </div>
            </div>

            <div>
              <label style="display: block; font-size: 0.75em; font-weight: 600; color: #155724; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">üìÖ Fecha y Hora</label>
              <div style="font-weight: 500; font-size: 0.95em;">
                ${fechaEntrega ? fechaEntrega.toLocaleDateString('es-AR', { day: '2-digit', month: 'short', year: 'numeric' }) : 'N/A'}
              </div>
              <div style="font-size: 0.9em; color: #155724;">
                ${confirmacion.horaEntrega || (fechaEntrega ? fechaEntrega.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' }) + ' hs' : 'N/A')}
              </div>
            </div>
          </div>

          ${confirmacion.aclaracionReceptor ? `
          <div style="background-color: rgba(255,255,255,0.7); border: 1px solid rgba(21,87,36,0.2); border-radius: 4px; padding: 12px; margin-bottom: 16px;">
            <label style="display: block; font-size: 0.75em; font-weight: 600; color: #155724; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Aclaraci√≥n</label>
            <div style="font-size: 0.9em; line-height: 1.5; color: #495057;">${confirmacion.aclaracionReceptor}</div>
          </div>
          ` : ''}

          ${envio.cobroEnDestino?.habilitado ? `
          <div style="background-color: rgba(255,193,7,0.3); border: 1px solid #ffc107; border-radius: 4px; padding: 12px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <label style="display: block; font-size: 0.75em; font-weight: 600; color: #856404; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Cobro en Destino</label>
                <div style="font-size: 1.1em; font-weight: 600;">
                  $${envio.cobroEnDestino.monto?.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                </div>
                <div style="font-size: 0.85em; color: #856404; margin-top: 4px;">
                  M√©todo: ${envio.cobroEnDestino.metodoPago === 'efectivo' ? 'Efectivo' : 'Transferencia'}
                </div>
              </div>
              <div>
                <span style="padding: 6px 12px; border-radius: 4px; font-size: 0.85em; font-weight: 600; background-color: ${envio.cobroEnDestino.cobrado ? '#28a745' : '#ffc107'}; color: ${envio.cobroEnDestino.cobrado ? 'white' : '#856404'};">
                  ${envio.cobroEnDestino.cobrado ? 'COBRADO' : 'PENDIENTE'}
                </span>
              </div>
            </div>
          </div>
          ` : ''}

          <!-- Botones de acci√≥n -->
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            ${confirmacion.geolocalizacion ? `
            <a href="https://www.google.com/maps?q=${confirmacion.geolocalizacion.lat},${confirmacion.geolocalizacion.lng}"
               target="_blank" rel="noopener noreferrer"
               style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: white; border: 2px solid #28a745; color: #28a745; border-radius: 6px; font-weight: 600; text-decoration: none; font-size: 14px;">
              üó∫Ô∏è Ver Ubicaci√≥n
            </a>
            ` : ''}

            ${confirmacion.firmaS3Key ? `
            <button onclick="handleVerFirmaDigital('${envio._id}', '${confirmacion.firmaS3Key}')"
                    style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px;">
              üñäÔ∏è Ver Firma Digital
            </button>
            ` : ''}

            ${confirmacion.fotoDNIS3Key ? `
            <button onclick="handleVerFotoDNI('${envio._id}', '${confirmacion.fotoDNIS3Key}')"
                    style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px;">
              üì∑ Ver Foto DNI
            </button>
            ` : ''}
          </div>

          <!-- Nota legal -->
          <div style="margin-top: 12px; padding: 8px; background-color: rgba(255,255,255,0.5); border-radius: 4px; font-size: 0.8em; color: #155724; text-align: center; font-style: italic;">
            Comprobante con validez legal de entrega
          </div>
        </div>
      </div>
    `;
  }

  cont.innerHTML = html;

  // NUEVO: Agregar botones de carga manual al final si tiene permisos
  if (PUEDE_SUBIR_EVIDENCIAS) {
    const botonesManual = document.createElement('div');
    botonesManual.className = 'mt-6 pt-6 border-t border-slate-200 dark:border-white/10';
    botonesManual.innerHTML = `
      <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">Cargar evidencias manualmente:</p>
      <div class="flex flex-col sm:flex-row gap-3">
        <button
          onclick="abrirModalIntentoFallidoManual('${envio._id}')"
          class="px-4 py-2 rounded-xl bg-orange-500 hover:bg-orange-600 text-white font-medium shadow-sm flex items-center gap-2 justify-center">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          Registrar Intento Fallido
        </button>

        <button
          onclick="abrirModalEntregaManual('${envio._id}')"
          class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white font-medium shadow-sm flex items-center gap-2 justify-center">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Confirmar Entrega
        </button>
      </div>
    `;
    cont.appendChild(botonesManual);
  }
}

async function handleVerFotoEvidencia(envioId, fotoS3Key, tipo) {
  const modal = document.getElementById('modalFotoEvidencia');
  const titulo = document.getElementById('modalFotoTitulo');
  const subtitulo = document.getElementById('modalFotoSubtitulo');
  const loading = document.getElementById('modalFotoLoading');
  const img = document.getElementById('modalFotoImg');
  const footer = document.getElementById('modalFotoFooter');

  // Configurar t√≠tulo
  titulo.textContent = 'Evidencia Fotogr√°fica';

  // Obtener ID de venta del env√≠o actual
  try {
    const res = await fetch(`/api/envios/${envioId}`, { cache: 'no-store' });
    const envio = await res.json();
    subtitulo.textContent = `ID: ${envio.id_venta || envio._id}`;
  } catch (e) {
    subtitulo.textContent = `ID: ${envioId}`;
  }

  // Mostrar modal con loading
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  loading.style.display = 'block';
  img.style.display = 'none';
  footer.style.display = 'none';

  // Cargar imagen
  try {
    const response = await fetch(
      `/api/envios/${envioId}/foto-evidencia?key=${encodeURIComponent(fotoS3Key)}`,
      {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      }
    );

    if (response.ok) {
      const data = await response.json();
      img.src = data.url;
      img.onload = () => {
        loading.style.display = 'none';
        img.style.display = 'block';
      };
    } else {
      alert('No se pudo cargar la foto');
      cerrarModalFotoEvidencia();
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error al cargar la foto de evidencia');
    cerrarModalFotoEvidencia();
  }
}

async function handleVerFirmaDigital(envioId, firmaS3Key) {
  const modal = document.getElementById('modalFotoEvidencia');
  const titulo = document.getElementById('modalFotoTitulo');
  const subtitulo = document.getElementById('modalFotoSubtitulo');
  const loading = document.getElementById('modalFotoLoading');
  const img = document.getElementById('modalFotoImg');
  const footer = document.getElementById('modalFotoFooter');

  // Configurar t√≠tulo
  titulo.textContent = 'Firma Digital del Receptor';

  // Obtener ID de venta del env√≠o actual
  try {
    const res = await fetch(`/api/envios/${envioId}`, { cache: 'no-store' });
    const envio = await res.json();
    subtitulo.textContent = `ID: ${envio.id_venta || envio._id}`;
  } catch (e) {
    subtitulo.textContent = `ID: ${envioId}`;
  }

  // Mostrar modal con loading
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  loading.style.display = 'block';
  img.style.display = 'none';
  footer.style.display = 'block';

  // Cargar imagen
  try {
    const response = await fetch(
      `/api/envios/${envioId}/firma?key=${encodeURIComponent(firmaS3Key)}`,
      {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      }
    );

    if (response.ok) {
      const data = await response.json();
      img.src = data.url;
      img.onload = () => {
        loading.style.display = 'none';
        img.style.display = 'block';
      };
    } else {
      alert('No se pudo cargar la firma');
      cerrarModalFotoEvidencia();
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error al cargar la firma digital');
    cerrarModalFotoEvidencia();
  }
}

async function handleVerFotoDNI(envioId, fotoDNIS3Key) {
  const modal = document.getElementById('modalFotoEvidencia');
  const titulo = document.getElementById('modalFotoTitulo');
  const subtitulo = document.getElementById('modalFotoSubtitulo');
  const loading = document.getElementById('modalFotoLoading');
  const img = document.getElementById('modalFotoImg');
  const footer = document.getElementById('modalFotoFooter');

  // Configurar t√≠tulo
  titulo.textContent = 'Foto del DNI del Receptor';

  // Obtener ID de venta del env√≠o actual
  try {
    const res = await fetch(`/api/envios/${envioId}`, { cache: 'no-store' });
    const envio = await res.json();
    subtitulo.textContent = `ID: ${envio.id_venta || envio._id}`;
  } catch (e) {
    subtitulo.textContent = `ID: ${envioId}`;
  }

  // Mostrar modal con loading
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  loading.style.display = 'block';
  img.style.display = 'none';
  footer.style.display = 'block';

  // Cargar imagen
  try {
    const response = await fetch(
      `/api/envios/${envioId}/foto-dni?key=${encodeURIComponent(fotoDNIS3Key)}`,
      {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      }
    );

    if (response.ok) {
      const data = await response.json();
      img.src = data.url;
      img.onload = () => {
        loading.style.display = 'none';
        img.style.display = 'block';
      };
    } else {
      alert('No se pudo cargar la foto del DNI');
      cerrarModalFotoEvidencia();
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error al cargar la foto del DNI');
    cerrarModalFotoEvidencia();
  }
}

function cerrarModalFotoEvidencia() {
  const modal = document.getElementById('modalFotoEvidencia');
  const img = document.getElementById('modalFotoImg');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
  img.src = '';
}

window.handleVerFotoEvidencia = handleVerFotoEvidencia;
window.handleVerFirmaDigital = handleVerFirmaDigital;
window.cerrarModalFotoEvidencia = cerrarModalFotoEvidencia;

// ========== CAMBIO DE ESTADO MANUAL ==========

async function cambiarEstadoEnvio(envioId, nuevoEstado) {
  if (!envioId || !nuevoEstado) {
    console.warn('cambiarEstadoEnvio: faltan par√°metros');
    return;
  }

  const recargar = async () => {
    if (typeof aplicarFiltro === 'function') {
      await aplicarFiltro();
    } else if (typeof cargarPrimerPagina === 'function') {
      await cargarPrimerPagina();
    }
  };

  try {
    const res = await fetch(`/api/envios/${envioId}/cambiar-estado`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        nuevo_estado: nuevoEstado,
        nota: 'Cambio manual de estado'
      })
    });

    let payload = null;
    try {
      payload = await res.json();
    } catch (_) {}

    if (!res.ok) {
      throw new Error(payload?.error || 'Error al cambiar estado');
    }

    console.log('‚úì Estado actualizado:', payload?.estado_nuevo || nuevoEstado);
  } catch (err) {
    console.error('Error cambiando estado:', err);
    alert(`Error: ${err.message}`);
  } finally {
    await recargar();
  }
}

window.cambiarEstadoEnvio = cambiarEstadoEnvio;



document.addEventListener('DOMContentLoaded',()=>{
  // Leer filtros de URL al cargar
  const urlParams = new URLSearchParams(window.location.search);
  const filtroEstado = urlParams.get('estado');
  const filtroIncidencias = urlParams.get('incidencias');

  // Si viene filtro de estado desde KPI, aplicarlo
  if (filtroEstado) {
    const selectEstado = document.getElementById('filtroEstado');
    if (selectEstado) {
      selectEstado.value = filtroEstado;
    }
  }

  // Si viene filtro de incidencias, marcarlo
  if (filtroIncidencias === 'true') {
    window._filtroIncidencias = true;
  }

  ['filtroCliente','filtroTracking','filtroIdVenta','filtroDireccion','filtroDesde','filtroHasta'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.addEventListener('keydown',e=>{ if(e.key==='Enter') aplicarFiltro(); });
  });
  document.getElementById('modalDetalle').addEventListener('click',(e)=>{ if(e.target===e.currentTarget) cerrarModalDetalle(); });
  document.getElementById('modalEliminar').addEventListener('click',(e)=>{ if(e.target===e.currentTarget) cerrarModalEliminar(); });
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ cerrarModalDetalle(); cerrarModalEliminar(); } });
  cargarChoferes();
  cargarPartidos().then(()=>cargarPrimerPagina());
});

document.addEventListener('DOMContentLoaded', () => {
  loadKPIs();
  setInterval(loadKPIs, 60_000);
});

async function loadKPIs() {
  const el = (id, v) => { const n = document.getElementById(id); if (n) n.textContent = v; };

  try {
    const r = await fetch('/api/kpis/home', { cache: 'no-store' });
    if (!r.ok) {
      if (r.status === 401 || r.status === 403) {
        location.href = '/auth/login';
        return;
      }
      const text = await r.text();
      console.error('KPIs HTTP error', r.status, text);
      throw new Error('kpis_fail');
    }
    const j = await r.json();
    el('kpi-pend', j.pendientes ?? '0');
    el('kpi-ruta', j.en_ruta ?? '0');
    el('kpi-ent',  j.entregados ?? '0');
    el('kpi-inc',  j.incidencias ?? '0');
  } catch (e) {
    console.error('No se pudieron cargar los KPIs', e);
    el('kpi-pend', '‚Äî'); el('kpi-ruta', '‚Äî'); el('kpi-ent', '‚Äî'); el('kpi-inc', '‚Äî');
  }
}

async function forceSyncMeli(meli_id){
  try{
    const r=await fetch(`/api/auth/meli/force-sync/${meli_id}`,{method:'POST'});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    enviosCargados=[]; await aplicarFiltro();
  }catch(e){ console.error('force-sync error', e); alert('No se pudo sincronizar con MeLi.'); }
}
window.forceSyncMeli=forceSyncMeli;

// Funciones para filtros r√°pidos desde KPIs
function filtrarPorEstado(estado) {
  // Actualizar URL sin recargar
  const url = new URL(window.location);
  url.searchParams.set('estado', estado);
  url.searchParams.delete('incidencias');
  window.history.pushState({}, '', url);

  // Actualizar select de estado si existe
  const selectEstado = document.querySelector('select[name="estado"]') ||
                       document.querySelector('#filtroEstado');
  if (selectEstado) {
    selectEstado.value = estado;
    selectEstado.dispatchEvent(new Event('change'));
  }

  // Recargar env√≠os con filtro
  window._filtroIncidencias = false;
  cargarPrimerPagina();
}

function filtrarPorIncidencias() {
  // Actualizar URL sin recargar
  const url = new URL(window.location);
  url.searchParams.set('incidencias', 'true');
  url.searchParams.delete('estado');
  window.history.pushState({}, '', url);

  // Marcar filtro de incidencias
  window._filtroIncidencias = true;

  // Limpiar select de estado
  const selectEstado = document.querySelector('select[name="estado"]') ||
                       document.querySelector('#filtroEstado');
  if (selectEstado) {
    selectEstado.value = '';
  }

  // Recargar env√≠os con filtro
  cargarPrimerPagina();
}

window.filtrarPorEstado = filtrarPorEstado;
window.filtrarPorIncidencias = filtrarPorIncidencias;

// ===== MODAL REPORTES =====
function abrirModalReportes() {
  const modal = document.getElementById('modal-reportes');
  modal.classList.remove('hidden');
  modal.classList.add('flex');

  // Cargar clientes en el select
  cargarClientesReportes();

  // Setear fechas por defecto (√∫ltima semana)
  const hoy = new Date();
  const hace7dias = new Date(hoy);
  hace7dias.setDate(hoy.getDate() - 7);

  document.getElementById('reporteDesde').valueAsDate = hace7dias;
  document.getElementById('reporteHasta').valueAsDate = hoy;
}

function cerrarModalReportes() {
  const modal = document.getElementById('modal-reportes');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

async function cargarClientesReportes() {
  try {
    const res = await fetch('/clientes');
    const clientes = await res.json();

    const select = document.getElementById('reporteClientes');
    select.innerHTML = '<option value="">Todos</option>';

    clientes.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c._id;
      opt.textContent = c.nombre;
      select.appendChild(opt);
    });
  } catch (err) {
    console.error('Error cargando clientes:', err);
  }
}

async function generarReportePreset(tipo) {
  let estados = [];
  let diasAtras = 7;

  switch(tipo) {
    case 'incidencias':
      estados = ['comprador_ausente', 'inaccesible', 'demorado', 'reprogramado'];
      break;
    case 'pendientes':
      estados = ['pendiente'];
      diasAtras = 3;
      break;
    case 'en_planta':
      estados = ['en_planta'];
      diasAtras = 3;
      break;
  }

  const hasta = new Date();
  const desde = new Date(hasta);
  desde.setDate(hasta.getDate() - diasAtras);

  await generarReporte({
    clientes: '',
    estados: estados.join(','),
    desde: desde.toISOString().split('T')[0],
    hasta: hasta.toISOString().split('T')[0],
    formato: 'xls'
  });
}

async function generarReportePersonalizado(formato) {
  // Obtener clientes seleccionados
  const selectClientes = document.getElementById('reporteClientes');
  const clientesSeleccionados = Array.from(selectClientes.selectedOptions)
    .map(o => o.value)
    .filter(v => v !== '');

  // Obtener estados seleccionados
  const estadosCheckboxes = document.querySelectorAll('input[name="reporte-estado"]:checked');
  const estadosSeleccionados = Array.from(estadosCheckboxes).map(cb => cb.value);

  // Obtener fechas
  const desde = document.getElementById('reporteDesde').value;
  const hasta = document.getElementById('reporteHasta').value;

  // Validaciones
  if (!desde || !hasta) {
    alert('Por favor seleccion√° un rango de fechas');
    return;
  }

  if (estadosSeleccionados.length === 0) {
    alert('Por favor seleccion√° al menos un estado');
    return;
  }

  await generarReporte({
    clientes: clientesSeleccionados.join(',') || 'all',
    estados: estadosSeleccionados.join(','),
    desde,
    hasta,
    formato,
    incluirHistorial: document.getElementById('incluirHistorial').checked,
    incluirIntentos: document.getElementById('incluirIntentos').checked,
    incluirCoordenadas: document.getElementById('incluirCoordenadas').checked
  });
}

async function generarReporte(params) {
  try {
    // Construir URL del endpoint
    const url = `/api/reportes/generar?${new URLSearchParams(params).toString()}`;

    if (params.formato === 'preview') {
      // Abrir vista previa en la misma p√°gina
      const res = await fetch(url);
      const data = await res.json();
      mostrarVistaPrevia(data);
    } else {
      // Descargar archivo
      window.open(url, '_blank');
      cerrarModalReportes();
    }
  } catch (err) {
    console.error('Error generando reporte:', err);
    alert('No se pudo generar el reporte');
  }
}

function mostrarVistaPrevia(data) {
  // TODO: Implementar vista previa en tabla
  console.log('Vista previa:', data);
  alert(`Reporte generado: ${data.items?.length || 0} env√≠os encontrados`);
}

// Cerrar modal al hacer click fuera
document.getElementById('modal-reportes')?.addEventListener('click', (e) => {
  if (e.target.id === 'modal-reportes') {
    cerrarModalReportes();
  }
});

window.abrirModalReportes = abrirModalReportes;
window.cerrarModalReportes = cerrarModalReportes;
window.generarReportePreset = generarReportePreset;
window.generarReportePersonalizado = generarReportePersonalizado;
</script>
<!-- ================== FIN DE TU SCRIPT ================== -->

</body>
</html>
