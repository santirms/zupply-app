<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel de Choferes</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS (por si activ√°s el mapa luego) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    html.dark select, html.dark select option { background-color:#0b1020; color:#e5e7eb; }
    @media (max-width: 640px){ #btnStartScan { width:64px; height:64px; font-size:24px; } }
  </style>

  <script>
    // ====== Tema system por defecto (auto) ======
    (function () {
      const key = 'zpl_theme';
      const saved = localStorage.getItem(key) || 'system';
      const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;
      const dark = saved === 'dark' || (saved === 'system' && prefersDark);
      document.documentElement.classList.toggle('dark', dark);
      document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('themeBtn');
        if (!btn) return;
        const order = ['light', 'dark', 'system'];
        let current = saved;
        btn.textContent = 'Tema: ' + (current === 'system' ? 'auto' : current);
        btn.addEventListener('click', () => {
          current = order[(order.indexOf(current) + 1) % order.length];
          localStorage.setItem(key, current);
          const darkNow = current === 'dark' || (current === 'system' && matchMedia('(prefers-color-scheme: dark)').matches);
          document.documentElement.classList.toggle('dark', darkNow);
          btn.textContent = 'Tema: ' + (current === 'system' ? 'auto' : current);
        });
      });
    })();
  </script>
</head>

<body class="bg-slate-50 text-slate-900 dark:bg-[#0A0D16] dark:text-slate-100">
  <!-- Topbar -->
  <header class="sticky top-0 z-30 border-b border-black/5 dark:border-white/10 bg-white/70 dark:bg-[#0B1020]/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="/index.html" class="flex items-center gap-2">
        <div class="h-8 w-8 grid place-items-center rounded" style="background:linear-gradient(135deg,#FFB74D,#FF9800,#F57C00);">
          <span class="text-white font-bold">Z</span>
        </div>
        <span class="font-semibold tracking-wide text-amber-500">zupply</span>
      </a>
      <span class="opacity-60">Choferes</span>
      <div class="ml-auto flex items-center gap-2">
        <a href="/index.html" class="px-3 py-1.5 rounded-xl text-sm border border-black/10 dark:border-white/10 hover:bg-black/[.04] dark:hover:bg-white/[.06]">üè† Home</a>
        <button id="themeBtn" class="px-3 py-1.5 rounded-xl text-sm border border-black/10 dark:border-white/10 hover:bg-black/[.04] dark:hover:bg-white/[.06]">Tema</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4 text-center">Gesti√≥n de Choferes</h1>

    <!-- Tabs -->
    <div class="flex gap-3 mb-4">
      <button data-tab="qr"   class="tab-btn px-4 py-2 rounded bg-amber-500 text-white">Asignaci√≥n por QR</button>
      <button data-tab="mapa" class="tab-btn px-4 py-2 rounded bg-slate-200 dark:bg-slate-700">Asignaci√≥n desde el mapa</button>
    </div>

    <!-- TAB: QR -->
    <section id="tab-qr" class="tab">
      <div class="grid sm:grid-cols-3 gap-3 mb-3">
        <label class="text-sm">Chofer
          <select id="choferSel" class="w-full mt-1 border rounded px-2 py-2"></select>
        </label>
        <label class="text-sm">Lista (pago chofer)
          <select id="listaSel" class="w-full mt-1 border rounded px-2 py-2"></select>
        </label>
        <input id="inputZonaQR" type="hidden" value="">
      </div>

      <div class="flex items-center gap-3 mb-3">
        <button id="btnStartScan" class="rounded bg-slate-200 dark:bg-slate-700 px-4 py-3">üì∑</button>
        <input id="inpManualTrk" class="flex-1 border rounded px-3 py-2" placeholder="Pegar tracking y Enter" />
        <div id="countQR" class="ml-auto text-sm opacity-70"></div>
      </div>

      <div id="qr-reader" class="w-full max-w-xs mx-auto hidden"></div>

      <div class="border rounded p-3 bg-white dark:bg-white/5">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-black/10 dark:border-white/10">
                <th class="text-left p-1">Tracking</th>
                <th class="text-left p-1">Cliente</th>
                <th class="text-left p-1">Direcci√≥n</th>
                <th class="text-left p-1">CP/Partido</th>
                <th class="text-left p-1"></th>
              </tr>
            </thead>
            <tbody id="tblQR"></tbody>
          </table>
        </div>
        <div class="mt-3 flex gap-2 justify-end">
          <a id="btnWA" class="hidden px-4 py-2 rounded bg-green-600 text-white" target="_blank" rel="noopener">WhatsApp</a>
          <a id="btnRemito" class="hidden px-4 py-2 rounded bg-slate-700 text-white" target="_blank" rel="noopener">Ver remito</a>
          <button id="btnAsignarQR" class="px-4 py-2 rounded bg-amber-500 text-white">Asignar</button>
        </div>
      </div>
    </section>

    <!-- TAB: MAPA -->
    <section id="tab-mapa" class="tab hidden">
      <div class="grid sm:grid-cols-2 gap-3 mb-3">
        <select id="choferSelMapa" class="border rounded px-2 py-2"></select>
        <select id="selectListaMapa" class="border rounded px-2 py-2"></select>
      </div>
      <div class="rounded border border-dashed h-80 grid place-items-center text-sm opacity-70">
        Mapa aqu√≠ (wireframe)
      </div>
    </section>
<!-- Bot√≥n abrir modal -->
<div class="mt-6 flex justify-end">
  <button id="btnOpenHist" class="px-4 py-2 rounded bg-slate-700 text-white">Historial de remitos</button>
</div>

<!-- Modal Historial Remitos -->
<div id="modalRemitos" class="hidden fixed inset-0 bg-black/50 z-40 grid place-items-center">
  <div class="bg-white dark:bg-slate-900 w-[900px] max-w-[95vw] max-h-[85vh] overflow-auto rounded shadow p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-bold">Historial de remitos</h2>
      <button class="text-xl" onclick="document.getElementById('modalRemitos').classList.add('hidden')">‚úï</button>
    </div>

    <div class="flex flex-wrap gap-2 mb-3">
      <input id="fDesde" type="date" class="border rounded px-2 py-1">
      <input id="fHasta" type="date" class="border rounded px-2 py-1">
      <select id="fChofer" class="border rounded px-2 py-1"></select>
      <button id="btnFiltrarRemitos" class="px-3 py-2 rounded bg-amber-500 text-white">Filtrar</button>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-black/10 dark:border-white/10">
            <th class="text-left p-1">Fecha</th>
            <th class="text-left p-1">Chofer</th>
            <th class="text-left p-1">Zona</th>
            <th class="text-left p-1">Total</th>
            <th class="text-left p-1">PDF</th>
          </tr>
        </thead>
        <tbody id="tblRemitos"></tbody>
      </table>
    </div>
  </div>
</div>  
  </main>

  <script>
    "use strict";

    // ===== Helpers
    const $  = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    // Estado
    const CLIENTES_MAP = new Map();
    const stateQR = { items: [], seen: new Set() };

    // ===== Tabs
    function mostrarTab(name) {
      $$('.tab').forEach(t => t.classList.add('hidden'));
      $('#tab-' + name).classList.remove('hidden');
      $$('.tab-btn').forEach(b => b.classList.remove('bg-amber-500','text-white'));
      const btn = $(`.tab-btn[data-tab="${name}"]`);
      if (btn) btn.classList.add('bg-amber-500','text-white');
    }
    document.addEventListener('DOMContentLoaded', () => {
      $$('.tab-btn').forEach(b => b.addEventListener('click', () => mostrarTab(b.dataset.tab)));
    });

    // ===== Cargar dropdowns
    async function cargarDropdowns() {
      try {
        const [choferRes, listaRes, cliRes] = await Promise.all([
          fetch('/api/choferes', { credentials: 'same-origin' }),
          fetch('/api/listas-de-precios?prefix=Choferes', { credentials: 'same-origin' }),
          fetch('/api/clientes', { credentials: 'same-origin' })
        ]);

        const choferes = choferRes.ok ? await choferRes.json() : [];
        const listas   = listaRes.ok  ? await listaRes.json()  : [];
        const clientes = cliRes.ok    ? await cliRes.json()    : [];

        // cache clientes
        CLIENTES_MAP.clear();
        for (const c of clientes) CLIENTES_MAP.set(String(c._id), c.nombre || '');

        function fillSelect(sel, arr, firstLabel) {
          if (!sel) return;
          sel.innerHTML = '';
          if (firstLabel) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = firstLabel;
            sel.appendChild(opt);
          }
          for (const it of arr) {
            const opt = document.createElement('option');
            opt.value = it._id || '';
            opt.textContent = it.nombre || '(sin nombre)';
            sel.appendChild(opt);
          }
        }

        fillSelect($('#choferSel'), choferes, '(Elegir chofer)');
        fillSelect($('#choferSelMapa'), choferes, '(Elegir chofer)');
        fillSelect($('#listaSel'), listas, '(sin lista)');
        fillSelect($('#selectListaMapa'), listas, '(sin lista)');
      } catch (e) {
        console.error('cargarDropdowns error:', e);
      }
    }

    // ===== QR Scanner
    function initQrScanner() {
      const readerDiv = $('#qr-reader');
      let scanner = null;

      $('#btnStartScan').addEventListener('click', async () => {
        // HTTPS/localhost requerido por c√°mara
        if (!window.isSecureContext && location.hostname !== 'localhost') {
          alert('La c√°mara requiere HTTPS o localhost.');
          return;
        }
        const visible = !readerDiv.classList.contains('hidden');
        if (visible) {
          if (scanner) await scanner.stop().catch(()=>{});
          readerDiv.classList.add('hidden');
          return;
        }
        readerDiv.classList.remove('hidden');

        try {
          scanner = new Html5Qrcode('qr-reader');
          let last='', lastAt=0;
          await scanner.start(
            { facingMode: 'environment' },
            { fps: 10, qrbox: 250 },
            (msg) => {
              const { tracking, sender_id } = extractPayload(msg);
              const now = Date.now();
              if (!tracking) return;
              if (tracking === last && now - lastAt < 1200) return;
              last = tracking; lastAt = now;
              addTrackingQR({ tracking, sender_id });
              if (navigator.vibrate) navigator.vibrate(40);
            },
            (err) => console.warn('QR error:', err)
          );
        } catch (e) {
          console.error('No se pudo iniciar QR:', e);
          alert('No se pudo iniciar la c√°mara. Revis√° permisos/HTTPS.');
          readerDiv.classList.add('hidden');
        }
      });

      // Pegar a mano y Enter
      $('#inpManualTrk').addEventListener('keydown', (e) => {
        if (e.key !== 'Enter') return;
        e.preventDefault();
        const { tracking, sender_id } = extractPayload(e.target.value);
        if (!tracking) return alert('Tracking inv√°lido');
        addTrackingQR({ tracking, sender_id });
        e.target.value = '';
      });
    }

    // ===== Parse de payload
    function extractPayload(raw) {
      const out = { tracking: '', sender_id: null };
      if (!raw) return out;
      const s = String(raw).trim();

      // JSON
      if (s.startsWith('{') && s.endsWith('}')) {
        try {
          const o = JSON.parse(s);
          out.tracking = String(
            o.tracking_id || o.tracking || o.id || o.id_venta || o.meli_id || o.code || o.shipment_id || ''
          ).trim();
          out.sender_id = String(o.sender_id || o.cliente_id || o.sender || '').trim() || null;
          return out;
        } catch {}
      }

      // URL con params
      if (/^https?:\/\//i.test(s)) {
        try {
          const u = new URL(s);
          out.tracking = String(
            u.searchParams.get('tracking_id') || u.searchParams.get('tracking') || u.searchParams.get('id') ||
            u.searchParams.get('id_venta') || u.searchParams.get('meli_id') || u.searchParams.get('shipment_id') || ''
          ).trim();
          out.sender_id = String(
            u.searchParams.get('sender_id') || u.searchParams.get('cliente_id') || u.searchParams.get('sender') || ''
          ).trim() || null;
          if (!out.tracking) {
            const seg = u.pathname.split('/').filter(Boolean).reverse().find(x => /^\w{5,}$/.test(x));
            if (seg) out.tracking = seg;
          }
          return out;
        } catch {}
      }

      // Plano: primer token con 5+ chars
      const m = s.match(/[\w-]{5,}/);
      out.tracking = m ? m[0] : s;
      return out;
    }

    // ===== Lista QR
    function renderListQR() {
      const tb = $('#tblQR');
      tb.innerHTML = stateQR.items.map(it => `
        <tr class="border-b border-black/10 dark:border-white/10">
          <td class="p-1">${it.tracking}${it.externo ? ' <em class="text-amber-600">(externo)</em>' : ''}</td>
          <td class="p-1">${it.cliente||''}</td>
          <td class="p-1">${it.direccion||''}</td>
          <td class="p-1">${[it.codigo_postal||'', it.partido||''].filter(Boolean).join(' ')}</td>
          <td class="p-1 text-right"><button class="text-red-600 hover:underline" data-trk="${it.tracking}">Quitar</button></td>
        </tr>
      `).join('');
      $('#countQR').textContent = `Total: ${stateQR.items.length}`;
      tb.querySelectorAll('button[data-trk]').forEach(btn=>{
        btn.onclick = () => {
          const trk = btn.getAttribute('data-trk');
          stateQR.items = stateQR.items.filter(x=>x.tracking!==trk);
          stateQR.seen.delete(trk);
          renderListQR();
        };
      });
    }

    async function addTrackingQR(payload) {
      const trk = String(payload?.tracking || '').trim();
      const sender_id = payload?.sender_id ? String(payload.sender_id) : null;
      if (!trk || stateQR.seen.has(trk)) return;

      let interno = null;
      try {
        const r = await fetch(`/api/envios/tracking/${encodeURIComponent(trk)}`, { credentials: 'same-origin' });
        if (r.ok) interno = await r.json();
      } catch {}

      if (interno) {
        if ((interno.estado || 'pendiente') !== 'pendiente') {
          alert(`Ya asignado: ${trk}`);
          return;
        }
        stateQR.seen.add(trk);
        stateQR.items.push({
          _id: interno._id,
          tracking: interno.id_venta || interno.meli_id || trk,
          cliente: interno.cliente_id?.nombre || '',
          direccion: interno.direccion || '',
          codigo_postal: interno.codigo_postal || '',
          partido: interno.partido || '',
          sender_id: interno.cliente_id?._id || sender_id || null,
          externo: false
        });
      } else {
        const nombreCli = sender_id ? (CLIENTES_MAP.get(sender_id) || `Cliente ${sender_id.slice(-4)}`) : '(externo)';
        stateQR.seen.add(trk);
        stateQR.items.push({
          _id: null,
          tracking: trk,
          cliente: nombreCli,
          direccion: '',
          codigo_postal: '',
          partido: '',
          sender_id,
          externo: true
        });
      }
      renderListQR();
    }

  async function asignarQR() {
  const chofer_id       = $('#choferSel')?.value || '';
  const lista_chofer_id = $('#listaSel')?.value || null;
  const lista_nombre    = $('#listaSel')?.selectedOptions?.[0]?.text?.trim() || '';
  const zona            = $('#inputZonaQR')?.value?.trim() || '';

  const tracking_ids = stateQR.items.map(x => x.tracking).filter(Boolean);
  const items = stateQR.items.map(x => ({ tracking: x.tracking, sender_id: x.sender_id || null }));

  const firstSender = (stateQR.items.find(x => x.sender_id) || {}).sender_id || null;

  if (!chofer_id) return alert('Eleg√≠ un chofer');
  if (!tracking_ids.length) return alert('Escane√° o peg√° al menos un tracking');
  if (!confirm(`Asignar ${tracking_ids.length} paquete(s)?`)) return;

  try {
    const r = await fetch('/api/asignaciones/qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',             // üëà asegura cookie si serv√≠s desde otro origen
      body: JSON.stringify({
        chofer_id, lista_chofer_id, lista_nombre, tracking_ids, items, zona,
        sender_id_hint: firstSender || null
      })
    });

    const raw = await r.text();           // üëà nunca explota por HTML/redirects
    let data; try { data = JSON.parse(raw) } catch { data = null }

    console.log('POST /api/asignaciones/qr ->', r.status, raw);

    if (!r.ok || !data || data.ok !== true) {
      const msg = (data && (data.error || data.detail)) || `HTTP ${r.status}`;
      alert('No se pudo asignar: ' + msg);
      return;
    }

    if (data.remito_url) { $('#btnRemito').href = data.remito_url; $('#btnRemito').classList.remove('hidden'); }
    if (data.whatsapp_url) { $('#btnWA').href = data.whatsapp_url; $('#btnWA').classList.remove('hidden'); }

    alert(`Asignados: ${data.total}`);
    stateQR.items.length = 0; stateQR.seen.clear(); renderListQR();
  } catch (e) {
    console.error('asignarQR fetch error:', e);
    alert('Error de red (revis√° consola/red de DevTools)');
  }
}

    async function cargarRemitos() {
  const p = new URLSearchParams();
  const d = $('#fDesde')?.value; const h = $('#fHasta')?.value; const c = $('#fChofer')?.value;
  if (d) p.set('desde', d);
  if (h) p.set('hasta', h);
  if (c) p.set('chofer_id', c);

  const r = await fetch('/api/asignaciones?' + p.toString(), { credentials:'include' });
  const rows = await r.json().catch(()=>[]);
  const tbody = $('#tblRemitos');
  tbody.innerHTML = rows.map(x => `
    <tr class="border-b border-black/10 dark:border-white/10">
      <td class="p-1">${new Date(x.fecha).toLocaleString()}</td>
      <td class="p-1">${x.chofer?.nombre || '-'}</td>
      <td class="p-1">${x.lista_nombre || x.zona || '-'}</td>
      <td class="p-1">${x.total_paquetes ?? x.total ?? (x.envios?.length || 0)}</td>
      <td class="p-1">${x.remito_url ? `<a class="text-blue-600 underline" href="${x.remito_url}" target="_blank" rel="noopener">Ver</a>` : '-'}</td>
    </tr>
  `).join('');
}

async function abrirHistorial() {
  // choferes para el filtro
  try {
    const res = await fetch('/api/choferes', { credentials:'include' });
    const arr = await res.json().catch(()=>[]);
    const sel = $('#fChofer');
    sel.innerHTML = `<option value="">(todos)</option>` + arr.map(c => `<option value="${c._id}">${c.nombre}</option>`).join('');
  } catch {}
  await cargarRemitos();
  $('#modalRemitos').classList.remove('hidden');
}

// eventos
document.addEventListener('DOMContentLoaded', () => {
  $('#btnOpenHist')?.addEventListener('click', abrirHistorial);
  $('#btnFiltrarRemitos')?.addEventListener('click', cargarRemitos);
});


    // ===== Init
    document.addEventListener('DOMContentLoaded', () => {
      mostrarTab('qr');
      cargarDropdowns();
      initQrScanner();
      renderListQR();
      $('#btnAsignarQR').addEventListener('click', asignarQR);
    });
  </script>
</body>
</html>
