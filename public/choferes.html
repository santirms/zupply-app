<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Choferes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
</head>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<body class="bg-gray-100 p-4">
  <div class="max-w-6xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold mb-4 text-center">Gesti√≥n de Choferes</h1>

    <!-- Tabs -->
    <div class="flex space-x-4 mb-6">
      <button onclick="mostrarTab('qr')" class="tab-btn bg-blue-600 text-white px-4 py-2 rounded">Asignaci√≥n por QR</button>
      <button onclick="mostrarTab('mapa')" class="tab-btn bg-gray-300 px-4 py-2 rounded">Asignaci√≥n desde el mapa</button>
    </div>

    <!-- Asignaci√≥n por QR -->

<div id="tab-qr" class="tab">
  <div class="grid md:grid-cols-3 gap-3 mb-3">
    <label>Chofer:
      <select id="selectChoferQR" class="border rounded w-full"></select>
    </label>
    <label>Lista (pago chofer):
      <select id="selectListaQR" class="border rounded w-full"></select>
    </label>
    </div>

  <div class="flex items-center gap-3 mb-3">
    <button id="btnStartScan" class="w-16 h-16 bg-gray-200 rounded shadow">üì∑</button>
    <input id="inpManualTrk" class="border rounded px-3 py-2" placeholder="Pegar tracking y Enter" />
    <div id="countQR" class="ml-auto text-sm text-gray-600"></div>
  </div>

  <div id="qr-reader" class="w-full max-w-xs mx-auto hidden"></div>

  <div class="bg-white border rounded p-3">
    <table class="w-full text-sm">
      <thead><tr class="border-b">
        <th class="text-left p-1">Tracking</th>
        <th class="text-left p-1">Cliente</th>
        <th class="text-left p-1">Direcci√≥n</th>
        <th class="text-left p-1">CP/Partido</th>
        <th class="text-left p-1"></th>
      </tr></thead>
      <tbody id="tblQR"></tbody>
    </table>
    <div class="mt-3 flex gap-2 justify-end">
      <a id="btnWA" class="hidden px-4 py-2 rounded bg-green-600 text-white" target="_blank" rel="noopener">WhatsApp</a>
      <a id="btnRemito" class="hidden px-4 py-2 rounded bg-gray-700 text-white" target="_blank" rel="noopener">Ver remito</a>
      <button id="btnAsignarQR" class="px-4 py-2 bg-blue-600 text-white rounded">Asignar</button>
    </div>
  </div>
</div>

    <!-- Asignaci√≥n desde el mapa -->
    <div id="tab-mapa" class="tab hidden">
    <select id="selectChoferMapa"></select>
    <select id="selectListaMapa"></select>
    <div id="mapaEnvios" class="w-full h-96 bg-gray-200 rounded mb-4"></div>
     <button class="bg-green-600 text-white px-4 py-2 rounded">Asignar Env√≠os Seleccionados</button>
    </div>

    <!-- Botones para abrir modales -->
    <div class="flex justify-between mt-6">
      <button onclick="abrirModal('modalChofer')" class="bg-indigo-600 text-white px-4 py-2 rounded">Agregar Chofer</button>
      <button onclick="abrirModal('modalRemitos')" class="bg-gray-600 text-white px-4 py-2 rounded">Historial de remitos</button>
    </div>
  </div>

  <!-- Modal Agregar Chofer -->
<div id="modalChofer" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
  <form id="formAddChofer" class="bg-white p-6 rounded shadow w-96">
    <h2 class="text-lg font-bold mb-4">Agregar Chofer</h2>
    <label>Nombre:</label>
    <input name="nombre" type="text" class="w-full border p-2 mb-2 rounded" required />
    <label>N√∫mero de Tel√©fono:</label>
    <input name="telefono" type="text" class="w-full border p-2 mb-4 rounded" required />
    <div class="text-right">
      <button type="button" onclick="cerrarModal('modalChofer')" class="mr-2 px-4 py-2 rounded bg-gray-400 text-white">
        Cancelar
      </button>
      <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white">Guardar</button>
    </div>
  </form>
</div>
  </div>

<div id="modalRemitos" class="modal hidden fixed inset-0 bg-black/50 flex items-center justify-center">
  <div class="bg-white p-4 rounded shadow w-[800px] max-h-[80vh] overflow-auto">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-lg font-bold">Historial de remitos</h2>
      <button onclick="cerrarModal('modalRemitos')">‚úï</button>
    </div>
    <div class="flex gap-2 mb-2">
      <input id="fDesde" type="date" class="border rounded px-2">
      <input id="fHasta" type="date" class="border rounded px-2">
      <select id="fChofer" class="border rounded px-2"></select>
      <button id="btnFiltrarRemitos" class="px-3 py-2 bg-blue-600 text-white rounded">Filtrar</button>
    </div>
    <table class="w-full text-sm">
      <thead><tr class="border-b">
        <th class="text-left p-1">Fecha</th><th class="text-left p-1">Chofer</th>
        <th class="text-left p-1">Zona</th><th class="text-left p-1">Total</th>
        <th class="text-left p-1">PDF</th>
      </tr></thead>
      <tbody id="tblRemitos"></tbody>
    </table>
  </div>
</div>

  <script>
    function mostrarTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.add('hidden'));
      document.getElementById(`tab-${tab}`).classList.remove('hidden');
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.replace('bg-blue-600', 'bg-gray-300'));
      event.target.classList.replace('bg-gray-300', 'bg-blue-600');
    }

    function abrirModal(id) {
      document.getElementById(id).classList.remove('hidden');
    }

    function cerrarModal(id) {
      document.getElementById(id).classList.add('hidden');
    }
  </script>
  
<!-- html5-qrcode -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
// Carga dropdowns
async function cargarDropdowns() {
  const [choferRes, listaRes] = await Promise.all([
    fetch('/api/choferes'),
    fetch('/api/listas-de-precios?prefix=Choferes')
  ]);
  const [choferes, listas] = await Promise.all([choferRes.json(), listaRes.json()]);

  const optsChofer = choferes.map(c => `<option value="${c._id}">${c.nombre}</option>`).join('');
  const optsLista  = listas.map(l => `<option value="${l._id}">${l.nombre}</option>`).join('');

  document.querySelectorAll('#selectChoferQR, #selectChoferMapa').forEach(sel => sel.innerHTML = optsChofer);
  document.querySelectorAll('#selectListaQR, #selectListaMapa').forEach(sel => sel.innerHTML  = optsLista);
}

// Lector QR
function initQrScanner() {
  const readerDiv = document.getElementById('qr-reader');
  const html5QrCode = new Html5Qrcode("qr-reader");

  let lastTrk = null, lastAt = 0;

  document.getElementById('btnStartScan').addEventListener('click', async () => {
    const visible = !readerDiv.classList.contains('hidden');
    if (visible) { await html5QrCode.stop().catch(()=>{}); readerDiv.classList.add('hidden'); return; }

    readerDiv.classList.remove('hidden');
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      msg => {
        const trk = extractTracking(msg);
        if (!trk) return;

        const now = Date.now();
        // evita spam si el mismo c√≥digo queda en c√°mara
        if (trk === lastTrk && (now - lastAt) < 1200) return;
        lastTrk = trk; lastAt = now;

        addTrackingQR(trk);
        // feedback sutil en tel√©fono
        if (navigator.vibrate) navigator.vibrate(40);
      },
      err => console.warn('QR error:', err)
    ).catch(err => { console.error('No se pudo iniciar QR:', err); readerDiv.classList.add('hidden'); });
  });
}
// Pegar tracking a mano y Enter
  document.querySelector('#inpManualTrk').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const trk = extractTracking(e.target.value);
      if (!trk) return alert('Tracking inv√°lido');
      addTrackingQR(trk);
      e.target.value = '';
    }
  });
 
// Inicializaci√≥n al cargar
document.addEventListener('DOMContentLoaded', () => {
  cargarDropdowns();
  initQrScanner();
});
// Inicializaci√≥n al cargar la p√°gina
  document.addEventListener('DOMContentLoaded', () => {
    cargarDropdowns();
    initQrScanner();
  });
</script>
  
<script>  
  // 1) Capturo el submit del form y disparo el POST
  document.getElementById('formAddChofer').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;
    const nombre   = form.nombre.value.trim();
    const telefono = form.telefono.value.trim();

    if (!nombre || !telefono) {
      return alert('Por favor complet√° nombre y tel√©fono');
    }

    try {
      const res = await fetch('/api/choferes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nombre, telefono })
      });

      if (!res.ok) {
        const errTxt = await res.text();
        throw new Error(errTxt || res.statusText);
      }

      // Limpiar el form y cerrar modal
      form.reset();
      cerrarModal('modalChofer');

      // Volver a cargar el dropdown de choferes
      await cargarDropdowns();

      alert('Chofer creado correctamente');
    } catch (err) {
      console.error('Error al crear chofer:', err);
      alert('No se pudo crear el chofer');
    }
  });

// --- Estado y helpers de la pesta√±a QR ---
const $ = s => document.querySelector(s);
const stateQR = { items: [], seen: new Set() };

function renderListQR() {
  const tb = $('#tblQR');
  tb.innerHTML = stateQR.items.map(it => `
    <tr class="border-b">
      <td class="p-1">${it.tracking}</td>
      <td class="p-1">${it.cliente||''}</td>
      <td class="p-1">${it.direccion||''}</td>
      <td class="p-1">${[it.codigo_postal||'', it.partido||''].filter(Boolean).join(' ')}</td>
      <td class="p-1 text-right"><button class="text-red-600 hover:underline" data-trk="${it.tracking}">Quitar</button></td>
    </tr>
  `).join('');
  $('#countQR').textContent = `Total: ${stateQR.items.length}`;
  tb.querySelectorAll('button[data-trk]').forEach(btn=>{
    btn.onclick = () => {
      const trk = btn.getAttribute('data-trk');
      stateQR.items = stateQR.items.filter(x=>x.tracking!==trk);
      stateQR.seen.delete(trk);
      renderListQR();
    };
  });
}

// Extrae el tracking usable (id_venta o meli_id) desde el texto del QR
function extractTracking(raw) {
  if (!raw) return '';
  const s = String(raw).trim();

  // Caso 1: JSON (como el de MeLi)
  if (s.startsWith('{') && s.endsWith('}')) {
    try {
      const obj = JSON.parse(s);
      // campos comunes
      return String(
        obj.id ||
        obj.tracking ||
        obj.tracking_id ||
        obj.id_venta ||
        obj.meli_id ||
        obj.code ||
        obj.shipment_id ||
        ''
      ).trim();
    } catch (_) {}
  }

  // Caso 2: URL con query params
  if (/^https?:\/\//i.test(s)) {
    try {
      const u = new URL(s);
      const p =
        u.searchParams.get('id') ||
        u.searchParams.get('tracking') ||
        u.searchParams.get('tracking_id') ||
        u.searchParams.get('shipment_id') ||
        u.searchParams.get('meli_id');
      if (p) return String(p).trim();

      // √∫ltimo segmento num√©rico largo
      const seg = u.pathname.split('/').filter(Boolean).reverse()
        .find(x => /^\d{5,}$/.test(x));
      if (seg) return seg;
    } catch (_) {}
  }

  // Caso 3: texto plano ‚Üí si trae un n√∫mero largo, usarlo
  const m = s.match(/\d{5,}/);
  if (m) return m[0];

  // Por defecto, devolver el string ‚Äúpelado‚Äù
  return s;
}
  
async function addTrackingQR(trk) {
  trk = (trk||'').trim();
  if (!trk || stateQR.seen.has(trk)) return;

  const r = await fetch(`/api/envios/tracking/${encodeURIComponent(trk)}`);
  if (!r.ok) {
  return alert(`No encontrado en el sistema: ${trk}`);
}
  const e = await r.json();
  if ((e.estado || 'pendiente') !== 'pendiente') return alert(`Ya asignado: ${trk}`);

  stateQR.seen.add(trk);
  stateQR.items.push({
    _id: e._id,
    tracking: e.id_venta || e.meli_id,
    cliente: e.cliente_id?.nombre,
    direccion: e.direccion,
    codigo_postal: e.codigo_postal,
    partido: e.partido
  });
  renderListQR();
}

async function asignarQR() {
  const chofer_id = $('#selectChoferQR').value;
  const listaSel  = $('#selectListaQR');
  const lista_chofer_id = listaSel.value || null;
  const lista_nombre = listaSel.options[listaSel.selectedIndex]?.textContent || '';
  const zona = $('#inputZonaQR').value.trim();
  if (!chofer_id || !stateQR.items.length) return alert('Eleg√≠ chofer y escane√° al menos un paquete');
  if (!confirm(`Asignar ${stateQR.items.length} paquetes?`)) return;

  const r = await fetch('/api/asignaciones/qr', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      chofer_id, lista_chofer_id, lista_nombre, zona,
      tracking_ids: stateQR.items.map(x=>x.tracking)
    })
  });

  let data;
  try { data = await r.json(); } catch (e) { /* puede no venir JSON si 500 crudo */ }

  if (!r.ok || !data?.ok) {
    console.error('Asignaciones/qr error:', data || await r.text());
    return alert((data && (data.error || data.message)) || 'No se pudo crear la asignaci√≥n');
  }

  // mostrar links si existen
  const btnRemito = $('#btnRemito');
  const btnWA = $('#btnWA');
  if (data.remito_url) { btnRemito.href = data.remito_url; btnRemito.classList.remove('hidden'); }
  if (data.whatsapp_url) { btnWA.href = data.whatsapp_url; btnWA.classList.remove('hidden'); }

  alert(`Asignados: ${data.total}`);
  stateQR.items.length = 0; stateQR.seen.clear(); renderListQR();
}

// Hookear al cargar
document.addEventListener('DOMContentLoaded', ()=>{
  renderListQR();
  document.getElementById('btnAsignarQR').addEventListener('click', asignarQR);
});

async function cargarRemitos() {
  const p = new URLSearchParams();
  const d = $('#fDesde').value, h = $('#fHasta').value, c = $('#fChofer').value;
  if (d) p.set('desde', d); if (h) p.set('hasta', h); if (c) p.set('chofer_id', c);
  const r = await fetch('/api/asignaciones?'+p.toString());
  const rows = await r.json();
  $('#tblRemitos').innerHTML = rows.map(x=>`
    <tr class="border-b">
      <td class="p-1">${new Date(x.fecha).toLocaleString()}</td>
      <td class="p-1">${x.chofer?.nombre||''}</td>
      <td class="p-1">${x.zona||''}</td>
      <td class="p-1">${x.total_paquetes}</td>
      <td class="p-1"><a class="text-blue-600" href="${x.remito_url}" target="_blank">Descargar</a></td>
    </tr>
  `).join('');
}
document.getElementById('btnFiltrarRemitos').onclick = cargarRemitos;

// al abrir el modal, llen√° el select de choferes
function abrirModal(id) {
  document.getElementById(id).classList.remove('hidden');
  if (id==='modalRemitos') {
    // reusar lista de choferes
    fetch('/api/choferes').then(r=>r.json()).then(arr=>{
      $('#fChofer').innerHTML = `<option value="">(todos)</option>` +
        arr.map(c=>`<option value="${c._id}">${c.nombre}</option>`).join('');
      cargarRemitos();
    });
  }
}
 
</script>


</body>
</html>
