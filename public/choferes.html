<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel de Choferes</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS (por si activÃ¡s el mapa luego) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root {
      --z-primary: #F59E0B;
      --z-primary-dark: #D97706;
      --z-primary-fg: #111827;
    }
    html.dark select, html.dark select option { background-color:#0b1020; color:#e5e7eb; }
    @media (max-width: 640px){ #btnStartScan { width:64px; height:64px; font-size:24px; } }
      /* ğŸ‘‰ Date, text, textarea */
  html.dark input[type="date"],
  html.dark input[type="text"],
  html.dark textarea {
    background-color:#0b1020;
    color:#e5e7eb;
    border-color: rgba(255,255,255,0.12);
  }
  /* Icono del picker en Chromium/WebKit */
  html.dark input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1) opacity(0.8);
  }
  </style>

  <script>
    // ====== Tema system por defecto (auto) ======
    (function () {
      const key = 'zpl_theme';
      const saved = localStorage.getItem(key) || 'system';
      const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;
      const dark = saved === 'dark' || (saved === 'system' && prefersDark);
      document.documentElement.classList.toggle('dark', dark);
      document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('themeBtn');
        if (!btn) return;
        const order = ['light', 'dark', 'system'];
        let current = saved;
        btn.textContent = 'Tema: ' + (current === 'system' ? 'auto' : current);
        btn.addEventListener('click', () => {
          current = order[(order.indexOf(current) + 1) % order.length];
          localStorage.setItem(key, current);
          const darkNow = current === 'dark' || (current === 'system' && matchMedia('(prefers-color-scheme: dark)').matches);
          document.documentElement.classList.toggle('dark', darkNow);
          btn.textContent = 'Tema: ' + (current === 'system' ? 'auto' : current);
        });
      });
    })();
  </script>
</head>

<body class="bg-slate-50 text-slate-900 dark:bg-[#0A1324] dark:text-slate-100 font-sans min-h-screen">
<div class="max-w-7xl mx-auto p-4 md:p-6">

<!-- TOPBAR (sticky/translÃºcida) -->
<header class="sticky top-0 z-40 mb-4">
  <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white/80 dark:bg-[#0B1020]/70 backdrop-blur px-4 py-3 flex items-center gap-3">
    <!-- Logo/Home -->
    <a href="/index.html" class="flex items-center gap-3" title="Inicio">
      <div class="h-8 w-8 grid place-items-center rounded" style="background:linear-gradient(135deg,#F6B64A,#F59E0B,#D97706)">
        <span class="text-white font-black">Z</span>
      </div>
      <span class="font-semibold tracking-wide text-amber-500">zupply</span>
    </a>
    <div class="ml-2 h-6 w-px bg-slate-300/70 dark:bg-white/10"></div>
    <span class="text-sm opacity-80">Panel de Choferes</span>

    <!-- Usuario + Tema -->
    <div class="ml-auto flex items-center gap-2">
      <div class="relative" id="userMenuWrap">
        <button id="userBtn"
          class="flex items-center gap-2 px-3 py-1.5 rounded-xl text-sm border border-slate-300 dark:border-white/10 bg-white hover:bg-slate-50 dark:bg-white/10 dark:hover:bg-white/15">
          <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-200/60 dark:bg-white/10">ğŸ‘¤</span>
          <span id="username" class="max-w-[160px] truncate">Usuario</span>
          <span class="opacity-70">â–¾</span>
        </button>

        <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 rounded-xl border border-slate-200 dark:border-white/10 bg-white dark:bg-[#0B1020] shadow-xl z-50">
          <div class="p-2">
            <a href="/index.html" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-white/10 text-sm">
              ğŸ  Inicio
            </a>
            <button onclick="cerrarSesion()" class="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-white/10 text-sm text-left">
             â‹  Cerrar sesiÃ³n
            </button>
          </div>
        </div>
      </div>

      <button id="themeBtn"
        class="px-3 py-1.5 rounded-xl text-sm border border-slate-300 dark:border-white/10 bg-white hover:bg-slate-50 dark:bg-white/10 dark:hover:bg-white/15">
        Tema: auto
      </button>
    </div>
  </div>
</header>

<main>
    <h1 class="text-2xl font-bold mb-6">GestiÃ³n de Choferes</h1>

    <!-- Tabs -->
    <div class="flex gap-3 mb-6">
      <button data-tab="qr"   class="tab-btn px-4 py-2 rounded-xl font-semibold shadow-sm bg-[var(--z-primary)] text-[var(--z-primary-fg)]">AsignaciÃ³n por QR</button>
      <button data-tab="mapa" class="tab-btn px-4 py-2 rounded-xl font-semibold border border-slate-300 dark:border-white/10 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700">AsignaciÃ³n desde el mapa</button>
    </div>

    <!-- TAB: QR -->
    <section id="tab-qr" class="tab">
      <div class="grid sm:grid-cols-3 gap-3 mb-3">
        <label class="text-sm">Chofer
          <select id="choferSel" class="w-full mt-1 border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-[#0B1020] text-slate-900 dark:text-slate-100"></select>
        </label>
        <label class="text-sm">Lista (pago chofer)
          <select id="listaSel" class="w-full mt-1 border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-[#0B1020] text-slate-900 dark:text-slate-100"></select>
        </label>
        <input id="inputZonaQR" type="hidden" value="">
      </div>

      <div class="flex items-center gap-3 mb-3">
        <button id="btnStartScan" class="rounded-xl bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 px-4 py-3 shadow-sm">ğŸ“·</button>
        <input id="inpManualTrk" class="flex-1 border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-[#0B1020]" placeholder="Pegar tracking y Enter" />
        <div id="countQR" class="ml-auto text-sm opacity-70"></div>
      </div>

      <div id="qr-reader" class="w-full max-w-xs mx-auto hidden"></div>

      <div class="border border-slate-200 dark:border-white/10 rounded-2xl p-4 bg-white dark:bg-white/5 shadow-sm">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-100 dark:bg-white/5">
              <tr class="border-b border-slate-200 dark:border-white/10">
                <th class="text-left p-2 font-semibold text-slate-700 dark:text-slate-300">Tracking</th>
                <th class="text-left p-2 font-semibold text-slate-700 dark:text-slate-300">Cliente</th>
                <th class="text-left p-2 font-semibold text-slate-700 dark:text-slate-300">DirecciÃ³n</th>
                <th class="text-left p-2 font-semibold text-slate-700 dark:text-slate-300">CP/Partido</th>
                <th class="text-left p-2 font-semibold text-slate-700 dark:text-slate-300"></th>
              </tr>
            </thead>
            <tbody id="tblQR" class="bg-white dark:bg-[#0B1020]"></tbody>
          </table>
        </div>
        <div class="mt-3 flex gap-2 justify-end">
          <a id="btnWA" class="hidden px-4 py-2 rounded-xl font-medium shadow-sm bg-green-600 hover:bg-green-700 text-white" target="_blank" rel="noopener">ğŸ“± WhatsApp</a>
          <a id="btnRemito" class="hidden px-4 py-2 rounded-xl font-medium shadow-sm bg-slate-700 hover:bg-slate-800 text-white" target="_blank" rel="noopener">ğŸ“„ Ver remito</a>
          <button id="btnAsignarQR" class="px-4 py-2 rounded-xl font-semibold shadow-sm bg-[var(--z-primary)] hover:bg-[var(--z-primary-dark)] text-[var(--z-primary-fg)]">Asignar</button>
        </div>
      </div>
    </section>
   
  <!-- TAB: MAPA -->
<section id="tab-mapa" class="tab hidden">
  <!-- Filtros y controles -->
  <div class="grid sm:grid-cols-3 gap-3 mb-3">
    <select id="choferSelMapa" class="border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-[#0B1020]">
      <option value="">(Elegir chofer)</option>
    </select>
    <select id="selectListaMapa" class="border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-[#0B1020]">
      <option value="">(sin lista)</option>
    </select>
    <select id="filtroEstadoMapa" class="border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-[#0B1020]">
      <option value="todos">ğŸ“¦ Todos</option>
      <option value="urgentes">ğŸ”´ Re-entregas urgentes</option>
      <option value="planta">ğŸŸ  En planta</option>
      <option value="colectados">ğŸ”µ Colectados (Flex)</option>
    </select>
  </div>

  <!-- Leyenda de colores -->
  <div class="flex flex-wrap gap-3 mb-3 text-sm">
    <div class="flex items-center gap-2">
      <div class="w-4 h-4 rounded-full" style="background:#E74C3C"></div>
      <span>Re-entregas</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-4 h-4 rounded-full" style="background:#F39C12"></div>
      <span>En planta</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-4 h-4 rounded-full" style="background:#3498DB"></div>
      <span>Colectados</span>
    </div>
    <div class="ml-auto font-semibold" id="countMapa">0 envÃ­os cargados</div>
  </div>

  <!-- Mapa Leaflet -->
  <div id="mapaMapa" class="rounded-2xl border border-slate-200 dark:border-white/10 shadow-sm" style="height:500px;"></div>

  <!-- Controles inferiores -->
  <div class="mt-3 flex items-center gap-3">
    <div class="text-sm" id="countSelMapa">0 seleccionados</div>
    <button id="btnLimpiarSelMapa" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-white/10 hover:bg-slate-50 dark:hover:bg-white/10">
      ğŸ—‘ï¸ Limpiar selecciÃ³n
    </button>
    <button id="btnAsignarMapa" class="ml-auto px-4 py-2 rounded-xl font-semibold shadow-sm bg-[var(--z-primary)] hover:bg-[var(--z-primary-dark)] text-[var(--z-primary-fg)]">
      âœ… Asignar seleccionados
    </button>
  </div>
</section>
<!-- BotÃ³n abrir modal -->
<div class="mt-6 flex justify-end">
  <button id="btnOpenHist" class="px-4 py-2 rounded-xl font-semibold shadow-sm bg-slate-700 hover:bg-slate-800 text-white">ğŸ“‹ Historial de remitos</button>
</div>

<!-- Modal Historial Remitos -->
<div id="modalRemitos" class="hidden fixed inset-0 bg-black/50 z-50 grid place-items-center p-4">
  <div class="bg-white dark:bg-[#0B1020] w-[900px] max-w-[95vw] max-h-[85vh] overflow-auto rounded-2xl border border-slate-200 dark:border-white/10 shadow-xl p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold">ğŸ“‹ Historial de remitos</h2>
      <button onclick="document.getElementById('modalRemitos').classList.add('hidden')" class="px-3 py-1.5 rounded-xl border border-slate-300 dark:border-white/10 hover:bg-slate-50 dark:hover:bg-white/10 text-xl">âœ•</button>
    </div>

    <div class="flex flex-wrap gap-3 mb-4">
      <input id="fDesde" type="date" class="border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-[#0B1020]">
      <input id="fHasta" type="date" class="border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-[#0B1020]">
      <select id="fChofer" class="border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-[#0B1020]"></select>
      <button id="btnFiltrarRemitos" class="px-4 py-2 rounded-xl font-medium shadow-sm bg-[var(--z-primary)] hover:bg-[var(--z-primary-dark)] text-[var(--z-primary-fg)]">ğŸ” Filtrar</button>
    </div>
    <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">
      ğŸ’¡ Por defecto se muestran los Ãºltimos 15 dÃ­as. CambiÃ¡ las fechas para ver mÃ¡s.
    </p>

    <div class="overflow-x-auto">
  <table class="w-full text-sm">
    <thead class="bg-slate-100 dark:bg-white/5">
      <tr class="border-b border-slate-200 dark:border-white/10">
        <th class="text-left p-2 font-semibold text-slate-700 dark:text-slate-300">Fecha</th>
        <th class="text-left p-2 font-semibold text-slate-700 dark:text-slate-300">Chofer</th>
        <th class="text-left p-2 font-semibold text-slate-700 dark:text-slate-300">Zona</th>
        <th class="text-left p-2 font-semibold text-slate-700 dark:text-slate-300">Total</th>
        <th class="text-left p-2 font-semibold text-slate-700 dark:text-slate-300">PDF</th>
        <th class="text-left p-2 font-semibold text-slate-700 dark:text-slate-300">Acciones</th>
      </tr>
    </thead>
    <tbody id="tblRemitos"></tbody>
  </table>
</div>    
<div id="editorRemito" class="mt-4 hidden"></div>
    </div>
  </div>
</div>  
  </main>

  <script>
    "use strict";

    // ===== Helpers
    const $  = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    // Estado
    const CLIENTES_MAP = new Map();
    const stateQR = { items: [], seen: new Set() };

    // ===== Tabs
    function mostrarTab(name) {
      $$('.tab').forEach(t => t.classList.add('hidden'));
      $('#tab-' + name).classList.remove('hidden');
      $$('.tab-btn').forEach(b => {
        b.classList.remove('bg-[var(--z-primary)]','text-[var(--z-primary-fg)]');
        b.classList.add('border', 'border-slate-300', 'dark:border-white/10', 'bg-slate-100', 'dark:bg-slate-800', 'hover:bg-slate-200', 'dark:hover:bg-slate-700');
        b.classList.remove('text-white');
      });
      const btn = $(`.tab-btn[data-tab="${name}"]`);
      if (btn) {
        btn.classList.remove('border', 'border-slate-300', 'dark:border-white/10', 'bg-slate-100', 'dark:bg-slate-800', 'hover:bg-slate-200', 'dark:hover:bg-slate-700');
        btn.classList.add('bg-[var(--z-primary)]','text-[var(--z-primary-fg)]');
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      $$('.tab-btn').forEach(b => b.addEventListener('click', () => mostrarTab(b.dataset.tab)));
    });

    // ===== Cargar dropdowns
    async function cargarDropdowns() {
      try {
        const [choferRes, listaRes, cliRes] = await Promise.all([
          fetch('/api/choferes', { credentials: 'include' }),
          fetch('/api/listas-de-precios?prefix=Choferes', { credentials: 'same-origin' }),
          fetch('/api/clientes', { credentials: 'same-origin' })
        ]);

        const choferesRaw = choferRes.ok ? await choferRes.json() : [];
        const choferes = choferesRaw.filter(c => c.activo !== false);
        const listas   = listaRes.ok  ? await listaRes.json()  : [];
        const clientes = cliRes.ok    ? await cliRes.json()    : [];

        // cache clientes
        CLIENTES_MAP.clear();
        for (const c of clientes) CLIENTES_MAP.set(String(c._id), c.nombre || '');

        function fillSelect(sel, arr, firstLabel) {
          if (!sel) return;
          sel.innerHTML = '';
          if (firstLabel) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = firstLabel;
            sel.appendChild(opt);
          }
          for (const it of arr) {
            const opt = document.createElement('option');
            opt.value = it._id || '';
            opt.textContent = it.nombre || '(sin nombre)';
            sel.appendChild(opt);
          }
        }

        fillSelect($('#choferSel'), choferes, '(Elegir chofer)');
        fillSelect($('#choferSelMapa'), choferes, '(Elegir chofer)');
        fillSelect($('#listaSel'), listas, '(sin lista)');
        fillSelect($('#selectListaMapa'), listas, '(sin lista)');
      } catch (e) {
        console.error('cargarDropdowns error:', e);
      }
    }

    // ===== QR Scanner
    function initQrScanner() {
      const readerDiv = $('#qr-reader');
      let scanner = null;

      $('#btnStartScan').addEventListener('click', async () => {
        // HTTPS/localhost requerido por cÃ¡mara
        if (!window.isSecureContext && location.hostname !== 'localhost') {
          alert('La cÃ¡mara requiere HTTPS o localhost.');
          return;
        }
        const visible = !readerDiv.classList.contains('hidden');
        if (visible) {
          if (scanner) await scanner.stop().catch(()=>{});
          readerDiv.classList.add('hidden');
          return;
        }
        readerDiv.classList.remove('hidden');

        try {
          scanner = new Html5Qrcode('qr-reader');
          let last='', lastAt=0;
          await scanner.start(
            { facingMode: 'environment' },
            { fps: 10, qrbox: 250 },
            (msg) => {
              const { tracking, sender_id } = extractPayload(msg);
              const now = Date.now();
              if (!tracking) return;
              if (tracking === last && now - lastAt < 1200) return;
              last = tracking; lastAt = now;
              addTrackingQR({ tracking, sender_id });
              if (navigator.vibrate) navigator.vibrate(40);
            },
            (err) => console.warn('QR error:', err)
          );
        } catch (e) {
          console.error('No se pudo iniciar QR:', e);
          alert('No se pudo iniciar la cÃ¡mara. RevisÃ¡ permisos/HTTPS.');
          readerDiv.classList.add('hidden');
        }
      });

      // Pegar a mano y Enter
      $('#inpManualTrk').addEventListener('keydown', (e) => {
        if (e.key !== 'Enter') return;
        e.preventDefault();
        const { tracking, sender_id } = extractPayload(e.target.value);
        if (!tracking) return alert('Tracking invÃ¡lido');
        addTrackingQR({ tracking, sender_id });
        e.target.value = '';
      });
    }

    // ===== Parse de payload
  function extractPayload(raw) {
  const out = { tracking: '', sender_id: null };
  if (!raw) return out;
  const s = String(raw).trim();

  // JSON
  if (s.startsWith('{') && s.endsWith('}')) {
    try {
      const o = JSON.parse(s);
      out.tracking = String(
        o.tracking_id || o.tracking || o.id || o.id_venta || o.meli_id || o.code || o.shipment_id || ''
      ).trim();
      out.sender_id = String(o.sender_id || o.cliente_id || o.sender || '').trim() || null;
      return out;
    } catch {}
  }

  // URL con params (solo por comodidad; seguimos buscando en TU base)
  if (/^https?:\/\//i.test(s)) {
    try {
      const u = new URL(s);
      out.tracking = String(
        u.searchParams.get('tracking_id') || u.searchParams.get('tracking') || u.searchParams.get('id') ||
        u.searchParams.get('id_venta') || u.searchParams.get('meli_id') || u.searchParams.get('shipment_id') || ''
      ).trim();
      out.sender_id = String(
        u.searchParams.get('sender_id') || u.searchParams.get('cliente_id') || u.searchParams.get('sender') || ''
      ).trim() || null;

      if (!out.tracking) {
        const seg = u.pathname.split('/').filter(Boolean).reverse().find(x => /^\w{5,}$/.test(x));
        if (seg) out.tracking = seg;
      }
      return out;
    } catch {}
  }

  // Plano: primer token con 5+ chars
  const m = s.match(/[\w-]{5,}/);
  out.tracking = m ? m[0] : s;
  return out;
}

    

    // ===== Lista QR
    function renderListQR() {
      const tb = $('#tblQR');
      tb.innerHTML = stateQR.items.map(it => `
        <tr class="border-b border-black/10 dark:border-white/10">
          <td class="p-1 text-slate-900 dark:text-slate-100">${it.tracking}${it.externo ? ' <em class="text-amber-600">(externo)</em>' : ''}</td>
          <td class="p-1 text-slate-900 dark:text-slate-100">${it.cliente||''}</td>
          <td class="p-1 text-slate-900 dark:text-slate-100">${it.direccion||''}</td>
          <td class="p-1 text-slate-600 dark:text-slate-400">${[it.codigo_postal||'', it.partido||''].filter(Boolean).join(' ')}</td>
          <td class="p-1 text-right text-slate-600 dark:text-slate-400"><button class="text-red-600 hover:underline" data-trk="${it.tracking}">Quitar</button></td>
        </tr>
      `).join('');
      $('#countQR').textContent = `Total: ${stateQR.items.length}`;
      tb.querySelectorAll('button[data-trk]').forEach(btn=>{
        btn.onclick = () => {
          const trk = btn.getAttribute('data-trk');
          stateQR.items = stateQR.items.filter(x=>x.tracking!==trk);
          stateQR.seen.delete(trk);
          renderListQR();
        };
      });
    }

async function addTrackingQR(payload) {
  const trk = String(payload?.tracking || '').trim();
  const sender_id = payload?.sender_id ? String(payload.sender_id) : null;
  if (!trk || stateQR.seen.has(trk)) return;

  let interno = null;
  try {
    const r = await fetch(`/api/envios/tracking/${encodeURIComponent(trk)}`, { credentials: 'same-origin' });
    if (r.ok) interno = await r.json();
  } catch {}

  if (interno && (interno.chofer || interno.chofer_id)) {
    alert(`Ya asignado a ${interno.chofer?.nombre || 'otro chofer'}: ${trk}`);
    return;
  }

  stateQR.seen.add(trk);

  if (interno) {
    stateQR.items.push({
      _id: interno._id,
      tracking: interno.id_venta || interno.meli_id || trk,
      cliente: interno.cliente_id?.nombre || '',
      direccion: interno.direccion || '',
      codigo_postal: interno.codigo_postal || '',
      partido: interno.partido || '',
      sender_id: interno.cliente_id?._id || sender_id || null,
      externo: false
    });
  } else {
    const nombreCli = sender_id ? (CLIENTES_MAP.get(sender_id) || `Cliente ${sender_id.slice(-4)}`) : '(externo)';
    stateQR.items.push({
      _id: null,
      tracking: trk,
      cliente: nombreCli,
      direccion: '',
      codigo_postal: '',
      partido: '',
      sender_id,
      externo: true
    });
  }

  renderListQR();
}


  async function asignarQR() {
  const chofer_id       = $('#choferSel')?.value || '';
  const lista_chofer_id = $('#listaSel')?.value || null;
  const lista_nombre    = $('#listaSel')?.selectedOptions?.[0]?.text?.trim() || '';
  const zona            = $('#inputZonaQR')?.value?.trim() || '';

  const tracking_ids = stateQR.items.map(x => x.tracking).filter(Boolean);
  const items = stateQR.items.map(x => ({ tracking: x.tracking, sender_id: x.sender_id || null }));

  const firstSender = (stateQR.items.find(x => x.sender_id) || {}).sender_id || null;

  if (!chofer_id) return alert('ElegÃ­ un chofer');
  if (!tracking_ids.length) return alert('EscaneÃ¡ o pegÃ¡ al menos un tracking');
  if (!confirm(`Asignar ${tracking_ids.length} paquete(s)?`)) return;

  try {
    const r = await fetch('/api/asignaciones/qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',             // ğŸ‘ˆ asegura cookie si servÃ­s desde otro origen
      body: JSON.stringify({
        chofer_id, lista_chofer_id, lista_nombre, tracking_ids, items, zona,
        sender_id_hint: firstSender || null
      })
    });

    const raw = await r.text();           // ğŸ‘ˆ nunca explota por HTML/redirects
    let data; try { data = JSON.parse(raw) } catch { data = null }

    console.log('POST /api/asignaciones/qr ->', r.status, raw);

    if (!r.ok || !data || data.ok !== true) {
      const msg = (data && (data.error || data.detail)) || `HTTP ${r.status}`;
      alert('No se pudo asignar: ' + msg);
      return;
    }

    if (data.remito_url) { $('#btnRemito').href = data.remito_url; $('#btnRemito').classList.remove('hidden'); }
    if (data.whatsapp_url) { $('#btnWA').href = data.whatsapp_url; $('#btnWA').classList.remove('hidden'); }

    alert(`Asignados: ${data.total}`);
    stateQR.items.length = 0; stateQR.seen.clear(); renderListQR();
  } catch (e) {
    console.error('asignarQR fetch error:', e);
    alert('Error de red (revisÃ¡ consola/red de DevTools)');
  }
}

async function cargarRemitos() {
  const p = new URLSearchParams();
  const d = $('#fDesde')?.value; const h = $('#fHasta')?.value; const c = $('#fChofer')?.value;
  if (d) p.set('desde', d);
  if (h) p.set('hasta', h);
  if (c) p.set('chofer_id', c);

  const r = await fetch('/api/asignaciones?' + p.toString(), { credentials:'include' });
  const rows = await r.json().catch(()=>[]);
  const tbody = $('#tblRemitos');

  const tz  = 'America/Argentina/Buenos_Aires';
  const fmt = iso => new Date(iso).toLocaleString('es-AR', { timeZone: tz });

  tbody.innerHTML = rows.map(x => `
    <tr class="border-b border-black/10 dark:border-white/10">
      <td class="p-1">${fmt(x.fecha)}</td>
      <td class="p-1">${x.chofer?.nombre || '-'}</td>
      <td class="p-1">${x.lista_nombre || x.zona || '-'}</td>
      <td class="p-1">${x.total_paquetes ?? x.total ?? (x.envios?.length || 0)}</td>
      <td class="p-1">
        ${x.remito_url ? `<a class="text-blue-600 underline" href="${x.remito_url}" target="_blank" rel="noopener">Ver</a>` : '-'}
      </td>
      <td class="p-1">
        <div class="flex gap-2">
          <button class="px-3 py-1.5 rounded-xl bg-[var(--z-primary)] hover:bg-[var(--z-primary-dark)] text-[var(--z-primary-fg)] font-medium shadow-sm" data-edit="${x._id}">âœï¸ Editar</button>
          <button class="px-3 py-1.5 rounded-xl bg-red-600 hover:bg-red-700 text-white font-medium shadow-sm" data-del="${x._id}">ğŸ—‘ï¸ Eliminar</button>
        </div>
      </td>
    </tr>
  `).join('');

  // bind Editar
  tbody.querySelectorAll('button[data-edit]').forEach(b=>{
    b.onclick = () => abrirEditorRemito(b.getAttribute('data-edit'));
  });

  // bind Eliminar (revertir = true)
  tbody.querySelectorAll('button[data-del]').forEach(b=>{
    b.onclick = async () => {
      const id = b.getAttribute('data-del');
      if (!confirm('Â¿Eliminar este remito y revertir envÃ­os a "pendiente"?')) return;
      try {
        const r = await fetch(`/api/asignaciones/${id}?force=true`, { method:'DELETE', credentials:'include' });
        const data = await r.json().catch(()=>null);
        if (!r.ok || !data || data.ok !== true) throw new Error((data && (data.error || data.detail)) || `HTTP ${r.status}`);
        if (editorState.asgId === id) {
          editorState.asgId = null;
          $('#editorRemito')?.classList.add('hidden');
        }
        await cargarRemitos();
        alert('Remito eliminado.');
      } catch (e) {
        alert('No se pudo eliminar: ' + e.message);
      }
    };
  });
}


async function abrirHistorial() {
  // Setear fechas por defecto: Ãºltimos 15 dÃ­as
  const hoy = new Date();
  const hace15dias = new Date(hoy);
  hace15dias.setDate(hoy.getDate() - 15);

  const fDesde = $('#fDesde');
  const fHasta = $('#fHasta');

  if (fDesde) fDesde.valueAsDate = hace15dias;
  if (fHasta) fHasta.valueAsDate = hoy;

  // Cargar choferes para el filtro
  try {
    const res = await fetch('/api/choferes', { credentials:'include' });
    const arr = await res.json().catch(()=>[]);
    const activos = arr.filter(c => c.activo !== false);
    const sel = $('#fChofer');
    sel.innerHTML = `<option value="">(todos)</option>` + activos.map(c => `<option value="${c._id}">${c.nombre}</option>`).join('');
  } catch {}

  // Cargar remitos con filtro de Ãºltimos 15 dÃ­as
  await cargarRemitos();
  $('#modalRemitos').classList.remove('hidden');
}

// ===== Editor Remito =====
const editorState = { asgId:null, rows:[], selected:new Set(), choferes:[] };

async function abrirEditorRemito(asgId) {
  editorState.asgId = asgId;
  // cargar choferes (si no los tenemos aÃºn)
  if (!editorState.choferes.length) {
    try {
      const r = await fetch('/api/choferes', { credentials:'include' });
      editorState.choferes = r.ok ? (await r.json()).filter(c => c.activo !== false) : [];
    } catch {}
  }
  await recargarEditor();
  // scrollear hasta el editor
  document.getElementById('editorRemito').scrollIntoView({ behavior:'smooth', block:'start' });
}

async function recargarEditor() {
  const wrap = document.getElementById('editorRemito');
  wrap.classList.remove('hidden');
  wrap.innerHTML = `<div class="p-6 rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 shadow-sm">Cargando...</div>`;

  let det = null;
  try {
    const r = await fetch(`/api/asignaciones/${editorState.asgId}`, { credentials:'include' });
    det = r.ok ? (await r.json()) : null;
  } catch {}
  if (!det) {
    wrap.innerHTML = `<div class="p-3 rounded border bg-red-50 dark:bg-red-900/20">No se pudo cargar el remito.</div>`;
    return;
  }

  // Construyo un mapa por tracking desde envios_raw (siempre presente desde el patch)
  const byTrk = new Map();
  (det.envios_raw || []).forEach(x => {
    if (!x || !x.tracking) return;
    byTrk.set(x.tracking, {
      tracking: x.tracking,
      externo: !!x.externo,
      cliente: '',
      direccion: x.direccion || '',
      cp: x.codigo_postal || '',
      partido: x.partido || ''
    });
  });

  // Enriquezco con envios_resueltos (si existen)
  (det.envios_resueltos || det.envios || []).forEach(e => {
    const t = String(e.id_venta || e.meli_id || '').trim();
    if (!t) return;
    const row = byTrk.get(t) || { tracking:t, externo:false };
    row.cliente   = e.cliente_id?.nombre || row.cliente || '';
    row.direccion = e.direccion || row.direccion || '';
    row.cp        = e.codigo_postal || row.cp || '';
    row.partido   = e.partido || row.partido || '';
    row.externo   = !!row.externo; // preferir flag de raw
    byTrk.set(t, row);
  });

  editorState.rows = Array.from(byTrk.values());
  editorState.selected.clear();

  const selChoferOptions = editorState.choferes.map(c => `<option value="${c._id}">${c.nombre || '(sin nombre)'}</option>`).join('');

  wrap.innerHTML = `
    <div class="p-6 rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 shadow-sm">
      <div class="flex items-start gap-3 flex-wrap">
        <div class="flex-1 min-w-[280px]">
          <h3 class="text-lg font-bold mb-1">Editar remito</h3>
          <div class="text-sm opacity-70">ID: ${det._id} â€” ${new Date(det.fecha).toLocaleString()}</div>
          <div class="text-sm opacity-70 mb-2">Chofer: ${det.chofer?.nombre || '-'}</div>
          <div class="flex items-center gap-2 mb-3">
            ${det.remito_url ? `<a class="px-3 py-1.5 rounded-xl bg-slate-700 hover:bg-slate-800 text-white font-medium shadow-sm" href="${det.remito_url}" target="_blank" rel="noopener">ğŸ“„ Ver PDF</a>` : ''}
            <button id="btnRefrescarEditor" class="px-3 py-1.5 rounded-xl border border-slate-300 dark:border-white/10 hover:bg-slate-50 dark:hover:bg-white/10">ğŸ”„ Refrescar</button>
            <div class="flex items-center gap-3 mt-2">
           <label class="inline-flex items-center gap-2 text-sm">
           <input type="checkbox" id="chkForceDelete" checked>
           Revertir envÃ­os a "pendiente"
           </label>
           <button id="btnEliminarRemito" class="px-3 py-1.5 rounded-xl bg-red-700 hover:bg-red-800 text-white font-medium shadow-sm">
           ğŸ—‘ï¸ Eliminar remito
         </button>
         </div>
          </div>
        </div>
        <div class="flex-1 min-w-[280px]">
          <label class="text-sm block mb-1">Mover seleccionados a:</label>
          <div class="flex gap-2">
            <select id="selChoferDestino" class="border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 flex-1 bg-white dark:bg-[#0B1020]">${selChoferOptions}</select>
            <button id="btnMover" class="px-3 py-2 rounded-xl bg-[var(--z-primary)] hover:bg-[var(--z-primary-dark)] text-[var(--z-primary-fg)] font-medium shadow-sm">â¡ï¸ Mover</button>
          </div>
        </div>
        <div class="flex-1 min-w-[280px]">
          <label class="text-sm block mb-1">Quitar seleccionados</label>
          <button id="btnQuitar" class="px-3 py-2 rounded-xl bg-red-600 hover:bg-red-700 text-white font-medium shadow-sm">ğŸ—‘ï¸ Quitar</button>
        </div>
      </div>

      <div class="mt-3">
        <label class="text-sm block mb-1">Agregar trackings (separÃ¡ por coma, espacio o nueva lÃ­nea)</label>
        <div class="flex gap-2">
          <textarea id="txtAgregar" class="border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 flex-1 bg-white dark:bg-[#0B1020]" rows="2" placeholder="4548..., 12345..."></textarea>
          <button id="btnAgregar" class="px-3 py-2 rounded-xl bg-green-600 hover:bg-green-700 text-white font-medium shadow-sm">â• Agregar</button>
        </div>
      </div>

      <div class="mt-4 overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-black/10 dark:border-white/10">
              <th class="p-1"><input type="checkbox" id="chkAll"></th>
              <th class="text-left p-1">Tracking</th>
              <th class="text-left p-1">Cliente</th>
              <th class="text-left p-1">DirecciÃ³n</th>
              <th class="text-left p-1">CP/Partido</th>
              <th class="text-left p-1">Tipo</th>
            </tr>
          </thead>
          <tbody id="tbEditor"></tbody>
        </table>
      </div>
    </div>
  `;

  renderTablaEditor();

  // Eventos
  document.getElementById('btnRefrescarEditor').onclick = recargarEditor;
  document.getElementById('btnMover').onclick = moverSeleccionados;
  document.getElementById('btnQuitar').onclick = quitarSeleccionados;
  document.getElementById('btnAgregar').onclick = agregarTrackingsEditor;
  document.getElementById('btnEliminarRemito').onclick = eliminarRemito;
  document.getElementById('chkAll').onchange = (e) => {
    if (e.target.checked) {
      editorState.rows.forEach(r => editorState.selected.add(r.tracking));
    } else {
      editorState.selected.clear();
    }
    renderTablaEditor();
  };
}

function renderTablaEditor() {
  const tb = document.getElementById('tbEditor');
  tb.innerHTML = editorState.rows.map(r => `
    <tr class="border-b border-black/10 dark:border-white/10">
      <td class="p-1">
        <input type="checkbox" data-trk="${r.tracking}" ${editorState.selected.has(r.tracking)?'checked':''}>
      </td>
      <td class="p-1 font-mono">${r.tracking}</td>
      <td class="p-1">${r.cliente || ''}</td>
      <td class="p-1">${r.direccion || ''}</td>
      <td class="p-1">${[r.cp||'', r.partido||''].filter(Boolean).join(' ')}</td>
      <td class="p-1">${r.externo ? '<span class="text-amber-600">externo</span>' : 'interno'}</td>
    </tr>
  `).join('');

  tb.querySelectorAll('input[type="checkbox"][data-trk]').forEach(chk => {
    chk.onchange = () => {
      const t = chk.getAttribute('data-trk');
      if (chk.checked) editorState.selected.add(t);
      else editorState.selected.delete(t);
    };
  });
}

function getSelectedTrackings() {
  return Array.from(editorState.selected.values()).filter(Boolean);
}

async function moverSeleccionados() {
  const tracking_ids = getSelectedTrackings();
  const chofer_destino = document.getElementById('selChoferDestino')?.value || '';
  if (!tracking_ids.length) return alert('SeleccionÃ¡ al menos un paquete.');
  if (!chofer_destino) return alert('ElegÃ­ chofer destino.');
  if (!confirm(`Mover ${tracking_ids.length} paquete(s)?`)) return;

  try {
    const r = await fetch(`/api/asignaciones/${editorState.asgId}/move`, {
      method:'PATCH',
      headers:{ 'Content-Type':'application/json' },
      credentials:'include',
      body: JSON.stringify({ tracking_ids, chofer_destino })
    });
    const data = await r.json();
    if (!r.ok || !data || data.ok !== true) {
      throw new Error((data && (data.error || data.detail)) || `HTTP ${r.status}`);
    }
    alert('Movido con Ã©xito.');
    await recargarEditor();
    await cargarRemitos(); // refresca la grilla superior
  } catch (e) {
    console.error('moverSeleccionados', e);
    alert('No se pudo mover: ' + e.message);
  }
}

async function quitarSeleccionados() {
  const tracking_ids = getSelectedTrackings();
  if (!tracking_ids.length) return alert('SeleccionÃ¡ al menos un paquete.');
  if (!confirm(`Quitar ${tracking_ids.length} paquete(s) del remito?`)) return;

  try {
    const r = await fetch(`/api/asignaciones/${editorState.asgId}/remove`, {
      method:'PATCH',
      headers:{ 'Content-Type':'application/json' },
      credentials:'include',
      body: JSON.stringify({ tracking_ids })
    });
    const data = await r.json();
    if (!r.ok || !data || data.ok !== true) {
      throw new Error((data && (data.error || data.detail)) || `HTTP ${r.status}`);
    }
    alert('Quitado con Ã©xito.');
    await recargarEditor();
    await cargarRemitos();
  } catch (e) {
    console.error('quitarSeleccionados', e);
    alert('No se pudo quitar: ' + e.message);
  }
}

function parseTrackingsInput(s) {
  return (s || '')
    .split(/[\s,;]+/)
    .map(x => x.trim())
    .filter(Boolean);
}

async function agregarTrackingsEditor() {
  const raw = document.getElementById('txtAgregar')?.value || '';
  const tracking_ids = parseTrackingsInput(raw);
  if (!tracking_ids.length) return alert('IngresÃ¡ al menos un tracking.');
  // Opcional: podrÃ­as permitir elegir un cliente_id aquÃ­ si querÃ©s que los externos queden con cliente preseleccionado
  try {
    const r = await fetch(`/api/asignaciones/${editorState.asgId}/add`, {
      method:'PATCH',
      headers:{ 'Content-Type':'application/json' },
      credentials:'include',
      body: JSON.stringify({ tracking_ids, force_move: true })
    });
    const data = await r.json();
    if (!r.ok || !data || data.ok !== true) {
      throw new Error((data && (data.error || data.detail)) || `HTTP ${r.status}`);
    }
    document.getElementById('txtAgregar').value = '';
    alert(`Agregados: ${data.agregados} (externos: ${data.externos})`);
    await recargarEditor();
    await cargarRemitos();
  } catch (e) {
    console.error('agregarTrackingsEditor', e);
    alert('No se pudo agregar: ' + e.message);
  }
}

async function eliminarRemito() {
  const force = document.getElementById('chkForceDelete')?.checked;
  const msg = `Â¿Eliminar este remito${force ? ' y revertir los envÃ­os a "pendiente"' : ''}?`;
  if (!confirm(msg)) return;

  try {
    const r = await fetch(`/api/asignaciones/${editorState.asgId}?force=${force ? 'true' : 'false'}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    const data = await r.json().catch(()=>null);
    if (!r.ok || !data || data.ok !== true) {
      throw new Error((data && (data.error || data.detail)) || `HTTP ${r.status}`);
    }
    alert('Remito eliminado.');
    // limpiar editor y refrescar listado del modal
    document.getElementById('editorRemito').classList.add('hidden');
    editorState.asgId = null;
    await cargarRemitos();
  } catch (e) {
    console.error('eliminarRemito', e);
    alert('No se pudo eliminar: ' + e.message);
  }
}
    
// eventos
document.addEventListener('DOMContentLoaded', () => {
  $('#btnOpenHist')?.addEventListener('click', abrirHistorial);
  $('#btnFiltrarRemitos')?.addEventListener('click', cargarRemitos);
});

    // ===== Init
    document.addEventListener('DOMContentLoaded', () => {
      mostrarTab('qr');
      cargarDropdowns();
      initQrScanner();
      renderListQR();
      $('#btnAsignarQR').addEventListener('click', asignarQR);
    });

    // ===== MenÃº de usuario =====
    async function initUserMenu() {
      const userBtn = document.getElementById('userBtn');
      const userMenu = document.getElementById('userMenu');
      const usernameSpan = document.getElementById('username');

      // Cargar datos del usuario
      try {
        const res = await fetch('/api/auth/me', { credentials: 'same-origin' });
        if (res.ok) {
          const user = await res.json();
          console.log('Usuario cargado:', user); // DEBUG
          if (usernameSpan) {
            // Priorizar email sobre nombre
            usernameSpan.textContent = user.email || user.name || user.nombre || 'Usuario';
            console.log('Username actualizado a:', usernameSpan.textContent); // DEBUG
          } else {
            console.error('No se encontrÃ³ el elemento #username');
          }
        } else {
          console.error('Error en /api/me:', res.status);
        }
      } catch (e) {
        console.error('Error cargando usuario:', e);
      }

      // Toggle menÃº
      if (userBtn && userMenu) {
        userBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          userMenu.classList.toggle('hidden');
        });

        // Cerrar al hacer click fuera
        document.addEventListener('click', () => {
          userMenu.classList.add('hidden');
        });

        userMenu.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }
    }

    function cerrarSesion() {
      if (confirm('Â¿Cerrar sesiÃ³n?')) {
        window.location.href = '/logout';
      }
    }

    // Ejecutar al cargar
    document.addEventListener('DOMContentLoaded', () => {
      initUserMenu();
    });
  </script>

  </main>
</div> <!-- cierre de max-w-7xl -->
</body>
</html>
