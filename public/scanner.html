<!DOCTYPE html>
<html lang="es" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zupply ‚Ä¢ Esc√°ner de Paquetes</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Carga html5-qrcode con fallback -->
  <script>
    (function loadHtml5QR() {
      const urls = [
        "/libs/html5-qrcode.min.js",
        "https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js",
        "https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js",
      ];
      (function tryNext(i){
        if(i>=urls.length) return console.warn("html5-qrcode no disponible");
        const s=document.createElement("script");
        s.defer=true; s.crossOrigin="anonymous"; s.src=urls[i];
        s.onload=()=>console.log("html5-qrcode OK", urls[i]);
        s.onerror=()=>{ console.warn("fall√≥", urls[i]); tryNext(i+1); };
        document.head.appendChild(s);
      })(0);
    })();
  </script>

  <style>
    /* Overlay de ayuda */
    #reader { position: relative; }
    .scan-overlay{
      --qrbox-size: 320px;
      position:absolute; inset:0; pointer-events:none;
      display:grid; place-items:center; z-index:50;
    }
    .reticle{
      width:var(--qrbox-size); height:var(--qrbox-size);
      border:2px solid rgba(255,255,255,.7); border-radius:16px;
      box-shadow:0 0 0 100vmax rgba(0,0,0,.35); position:relative; overflow:hidden;
    }
    .reticle:after{
      content:""; position:absolute; inset:0; border-radius:16px; border:2px solid rgba(0,255,128,.25);
      clip-path: polygon(0 0, 14% 0, 14% 2px, 2px 2px, 2px 14%, 0 14%, 0 0,
                         86% 0, 100% 0, 100% 14%, 98% 14%, 98% 2px, 86% 2px, 86% 0,
                         100% 86%, 100% 100%, 86% 100%, 86% 98%, 98% 98%, 98% 86%, 100% 86%,
                         0 86%, 0 100%, 14% 100%, 14% 98%, 2px 98%, 2px 86%, 0 86%);
    }
    .scanline{position:absolute;left:0;right:0;height:2px;top:0;
      background:linear-gradient(to right,transparent,rgba(0,255,128,.9),transparent);
      animation:scan 2.4s linear infinite;}
    @keyframes scan{0%{transform:translateY(8px)}50%{transform:translateY(calc(var(--qrbox-size) - 10px))}100%{transform:translateY(8px)}}
    .hit-pulse{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;z-index:60}
    .hit-pulse .ring{width:32px;height:32px;border:3px solid #22c55e;border-radius:999px;opacity:0;transform:scale(.2);
      animation:pulse .6s ease-out forwards; box-shadow:0 0 16px rgba(34,197,94,.6)}
    @keyframes pulse{to{opacity:0;transform:scale(8)}}
  </style>
</head>
<body class="bg-[#0A0D16] text-gray-100">

  <!-- Topbar -->
  <header class="sticky top-0 z-40 border-b border-white/10 bg-[#0B1020]/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="/index.html" class="flex items-center gap-3 group">
        <div class="h-8 w-8 grid place-items-center rounded"
             style="background:linear-gradient(135deg,#FFB74D,#FF9800,#F57C00)">
          <span class="text-white font-black">Z</span>
        </div>
        <div class="font-semibold tracking-wide text-[#FF9800]">zupply</div>
      </a>
      <a href="/index.html"
         class="px-3 py-1.5 rounded-xl text-sm border border-white/10 hover:bg-white/[0.06]">üè† Home</a>

      <div class="ml-auto flex items-center gap-2">
        <button id="themeBtn"
          class="px-3 py-1.5 rounded-xl text-sm border border-white/10 hover:bg-white/[0.06]">
          Tema: auto
        </button>

        <!-- Men√∫ usuario -->
        <div class="relative">
          <button id="userBtn"
                  class="flex items-center gap-2 px-3 py-1.5 rounded-xl text-sm border border-white/10 hover:bg-white/[0.06]">
            <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-white/10">üë§</span>
            <span id="uName" class="max-w-[140px] truncate">Usuario</span>
            <span class="opacity-70">‚ñæ</span>
          </button>
          <div id="userMenu"
               class="hidden absolute right-0 mt-2 w-56 rounded-2xl border border-white/10 bg-[#0B1020]/90 backdrop-blur p-1 shadow-lg">
            <a href="/index.html" class="block px-3 py-2 rounded-xl hover:bg-white/10 text-sm">üè† Volver al inicio</a>
            <div class="my-1 h-px bg-white/10"></div>
            <button id="logoutBtn" class="w-full text-left px-3 py-2 rounded-xl hover:bg-white/10 text-sm">‚éã Cerrar sesi√≥n</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Body -->
  <main class="max-w-3xl mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold">üì¶ Esc√°ner de Paquetes</h1>

    <!-- Modo -->
    <div class="mt-4 flex flex-wrap items-center gap-6 text-sm">
      <label class="inline-flex items-center gap-2">
        <input type="radio" name="modoScan" value="camara" checked />
        <span>Usar c√°mara</span>
      </label>
      <label class="inline-flex items-center gap-2">
        <input type="radio" name="modoScan" value="teclado" />
        <span>Usar lector USB / teclado</span>
      </label>
    </div>

    <!-- C√°mara -->
    <section id="camaraContainer" class="mt-4">
      <div class="rounded-2xl border border-white/10 bg-white/[0.02] p-4">
        <div class="flex flex-wrap items-center gap-2 mb-3">
          <button id="startBtn" class="bg-[#FF9800] text-white px-4 py-2 rounded-2xl hover:bg-[#F57C00]">Iniciar c√°mara</button>
          <button id="stopBtn"  class="px-4 py-2 rounded-2xl border border-white/10 hover:bg-white/[0.06]" disabled>Detener</button>
        </div>

        <div id="reader" class="rounded-xl overflow-hidden border border-white/10 relative"></div>
        <p id="status" class="text-center text-sm text-gray-300 mt-2">
          Listo. Aline√° el c√≥digo en el recuadro y manten√© 15‚Äì25 cm.
        </p>
      </div>
    </section>

    <!-- Lector / teclado -->
    <section id="tecladoContainer" class="mt-4 hidden">
      <div class="rounded-2xl border border-white/10 bg-white/[0.02] p-4">
        <p class="text-sm text-gray-300 mb-2">
          Peg√° el contenido del QR y presion√° Enter.
        </p>
        <input id="scannerInput"
               class="w-full bg-transparent border border-white/10 rounded-xl px-3 py-2"
               placeholder='{"id":"...","sender_id":123,"hash_code":"..."}' />
      </div>
    </section>

    <!-- Resultados -->
    <h2 class="text-xl font-semibold mt-8 mb-3 text-center">Paquetes escaneados</h2>
    <div id="scanList" class="grid gap-3"></div>
  </main>

  <script src="/js/escanear.js" defer></script>

  <!-- Tema + usuario (mismo comportamiento que el resto) -->
  <script>
    (function themeInit(){
      function applyTheme(mode){
        const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;
        const wantDark = mode==='dark' || (mode==='system' && prefersDark);
        document.documentElement.classList.toggle('dark', wantDark);
        localStorage.setItem('zpl_theme', mode);
        document.getElementById('themeBtn').textContent = 'Tema: ' + (mode==='system'?'auto':mode);
      }
      const saved = localStorage.getItem('zpl_theme') || 'system';
      applyTheme(saved);
      document.getElementById('themeBtn').onclick = () => {
        const order = ['light','dark','system'];
        const cur = localStorage.getItem('zpl_theme') || 'system';
        const next = order[(order.indexOf(cur)+1)%order.length];
        applyTheme(next);
      };
    })();

    (function userMenu(){
      const btn = document.getElementById('userBtn');
      const menu = document.getElementById('userMenu');
      btn.addEventListener('click', ()=> menu.classList.toggle('hidden'));
      document.getElementById('logoutBtn').onclick = ()=>{ try{ localStorage.removeItem('zpl_auth'); }catch{} location.href='/auth/login'; };
      // intenta mostrar email si /me existe
      fetch('/me').then(r=>r.ok?r.json():null).then(m=>{ if(m?.email) document.getElementById('uName').textContent = m.email; }).catch(()=>{});
      document.addEventListener('click', (e)=>{ if(!btn.contains(e.target) && !menu.contains(e.target)) menu.classList.add('hidden'); });
    })();
  </script>
</body>
</html>
