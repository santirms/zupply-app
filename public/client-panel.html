<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Zupply | Panel Cliente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script>window.tailwind=window.tailwind||{};window.tailwind.config={darkMode:"class"};</script>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    (function(){
      try{
        const saved=localStorage.getItem('zpl_theme');
        const prefersDark=matchMedia('(prefers-color-scheme: dark)').matches;
        const wantDark=(saved==='dark')||((!saved||saved==='system')&&prefersDark);
        document.documentElement.classList.toggle('dark',wantDark);
        if(!saved) localStorage.setItem('zpl_theme','system');
      }catch{}
    })();
  </script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>

  <style>
    :root{ --z-primary:#F59E0B; --z-primary-dark:#D97706; --z-primary-fg:#111827; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-[#0A1324] dark:text-slate-100 font-sans min-h-screen">
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <!-- TOPBAR (mismo estilo que tu esc√°ner) -->
    <header class="sticky top-0 z-40 mb-4">
      <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white/80 dark:bg-[#0B1020]/70 backdrop-blur px-4 py-3 flex items-center gap-3">
        <a href="/index.html" class="flex items-center gap-3" title="Inicio">
          <div class="h-8 w-8 grid place-items-center rounded" style="background:linear-gradient(135deg,#F6B64A,#F59E0B,#D97706)"><span class="text-white font-black">Z</span></div>
          <span class="sm:hidden font-semibold tracking-wide text-amber-500">zupply</span>
          <img src="/assets/logo-zupply.svg" class="h-5 hidden sm:block" onerror="this.remove()">
        </a>
        <div class="ml-2 h-6 w-px bg-slate-300/70 dark:bg-white/10"></div>
        <span class="text-sm opacity-80">Panel Cliente</span>

        <div class="ml-auto flex items-center gap-2">
          <div class="relative" id="userMenuWrap">
            <button id="userBtn" class="flex items-center gap-2 px-3 py-1.5 rounded-xl text-sm border border-slate-300 dark:border-white/10 bg-white hover:bg-slate-50 dark:bg-white/10 dark:hover:bg-white/15">
              <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-200/60 dark:bg-white/10">üë§</span>
              <span id="username" class="max-w-[160px] truncate">Usuario</span>
              <span class="opacity-70">‚ñæ</span>
            </button>
            <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-[#0B1020]/90 backdrop-blur p-1 shadow-lg">
              <a href="/index.html" class="block w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 dark:hover:bg-white/10 text-sm">üè† Volver al inicio</a>
              <div class="my-1 h-px bg-slate-200 dark:bg-white/10"></div>
              <button id="logoutBtn" class="w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 dark:hover:bg-white/10 text-sm">‚éã Cerrar sesi√≥n</button>
            </div>
          </div>

          <button id="themeBtn" class="px-3 py-1.5 rounded-xl text-sm border border-slate-300 dark:border-white/10 bg-white hover:bg-slate-50 text-slate-700 dark:bg-white/10 dark:hover:bg-white/15 dark:text-slate-100">Tema: auto</button>
        </div>
      </div>
    </header>

    <main class="space-y-6">
      <!-- Tabs -->
      <div class="flex gap-2">
        <button id="tabTabla" class="px-3 py-2 rounded-xl bg-[var(--z-primary)] text-[var(--z-primary-fg)] font-medium">Tabla</button>
        <button id="tabMapa"  class="px-3 py-2 rounded-xl border border-slate-300 dark:border-white/10">Mapa</button>
        <a href="ingreso-manual.html"
          class="px-3 py-2 rounded-xl bg-green-500 hover:bg-green-600 text-white font-medium transition-colors flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          Crear env√≠o
        </a>
        <div class="ml-auto flex gap-2">
          <input id="fDesde" type="date" class="px-2 py-1 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-white/10 text-sm">
          <input id="fHasta" type="date" class="px-2 py-1 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-white/10 text-sm">
          <select id="fEstado" class="px-2 py-1 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-white/10 text-sm">
            <option value="">Todos</option>
            <option value="pendiente">Pendiente</option>
            <option value="en_camino">En camino</option>
            <option value="entregado">Entregado</option>
            <option value="incidencia">Incidencia</option>
            <option value="reprogramado">Reprogramado</option>
          </select>
          <button id="btnFiltrar" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-white/10">Filtrar</button>
        </div>
      </div>

      <!-- Tabla -->
      <section id="vistaTabla" class="rounded-2xl border border-slate-200 dark:border-white/15 bg-white dark:bg-white/5 p-3">
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-left text-slate-500">
              <tr>
                <th class="p-2">Identificador</th>
                <th class="p-2">Fecha</th>
                <th class="p-2">Destinatario</th>
                <th class="p-2">Partido</th>
                <th class="p-2">Estado</th>
              </tr>
            </thead>
            <tbody id="tbodyCliente" class="divide-y divide-slate-100 dark:divide-white/10"></tbody>
          </table>
        </div>
        <div class="flex justify-between items-center mt-3">
          <button id="prevPage" class="px-3 py-1.5 rounded-xl border border-slate-300 dark:border-white/10">Anterior</button>
          <span id="pageInfo" class="text-xs opacity-70"></span>
          <button id="nextPage" class="px-3 py-1.5 rounded-xl border border-slate-300 dark:border-white/10">Siguiente</button>
        </div>
      </section>

      <!-- Mapa -->
      <section id="vistaMapa" class="hidden rounded-2xl border border-slate-200 dark:border-white/15 bg-white dark:bg-white/5 p-3">
        <div id="mapCliente" class="w-full h-[70vh] rounded-xl"></div>
      </section>
    </main>

    <footer class="py-6 text-center text-xs opacity-60">¬© <span id="anio"></span> Zupply</footer>
  </div>

  <!-- Modal de detalle del env√≠o -->
  <div id="modalDetalleEnvio" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-[#0B1020] rounded-2xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto p-6 border border-slate-200 dark:border-white/10">
      <!-- Header -->
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-100">Detalle del env√≠o</h2>
        <button onclick="cerrarModalDetalle()" class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-200 text-2xl leading-none">√ó</button>
      </div>

      <!-- Tabs -->
      <div class="flex border-b border-slate-200 dark:border-white/10 mb-4">
        <button id="tabDetalle" onclick="cambiarTab('detalle')"
          class="px-4 py-2 font-medium border-b-2 border-amber-500 text-amber-600 dark:text-amber-400">
          Detalle
        </button>
        <button id="tabHistorial" onclick="cambiarTab('historial')"
          class="px-4 py-2 font-medium border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100">
          Historial
        </button>
      </div>

      <!-- Contenido: Detalle -->
      <div id="contenidoDetalle" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Tracking</label>
            <p id="modalTracking" class="text-slate-900 dark:text-slate-100 font-mono">-</p>
          </div>
          <div>
            <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Estado</label>
            <div id="modalEstado" class="mt-1">-</div>
          </div>
        </div>

        <div>
          <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Destinatario</label>
          <p id="modalDestinatario" class="text-slate-900 dark:text-slate-100">-</p>
        </div>

        <div>
          <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Direcci√≥n</label>
          <p id="modalDireccion" class="text-slate-900 dark:text-slate-100">-</p>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-slate-600 dark:text-slate-400">C√≥digo Postal</label>
            <p id="modalCP" class="text-slate-900 dark:text-slate-100">-</p>
          </div>
          <div>
            <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Partido</label>
            <p id="modalPartido" class="text-slate-900 dark:text-slate-100">-</p>
          </div>
        </div>

        <div>
          <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Tel√©fono</label>
          <div class="flex items-center gap-2">
            <p id="modalTelefono" class="text-slate-900 dark:text-slate-100">-</p>
            <a id="btnWhatsAppDetalle" href="#" target="_blank" class="hidden inline-flex items-center gap-1 px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-sm rounded-lg transition-colors">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
              </svg>
              WhatsApp
            </a>
          </div>
        </div>

        <div>
          <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Referencia</label>
          <p id="modalReferencia" class="text-slate-900 dark:text-slate-100 text-sm">-</p>
        </div>

        <div>
          <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Fecha de creaci√≥n</label>
          <p id="modalFecha" class="text-slate-900 dark:text-slate-100">-</p>
        </div>

        <div id="modalChoferContainer" class="hidden">
          <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Chofer asignado</label>
          <p id="modalChofer" class="text-slate-900 dark:text-slate-100">-</p>
        </div>
      </div>

      <!-- Contenido: Historial -->
      <div id="contenidoHistorial" class="hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-slate-50 dark:bg-white/5">
              <tr>
                <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">Fecha y hora</th>
                <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">Estado</th>
                <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">Observaciones</th>
              </tr>
            </thead>
            <tbody id="tablaHistorial" class="divide-y divide-slate-200 dark:divide-white/10">
              <!-- Din√°mico -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Footer -->
      <div class="mt-6 flex justify-end">
        <button onclick="cerrarModalDetalle()"
          class="px-4 py-2 rounded-xl bg-slate-200 dark:bg-white/10 hover:bg-slate-300 dark:hover:bg-white/20 text-slate-900 dark:text-slate-100">
          Cerrar
        </button>
      </div>

    </div>
  </div>

  <script src="/js/panel-clientes.js"></script>

  <script>
    document.getElementById('anio').textContent=new Date().getFullYear();
    // user/tema/menu
    (function(){
      const btn=document.getElementById('userBtn'),menu=document.getElementById('userMenu'),wrap=document.getElementById('userMenuWrap');
      btn.addEventListener('click',()=>menu.classList.toggle('hidden'));
      document.addEventListener('click',(e)=>{if(!wrap.contains(e.target))menu.classList.add('hidden');});
      document.getElementById('logoutBtn').addEventListener('click',async()=>{try{await fetch('/auth/logout',{method:'POST'})}catch{};localStorage.removeItem('zpl_auth');location.href='/auth/login'});
      fetch('/me',{cache:'no-store'}).then(r=>r.json()).then(me=>{document.getElementById('username').textContent=(me.name||me.username||me.email||'Usuario')}).catch(()=>location.href='/auth/login');
    })();
    (function(){
      const order=['light','dark','system']; const btn=document.getElementById('themeBtn');
      const apply=m=>{const prefers=matchMedia('(prefers-color-scheme: dark)').matches;document.documentElement.classList.toggle('dark',m==='dark'||(m==='system'&&prefers));localStorage.setItem('zpl_theme',m);btn.textContent='Tema: '+(m==='system'?'auto':m);};
      apply(localStorage.getItem('zpl_theme')||'system');
      btn.addEventListener('click',()=>{const c=localStorage.getItem('zpl_theme')||'system';apply(order[(order.indexOf(c)+1)%order.length]);});
    })();

    // Tabs
    const tabTabla = document.getElementById('tabTabla');
    const tabMapa  = document.getElementById('tabMapa');
    const vistaTabla = document.getElementById('vistaTabla');
    const vistaMapa  = document.getElementById('vistaMapa');
    function setTab(which){
      const onTabla = which==='tabla';
      tabTabla.classList.toggle('bg-[var(--z-primary)]', onTabla);
      tabTabla.classList.toggle('text-[var(--z-primary-fg)]', onTabla);
      tabMapa.classList.toggle('bg-[var(--z-primary)]', !onTabla);
      tabMapa.classList.toggle('text-[var(--z-primary-fg)]', !onTabla);
      vistaTabla.classList.toggle('hidden', !onTabla);
      vistaMapa.classList.toggle('hidden', onTabla);
      if (!onTabla) initMapOnce();
    }
    tabTabla.addEventListener('click',()=>setTab('tabla'));
    tabMapa.addEventListener('click',()=>setTab('mapa'));

    // Filtros
    const fDesde   = document.getElementById('fDesde');
    const fHasta   = document.getElementById('fHasta');
    const fEstado  = document.getElementById('fEstado');
    document.getElementById('btnFiltrar').addEventListener('click',()=>{ page=1; loadTabla(); loadMapData(); });

  // Tabla
  let page=1, limit=50;
  function escapeHtml(value){
    if (value == null) return '';
    return String(value)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function formatearFecha(valor){
    if (!valor) return '-';
    const fecha = new Date(valor);
    if (Number.isNaN(fecha.getTime())) return '-';
    return fecha.toLocaleString('es-AR');
  }

  async function loadTabla(){
    const params = new URLSearchParams({ page, limit });
    if (fEstado.value) params.set('estado', fEstado.value);
    if (fDesde.value)  params.set('desde',  fDesde.value);
    if (fHasta.value)  params.set('hasta',  fHasta.value);

    const tbody = document.getElementById('tbodyCliente');
    try {
      const r = await fetch('/api/client-panel/shipments?'+params.toString(), { cache:'no-store' });

      // Defender: si no es JSON, mostrar el HTML/404 y abortar
      const ct = r.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        const text = await r.text();
        console.error('Respuesta no JSON:', r.status, text.slice(0,200));
        tbody.innerHTML = `<tr><td class="p-2 text-red-600" colspan="5">Error ${r.status}: respuesta no JSON</td></tr>`;
        return;
      }

      const data = await r.json();
      const items = Array.isArray(data.items) ? data.items : [];
      const total = typeof data.total === 'number' ? data.total : items.length;

      if (typeof window.registrarEnvioCompleto === 'function') {
        for (const item of items) window.registrarEnvioCompleto(item);
      } else if (typeof window.registrarEnviosParciales === 'function') {
        window.registrarEnviosParciales(items);
      }

      tbody.innerHTML = items.map(it => {
        const envioId = it._id ?? it.id ?? it.envio_id ?? it.tracking ?? it.id_venta ?? '';
        const identificador = it.tracking ?? it.tracking_id ?? it.trackingId ?? it.shipment_id ?? it.id_venta ?? '-';
        const idVenta = it.id_venta ?? it.order_id ?? it.venta_id ?? null;
        const mostrarAmbos = identificador && idVenta && identificador !== idVenta;
        const identificadorHtml = mostrarAmbos
          ? `<div class="font-mono text-slate-900 dark:text-slate-100">${escapeHtml(identificador)}</div><div class="text-xs text-slate-500 dark:text-slate-400">${escapeHtml(idVenta)}</div>`
          : `<div class="font-mono text-slate-900 dark:text-slate-100">${escapeHtml(identificador || idVenta || '-')}</div>`;
        const fechaReferencia = it.fecha || it.createdAt || it.created_at || null;
        const fecha = formatearFecha(fechaReferencia);
        const partido = it.partido ?? it?.destino?.partido ?? it?.destino?.localidad ?? '-';
        const destinatario = escapeHtml(it.destinatario ?? it.nombre_destinatario ?? '-');
        const estadoActual = obtenerEstadoActual(it);
        const estadoBadge = crearBadgeEstado(estadoActual);
        const rowClick = envioId
          ? ` onclick="abrirModalDetalle(${JSON.stringify(String(envioId))})" class="cursor-pointer border-t border-slate-200 dark:border-white/10 hover:bg-slate-50 dark:hover:bg-white/5"`
          : ' class="border-t border-slate-200 dark:border-white/10"';

        return `
        <tr${rowClick}>
          <td class="p-2">${identificadorHtml}</td>
          <td class="p-2 text-slate-900 dark:text-slate-100">${fecha}</td>
          <td class="p-2 text-slate-900 dark:text-slate-100">${destinatario}</td>
          <td class="p-2 text-slate-900 dark:text-slate-100">${escapeHtml(partido || '-')}</td>
          <td class="p-2">${estadoBadge}</td>
        </tr>
        `;
      }).join('');

      if (!items.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-sm text-slate-500 dark:text-slate-400">No se encontraron env√≠os para los filtros seleccionados.</td></tr>`;
      }

      document.getElementById('pageInfo').textContent =
        `P√°gina ${page} ‚Äì ${items.length} / ${total}`;

    } catch (e) {
      console.error('Error en loadTabla:', e);
      tbody.innerHTML = `<tr><td class="p-2 text-red-600" colspan="5">${e.message}</td></tr>`;
    }
  }
  document.getElementById('prevPage').addEventListener('click',()=>{ if(page>1){ page--; loadTabla(); }});
  document.getElementById('nextPage').addEventListener('click',()=>{ page++; loadTabla(); });
  loadTabla();

 
    // Mapa (Leaflet + bounds + debounce)
    let map, markersLayer, mapInited=false, fetchTimer;
    function initMapOnce(){
      if (mapInited) return;
      mapInited = true;
      map = L.map('mapCliente').setView([-34.6,-58.4], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      const onMoveEnd = ()=>{ clearTimeout(fetchTimer); fetchTimer = setTimeout(loadMapData, 350); };
      map.on('moveend', onMoveEnd);
      loadMapData();
    }
    async function loadMapData(){
      if (!mapInited) return;
      const b = map.getBounds();
      const params = new URLSearchParams({
        swLat: b.getSouth(), swLng: b.getWest(),
        neLat: b.getNorth(), neLng: b.getEast(),
        limit: '500'
      });
      if (fEstado.value) params.set('estado', fEstado.value);

      const r = await fetch('/api/client-panel/shipments/map?'+params.toString(), { cache:'no-store' });
      if (!r.ok) return;
      const { items } = await r.json();
      markersLayer.clearLayers();
      for (const it of items) {
        const coords = it?.destino?.loc?.coordinates;
        if (!coords) continue;
        const [lng, lat] = coords;
        L.marker([lat, lng]).addTo(markersLayer)
         .bindPopup(`<b>${it.tracking||''}</b><br>${it.estado||''}<br>${it?.destino?.partido||''}`);
      }
    }
  </script>
</body>
</html>
