<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Zupply | Panel Cliente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script>window.tailwind=window.tailwind||{};window.tailwind.config={darkMode:"class"};</script>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    (function(){
      try{
        const saved=localStorage.getItem('zpl_theme');
        const prefersDark=matchMedia('(prefers-color-scheme: dark)').matches;
        const wantDark=(saved==='dark')||((!saved||saved==='system')&&prefersDark);
        document.documentElement.classList.toggle('dark',wantDark);
        if(!saved) localStorage.setItem('zpl_theme','system');
      }catch{}
    })();
  </script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>

  <style>
    :root{ --z-primary:#F59E0B; --z-primary-dark:#D97706; --z-primary-fg:#111827; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-[#0A1324] dark:text-slate-100 font-sans min-h-screen">
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <!-- TOPBAR (mismo estilo que tu esc√°ner) -->
    <header class="sticky top-0 z-40 mb-4">
      <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white/80 dark:bg-[#0B1020]/70 backdrop-blur px-4 py-3 flex items-center gap-3">
        <a href="/index.html" class="flex items-center gap-3" title="Inicio">
          <div class="h-8 w-8 grid place-items-center rounded" style="background:linear-gradient(135deg,#F6B64A,#F59E0B,#D97706)"><span class="text-white font-black">Z</span></div>
          <span class="sm:hidden font-semibold tracking-wide text-amber-500">zupply</span>
          <img src="/assets/logo-zupply.svg" class="h-5 hidden sm:block" onerror="this.remove()">
        </a>
        <div class="ml-2 h-6 w-px bg-slate-300/70 dark:bg-white/10"></div>
        <span class="text-sm opacity-80">Panel Cliente</span>

        <div class="ml-auto flex items-center gap-2">
          <div class="relative" id="userMenuWrap">
            <button id="userBtn" class="flex items-center gap-2 px-3 py-1.5 rounded-xl text-sm border border-slate-300 dark:border-white/10 bg-white hover:bg-slate-50 dark:bg-white/10 dark:hover:bg-white/15">
              <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-200/60 dark:bg-white/10">üë§</span>
              <span id="username" class="max-w-[160px] truncate">Usuario</span>
              <span class="opacity-70">‚ñæ</span>
            </button>
            <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-[#0B1020]/90 backdrop-blur p-1 shadow-lg">
              <a href="/index.html" class="block w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 dark:hover:bg-white/10 text-sm">üè† Volver al inicio</a>
              <div class="my-1 h-px bg-slate-200 dark:bg-white/10"></div>
              <button id="logoutBtn" class="w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 dark:hover:bg-white/10 text-sm">‚éã Cerrar sesi√≥n</button>
            </div>
          </div>

          <button id="themeBtn" class="px-3 py-1.5 rounded-xl text-sm border border-slate-300 dark:border-white/10 bg-white hover:bg-slate-50 text-slate-700 dark:bg-white/10 dark:hover:bg-white/15 dark:text-slate-100">Tema: auto</button>
        </div>
      </div>
    </header>

    <main class="space-y-6">
      <!-- Tabs -->
      <div class="flex gap-2">
        <button id="tabTabla" class="px-3 py-2 rounded-xl bg-[var(--z-primary)] text-[var(--z-primary-fg)] font-medium">Tabla</button>
        <button id="tabMapa"  class="px-3 py-2 rounded-xl border border-slate-300 dark:border-white/10">Mapa</button>
        <div class="ml-auto flex gap-2">
          <input id="fDesde" type="date" class="px-2 py-1 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-white/10 text-sm">
          <input id="fHasta" type="date" class="px-2 py-1 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-white/10 text-sm">
          <select id="fEstado" class="px-2 py-1 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-white/10 text-sm">
            <option value="">Todos</option>
            <option value="pendiente">Pendiente</option>
            <option value="en_camino">En camino</option>
            <option value="entregado">Entregado</option>
            <option value="incidencia">Incidencia</option>
            <option value="reprogramado">Reprogramado</option>
          </select>
          <button id="btnFiltrar" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-white/10">Filtrar</button>
        </div>
      </div>

      <!-- Tabla -->
      <section id="vistaTabla" class="rounded-2xl border border-slate-200 dark:border-white/15 bg-white dark:bg-white/5 p-3">
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-left text-slate-500">
              <tr>
                <th class="p-2">Tracking</th>
                <th class="p-2">ID de venta</th>
                <th class="p-2">Cliente</th>
                <th class="p-2">Fecha</th>
                <th class="p-2">Partido</th>
                <th class="p-2">Estado</th>
              </tr>
            </thead>
            <tbody id="tbodyCliente" class="divide-y divide-slate-100 dark:divide-white/10"></tbody>
          </table>
        </div>
        <div class="flex justify-between items-center mt-3">
          <button id="prevPage" class="px-3 py-1.5 rounded-xl border border-slate-300 dark:border-white/10">Anterior</button>
          <span id="pageInfo" class="text-xs opacity-70"></span>
          <button id="nextPage" class="px-3 py-1.5 rounded-xl border border-slate-300 dark:border-white/10">Siguiente</button>
        </div>
      </section>

      <!-- Mapa -->
      <section id="vistaMapa" class="hidden rounded-2xl border border-slate-200 dark:border-white/15 bg-white dark:bg-white/5 p-3">
        <div id="mapCliente" class="w-full h-[70vh] rounded-xl"></div>
      </section>
    </main>

    <footer class="py-6 text-center text-xs opacity-60">¬© <span id="anio"></span> Zupply</footer>
  </div>

  <script>
    document.getElementById('anio').textContent=new Date().getFullYear();
    // user/tema/menu
    (function(){
      const btn=document.getElementById('userBtn'),menu=document.getElementById('userMenu'),wrap=document.getElementById('userMenuWrap');
      btn.addEventListener('click',()=>menu.classList.toggle('hidden'));
      document.addEventListener('click',(e)=>{if(!wrap.contains(e.target))menu.classList.add('hidden');});
      document.getElementById('logoutBtn').addEventListener('click',async()=>{try{await fetch('/auth/logout',{method:'POST'})}catch{};localStorage.removeItem('zpl_auth');location.href='/auth/login'});
      fetch('/me',{cache:'no-store'}).then(r=>r.json()).then(me=>{document.getElementById('username').textContent=(me.name||me.username||me.email||'Usuario')}).catch(()=>location.href='/auth/login');
    })();
    (function(){
      const order=['light','dark','system']; const btn=document.getElementById('themeBtn');
      const apply=m=>{const prefers=matchMedia('(prefers-color-scheme: dark)').matches;document.documentElement.classList.toggle('dark',m==='dark'||(m==='system'&&prefers));localStorage.setItem('zpl_theme',m);btn.textContent='Tema: '+(m==='system'?'auto':m);};
      apply(localStorage.getItem('zpl_theme')||'system');
      btn.addEventListener('click',()=>{const c=localStorage.getItem('zpl_theme')||'system';apply(order[(order.indexOf(c)+1)%order.length]);});
    })();

    // Tabs
    const tabTabla = document.getElementById('tabTabla');
    const tabMapa  = document.getElementById('tabMapa');
    const vistaTabla = document.getElementById('vistaTabla');
    const vistaMapa  = document.getElementById('vistaMapa');
    function setTab(which){
      const onTabla = which==='tabla';
      tabTabla.classList.toggle('bg-[var(--z-primary)]', onTabla);
      tabTabla.classList.toggle('text-[var(--z-primary-fg)]', onTabla);
      tabMapa.classList.toggle('bg-[var(--z-primary)]', !onTabla);
      tabMapa.classList.toggle('text-[var(--z-primary-fg)]', !onTabla);
      vistaTabla.classList.toggle('hidden', !onTabla);
      vistaMapa.classList.toggle('hidden', onTabla);
      if (!onTabla) initMapOnce();
    }
    tabTabla.addEventListener('click',()=>setTab('tabla'));
    tabMapa.addEventListener('click',()=>setTab('mapa'));

    // Filtros
    const fDesde   = document.getElementById('fDesde');
    const fHasta   = document.getElementById('fHasta');
    const fEstado  = document.getElementById('fEstado');
    document.getElementById('btnFiltrar').addEventListener('click',()=>{ page=1; loadTabla(); loadMapData(); });

    // Tabla
    let page=1, limit=50;
    async function loadTabla(){
      const params = new URLSearchParams({ page, limit });
      if (fEstado.value) params.set('estado', fEstado.value);
      if (fDesde.value)  params.set('desde',  fDesde.value);
      if (fHasta.value)  params.set('hasta',  fHasta.value);

      const r = await fetch('/api/client-panel/shipments?'+params.toString(), { cache:'no-store' });
      if (!r.ok) return;
      const { items, total } = await r.json();
      const tb = document.getElementById('tbodyCliente');
      tb.innerHTML = items.map(it => `
        <tr>
          <td class="p-2">${it.tracking||'-'}</td>
          <td class="p-2">${it.id_venta||'-'}</td>
          <td class="p-2">${it.cliente_nombre||'-'}</td>
          <td class="p-2">${new Date(it.createdAt).toLocaleString()}</td>
          <td class="p-2">${(it.destino&&it.destino.partido)||'-'}</td>
          <td class="p-2">${it.estado||'-'}</td>
        </tr>`).join('');
      document.getElementById('pageInfo').textContent = `P√°gina ${page} ‚Äì ${items.length} / ${total}`;
    }
    document.getElementById('prevPage').addEventListener('click',()=>{ if(page>1){ page--; loadTabla(); }});
    document.getElementById('nextPage').addEventListener('click',()=>{ page++; loadTabla(); });
    loadTabla();

    // Mapa (Leaflet + bounds + debounce)
    let map, markersLayer, mapInited=false, fetchTimer;
    function initMapOnce(){
      if (mapInited) return;
      mapInited = true;
      map = L.map('mapCliente').setView([-34.6,-58.4], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      const onMoveEnd = ()=>{ clearTimeout(fetchTimer); fetchTimer = setTimeout(loadMapData, 350); };
      map.on('moveend', onMoveEnd);
      loadMapData();
    }
    async function loadMapData(){
      if (!mapInited) return;
      const b = map.getBounds();
      const params = new URLSearchParams({
        swLat: b.getSouth(), swLng: b.getWest(),
        neLat: b.getNorth(), neLng: b.getEast(),
        limit: '500'
      });
      if (fEstado.value) params.set('estado', fEstado.value);

      const r = await fetch('/api/client-panel/shipments/map?'+params.toString(), { cache:'no-store' });
      if (!r.ok) return;
      const { items } = await r.json();
      markersLayer.clearLayers();
      for (const it of items) {
        const coords = it?.destino?.loc?.coordinates;
        if (!coords) continue;
        const [lng, lat] = coords;
        L.marker([lat, lng]).addTo(markersLayer)
         .bindPopup(`<b>${it.tracking||''}</b><br>${it.estado||''}<br>${it?.destino?.partido||''}`);
      }
    }
  </script>
</body>
</html>
