<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Zupply | Panel Cliente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script>window.tailwind=window.tailwind||{};window.tailwind.config={darkMode:"class"};</script>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    (function(){
      try{
        const saved=localStorage.getItem('zpl_theme');
        const prefersDark=matchMedia('(prefers-color-scheme: dark)').matches;
        const wantDark=(saved==='dark')||((!saved||saved==='system')&&prefersDark);
        document.documentElement.classList.toggle('dark',wantDark);
        if(!saved) localStorage.setItem('zpl_theme','system');
      }catch{}
    })();
  </script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>
  <script src="/js/panel-clientes.js" defer></script>

  <style>
    :root{ --z-primary:#F59E0B; --z-primary-dark:#D97706; --z-primary-fg:#111827; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-[#0A1324] dark:text-slate-100 font-sans min-h-screen">
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <!-- TOPBAR (mismo estilo que tu esc√°ner) -->
    <header class="sticky top-0 z-40 mb-4">
      <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white/80 dark:bg-[#0B1020]/70 backdrop-blur px-4 py-3 flex items-center gap-3">
        <a href="/index.html" class="flex items-center gap-3" title="Inicio">
          <div class="h-8 w-8 grid place-items-center rounded" style="background:linear-gradient(135deg,#F6B64A,#F59E0B,#D97706)"><span class="text-white font-black">Z</span></div>
          <span class="sm:hidden font-semibold tracking-wide text-amber-500">zupply</span>
          <img src="/assets/logo-zupply.svg" class="h-5 hidden sm:block" onerror="this.remove()">
        </a>
        <div class="ml-2 h-6 w-px bg-slate-300/70 dark:bg-white/10"></div>
        <span class="text-sm opacity-80">Panel Cliente</span>

        <div class="ml-auto flex items-center gap-2">
          <a href="ingreso-manual.html"
            class="px-4 py-2 text-slate-900 dark:text-slate-100 hover:bg-slate-100 dark:hover:bg-white/10 rounded-lg">
            Crear env√≠o
          </a>
          <div class="relative" id="userMenuWrap">
            <button id="userBtn" class="flex items-center gap-2 px-3 py-1.5 rounded-xl text-sm border border-slate-300 dark:border-white/10 bg-white hover:bg-slate-50 dark:bg-white/10 dark:hover:bg-white/15">
              <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-200/60 dark:bg-white/10">üë§</span>
              <span id="username" class="max-w-[160px] truncate">Usuario</span>
              <span class="opacity-70">‚ñæ</span>
            </button>
            <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-[#0B1020]/90 backdrop-blur p-1 shadow-lg">
              <a href="/index.html" class="block w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 dark:hover:bg-white/10 text-sm">üè† Volver al inicio</a>
              <div class="my-1 h-px bg-slate-200 dark:bg-white/10"></div>
              <button id="logoutBtn" class="w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 dark:hover:bg-white/10 text-sm">‚éã Cerrar sesi√≥n</button>
            </div>
          </div>

          <button id="themeBtn" class="px-3 py-1.5 rounded-xl text-sm border border-slate-300 dark:border-white/10 bg-white hover:bg-slate-50 text-slate-700 dark:bg-white/10 dark:hover:bg-white/15 dark:text-slate-100">Tema: auto</button>
        </div>
      </div>
    </header>

    <main class="space-y-6">
      <!-- Tabs -->
      <div class="flex gap-2">
        <button id="tabTabla" class="px-3 py-2 rounded-xl bg-[var(--z-primary)] text-[var(--z-primary-fg)] font-medium">Tabla</button>
        <button id="tabMapa"  class="px-3 py-2 rounded-xl border border-slate-300 dark:border-white/10">Mapa</button>
        <div class="ml-auto flex gap-2">
          <input id="fDesde" type="date" class="px-2 py-1 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-white/10 text-sm">
          <input id="fHasta" type="date" class="px-2 py-1 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-white/10 text-sm">
          <select id="fEstado" class="px-2 py-1 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-white/10 text-sm">
            <option value="">Todos</option>
            <option value="pendiente">Pendiente</option>
            <option value="en_camino">En camino</option>
            <option value="entregado">Entregado</option>
            <option value="incidencia">Incidencia</option>
            <option value="reprogramado">Reprogramado</option>
          </select>
          <button id="btnFiltrar" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-white/10">Filtrar</button>
        </div>
      </div>

      <!-- Tabla -->
      <section id="vistaTabla" class="rounded-2xl border border-slate-200 dark:border-white/15 bg-white dark:bg-white/5 p-3">
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-left text-slate-500">
              <tr>
                <th class="p-2">Tracking</th>
                <th class="p-2">ID de venta</th>
                <th class="p-2">Fecha</th>
                <th class="p-2">Partido</th>
                <th class="p-2">Estado</th>
              </tr>
            </thead>
            <tbody id="tbodyCliente" class="divide-y divide-slate-100 dark:divide-white/10"></tbody>
          </table>
        </div>
        <div class="flex justify-between items-center mt-3">
          <button id="prevPage" class="px-3 py-1.5 rounded-xl border border-slate-300 dark:border-white/10">Anterior</button>
          <span id="pageInfo" class="text-xs opacity-70"></span>
          <button id="nextPage" class="px-3 py-1.5 rounded-xl border border-slate-300 dark:border-white/10">Siguiente</button>
        </div>
      </section>

      <!-- Mapa -->
      <section id="vistaMapa" class="hidden rounded-2xl border border-slate-200 dark:border-white/15 bg-white dark:bg-white/5 p-3">
        <div id="mapCliente" class="w-full h-[70vh] rounded-xl"></div>
      </section>
    </main>

    <footer class="py-6 text-center text-xs opacity-60">¬© <span id="anio"></span> Zupply</footer>
  </div>

  <script>
    document.getElementById('anio').textContent=new Date().getFullYear();
    // user/tema/menu
    (function(){
      const btn=document.getElementById('userBtn'),menu=document.getElementById('userMenu'),wrap=document.getElementById('userMenuWrap');
      btn.addEventListener('click',()=>menu.classList.toggle('hidden'));
      document.addEventListener('click',(e)=>{if(!wrap.contains(e.target))menu.classList.add('hidden');});
      document.getElementById('logoutBtn').addEventListener('click',async()=>{try{await fetch('/auth/logout',{method:'POST'})}catch{};localStorage.removeItem('zpl_auth');location.href='/auth/login'});
      fetch('/me',{cache:'no-store'}).then(r=>r.json()).then(me=>{document.getElementById('username').textContent=(me.name||me.username||me.email||'Usuario')}).catch(()=>location.href='/auth/login');
    })();
    (function(){
      const order=['light','dark','system']; const btn=document.getElementById('themeBtn');
      const apply=m=>{const prefers=matchMedia('(prefers-color-scheme: dark)').matches;document.documentElement.classList.toggle('dark',m==='dark'||(m==='system'&&prefers));localStorage.setItem('zpl_theme',m);btn.textContent='Tema: '+(m==='system'?'auto':m);};
      apply(localStorage.getItem('zpl_theme')||'system');
      btn.addEventListener('click',()=>{const c=localStorage.getItem('zpl_theme')||'system';apply(order[(order.indexOf(c)+1)%order.length]);});
    })();

    // Tabs
    const tabTabla = document.getElementById('tabTabla');
    const tabMapa  = document.getElementById('tabMapa');
    const vistaTabla = document.getElementById('vistaTabla');
    const vistaMapa  = document.getElementById('vistaMapa');
    function setTab(which){
      const onTabla = which==='tabla';
      tabTabla.classList.toggle('bg-[var(--z-primary)]', onTabla);
      tabTabla.classList.toggle('text-[var(--z-primary-fg)]', onTabla);
      tabMapa.classList.toggle('bg-[var(--z-primary)]', !onTabla);
      tabMapa.classList.toggle('text-[var(--z-primary-fg)]', !onTabla);
      vistaTabla.classList.toggle('hidden', !onTabla);
      vistaMapa.classList.toggle('hidden', onTabla);
      if (!onTabla) initMapOnce();
    }
    tabTabla.addEventListener('click',()=>setTab('tabla'));
    tabMapa.addEventListener('click',()=>setTab('mapa'));

    // Filtros
    const fDesde   = document.getElementById('fDesde');
    const fHasta   = document.getElementById('fHasta');
    const fEstado  = document.getElementById('fEstado');
    document.getElementById('btnFiltrar').addEventListener('click',()=>{ page=1; loadTabla(); loadMapData(); });

  // Tabla
  let page=1, limit=50;
  async function loadTabla(){
    const params = new URLSearchParams({ page, limit });
    if (fEstado.value) params.set('estado', fEstado.value);
    if (fDesde.value)  params.set('desde',  fDesde.value);
    if (fHasta.value)  params.set('hasta',  fHasta.value);

    const tbody = document.getElementById('tbodyCliente');
    try {
      const r = await fetch('/api/client-panel/shipments?'+params.toString(), { cache:'no-store' });

      // Defender: si no es JSON, mostrar el HTML/404 y abortar
      const ct = r.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        const text = await r.text();
        console.error('Respuesta no JSON:', r.status, text.slice(0,200));
        tbody.innerHTML = `<tr><td class="p-2 text-red-600" colspan="5">Error ${r.status}: respuesta no JSON</td></tr>`;
        return;
      }

      const data = await r.json();
      const items = Array.isArray(data.items) ? data.items : [];
      const total = typeof data.total === 'number' ? data.total : items.length;

      const esc = (value) => {
        return String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      };

      tbody.innerHTML = items.map(it => {
        const trackingRaw = it.tracking ?? it.id_venta ?? '-';
        const trackingSafe = esc(trackingRaw || '-');
        const envioId = it._id || it.id || it.envio_id || it.envioId || '';
        const envioIdAttr = esc(envioId);
        const fecha = it.createdAt || it.fecha || it.created_at;
        const fechaTexto = (() => {
          if (!fecha) return '-';
          const parsed = new Date(fecha);
          return Number.isNaN(parsed.getTime()) ? '-' : esc(parsed.toLocaleString());
        })();
        const partido = it?.destino?.partido ?? it.partido ?? '-';
        const estadoBadge = typeof window.obtenerBadgeEstado === 'function'
          ? window.obtenerBadgeEstado(it.estado ?? it?.estado_ui?.text)
          : `<span class="${it?.estado_ui?.class || ''}">${esc(it?.estado_ui?.text || it.estado || '-')}</span>`;

        const trackingContent = envioId
          ? `<button onclick="abrirModalDetalleCliente('${envioIdAttr}')" class="text-blue-600 hover:text-blue-700 dark:text-blue-400 hover:underline font-mono">${trackingSafe}</button>`
          : `<span class="font-mono">${trackingSafe}</span>`;

        return `
        <tr class="border-t border-slate-200 dark:border-white/10 hover:bg-slate-50 dark:hover:bg-white/5">
          <td class="p-2">${trackingContent}</td>
          <td class="p-2">${esc(it.id_venta ?? '-')}</td>
          <td class="p-2">${fechaTexto}</td>
          <td class="p-2">${esc(partido ?? '-')}</td>
          <td class="p-2">${estadoBadge}</td>
        </tr>
      `;
      }).join('');

      document.getElementById('pageInfo').textContent =
        `P√°gina ${page} ‚Äì ${items.length} / ${total}`;

    } catch (e) {
      console.error('Error en loadTabla:', e);
      tbody.innerHTML = `<tr><td class="p-2 text-red-600" colspan="5">${e.message}</td></tr>`;
    }
  }
  document.getElementById('prevPage').addEventListener('click',()=>{ if(page>1){ page--; loadTabla(); }});
  document.getElementById('nextPage').addEventListener('click',()=>{ page++; loadTabla(); });
  window.addEventListener('DOMContentLoaded', () => {
    loadTabla();
  });

 
    // Mapa (Leaflet + bounds + debounce)
    let map, markersLayer, mapInited=false, fetchTimer;
    function initMapOnce(){
      if (mapInited) return;
      mapInited = true;
      map = L.map('mapCliente').setView([-34.6,-58.4], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      const onMoveEnd = ()=>{ clearTimeout(fetchTimer); fetchTimer = setTimeout(loadMapData, 350); };
      map.on('moveend', onMoveEnd);
      loadMapData();
    }
    async function loadMapData(){
      if (!mapInited) return;
      const b = map.getBounds();
      const params = new URLSearchParams({
        swLat: b.getSouth(), swLng: b.getWest(),
        neLat: b.getNorth(), neLng: b.getEast(),
        limit: '500'
      });
      if (fEstado.value) params.set('estado', fEstado.value);

      const r = await fetch('/api/client-panel/shipments/map?'+params.toString(), { cache:'no-store' });
      if (!r.ok) return;
      const { items } = await r.json();
      markersLayer.clearLayers();
      for (const it of items) {
        const coords = it?.destino?.loc?.coordinates;
        if (!coords) continue;
        const [lng, lat] = coords;
        L.marker([lat, lng]).addTo(markersLayer)
         .bindPopup(`<b>${it.tracking||''}</b><br>${it.estado||''}<br>${it?.destino?.partido||''}`);
      }
    }
  </script>

<!-- Modal de detalle de env√≠o (SOLO para panel-clientes.html) -->
<div id="modalDetalleCliente" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white dark:bg-[#0B1020] rounded-2xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto p-6 border border-slate-200 dark:border-white/10">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-100">Detalle del env√≠o</h2>
      <button onclick="cerrarModalDetalleCliente()" class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-200 text-2xl">√ó</button>
    </div>

    <div class="flex border-b border-slate-200 dark:border-white/10 mb-4">
      <button id="tabDetalleCliente" onclick="cambiarTabCliente('detalle')"
        class="px-4 py-2 font-medium border-b-2 border-amber-500 text-amber-600 dark:text-amber-400">
        Detalle del env√≠o
      </button>
      <button id="tabHistorialCliente" onclick="cambiarTabCliente('historial')"
        class="px-4 py-2 font-medium border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100">
        Historial
      </button>
    </div>

    <div id="contenidoDetalleCliente" class="space-y-4">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Tracking</label>
          <p id="detTrackingCliente" class="text-slate-900 dark:text-slate-100 font-mono">-</p>
        </div>
        <div>
          <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Estado</label>
          <div id="detEstadoCliente" class="mt-1">-</div>
        </div>
      </div>

      <div>
        <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Destinatario</label>
        <p id="detDestinatarioCliente" class="text-slate-900 dark:text-slate-100">-</p>
      </div>

      <div>
        <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Direcci√≥n</label>
        <p id="detDireccionCliente" class="text-slate-900 dark:text-slate-100">-</p>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-medium text-slate-600 dark:text-slate-400">C√≥digo Postal</label>
          <p id="detCPCliente" class="text-slate-900 dark:text-slate-100">-</p>
        </div>
        <div>
          <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Partido</label>
          <p id="detPartidoCliente" class="text-slate-900 dark:text-slate-100">-</p>
        </div>
      </div>

      <div>
        <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Tel√©fono</label>
        <p id="detTelefonoCliente" class="text-slate-900 dark:text-slate-100">-</p>
      </div>

      <div>
        <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Referencia</label>
        <p id="detReferenciaCliente" class="text-slate-900 dark:text-slate-100 text-sm">-</p>
      </div>

      <div>
        <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Fecha de creaci√≥n</label>
        <p id="detFechaCliente" class="text-slate-900 dark:text-slate-100">-</p>
      </div>

      <div id="detChoferContainerCliente" class="hidden">
        <label class="text-sm font-medium text-slate-600 dark:text-slate-400">Chofer asignado</label>
        <p id="detChoferCliente" class="text-slate-900 dark:text-slate-100">-</p>
      </div>
    </div>

    <div id="contenidoHistorialCliente" class="hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-slate-50 dark:bg-white/5">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">Fecha y hora</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">Estado</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-700 dark:text-slate-300">Observaciones</th>
            </tr>
          </thead>
          <tbody id="tablaHistorialCliente" class="divide-y divide-slate-200 dark:divide-white/10"></tbody>
        </table>
      </div>
    </div>

    <div class="mt-6 flex justify-end">
      <button onclick="cerrarModalDetalleCliente()"
        class="px-4 py-2 rounded-xl bg-slate-200 dark:bg-white/10 hover:bg-slate-300 dark:hover:bg-white/20 text-slate-900 dark:text-slate-100">
        Cerrar
      </button>
    </div>
  </div>
</div>
</body>
</html>
